#!/bin/bash
# ==========================================================================
#  vps-dns-dnssec.sh – Автоматизирано активиране на DNSSEC за Bind9
# --------------------------------------------------------------------------
#  Версия: 1.0
#  Дата: 2025-07-22
#  Автор: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  Цел:
#    - Активиране на DNSSEC върху вече конфигуриран DNS сървър.
#    - Подписване на зоните, генериране на KSK и ZSK ключове.
#
#  Зависимости:
#    - Скриптовете vps-dns-qsetup.sh и vps-dns-secure.sh трябва да са завършени.
#    - Работещ Bind9, конфигуриран с TSIG и ACL.
#
# ==========================================================================

# === ПОМОЩНА ИНФОРМАЦИЯ ===================================================
show_help() {
  echo ""
  echo "Използване: vps-dns-dnssec.sh [опция]"
  echo ""
  echo "Автоматизирана активация и конфигурация на DNSSEC за Bind9."
  echo ""
  echo "Опции:"
  echo "  --version       Показва версията на скрипта"
  echo "  --help          Показва тази помощ"
  echo ""
  echo "Забележка: Скриптът изисква преди това да е изпълнен успешно:"
  echo "  1. vps-dns-qsetup.sh"
  echo "  2. vps-dns-secure.sh"
  echo ""
}

# === ОБРАБОТКА НА ОПЦИИ ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-dns-dnssec.sh версия 1.0 (22 юли 2025 г.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "❌ Неразпозната опция: $1"
      show_help
      exit 1
      ;;
  esac
fi

# =====================================================================
# vps-dns-dnssec.sh – Скрипт за активация и управление на DNSSEC (Bind9)
# Част от NetGalaxySoft DevOps Tools
# =====================================================================

NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

echo ""
echo -e "\e[32m=========================================="
echo -e "       АКТИВИРАНЕ НА DNSSEC (BIND9)"
echo -e "==========================================\e[0m"
echo ""

# =====================================================================
# [МОДУЛ 1] ПРЕДВАРИТЕЛНИ ПРОВЕРКИ
# =====================================================================
echo "[1] ПРЕДВАРИТЕЛНИ ПРОВЕРКИ..."
echo "-----------------------------------------------------------"
echo ""

# Проверка дали базовата конфигурация е завършена
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! sudo grep -q '^SETUP_VPS_DNS_STATUS=✅' "$SETUP_ENV_FILE"; then
  echo "🛑 Липсва базова DNS конфигурация."
  echo "➡ Стартирайте първо скрипта vps-dns-qsetup.sh и опитайте отново."
  exit 1
fi

# Проверка дали сигурността вече е активирана
if ! sudo grep -q '^SETUP_SECURE_DNS_STATUS=✅' "$SETUP_ENV_FILE"; then
  echo "🛑 Липсва подсигуряване на DNS (Bind9)."
  echo "➡ Стартирайте първо скрипта vps-dns-secure.sh и опитайте отново."
  exit 1
fi

# Проверка дали DNSSEC вече е конфигуриран
if sudo grep -q '^SETUP_DNSSEC_STATUS=✅' "$SETUP_ENV_FILE"; then
  echo "ℹ️ DNSSEC вече е конфигуриран. Скриптът ще се прекрати."
  exit 0
fi

# Проверка на ОС
echo "🔍 Проверка на операционната система..."
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  OS_NAME=$ID
  OS_VERSION=$VERSION_ID
else
  echo "❌ Неуспешно откриване на ОС. Скриптът изисква Ubuntu или Debian."
  exit 1
fi

SUPPORTED=false
if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
  SUPPORTED=true
elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
  SUPPORTED=true
fi

if [[ "$SUPPORTED" == false ]]; then
  echo "❌ Операционната система $PRETTY_NAME не се поддържа."
  exit 1
fi

echo "✅ Засечена поддържана ОС: $PRETTY_NAME"
echo ""

# Проверка за нужните инструменти
echo "🔍 Проверка за налични инструменти (bind9, dnssec-keygen)..."
if ! command -v dnssec-keygen >/dev/null || ! command -v named-checkconf >/dev/null; then
  echo "❌ Липсват нужни пакети! Инсталирайте bind9-utils и опитайте отново."
  exit 1
fi
echo "✅ Всички нужни пакети са налични."
echo ""

# ✅ Запис в setup.env, че модулът е успешен
if sudo grep -q '^DNSSEC_MODULE1=' "$SETUP_ENV_FILE"; then
  sudo sed -i 's|^DNSSEC_MODULE1=.*|DNSSEC_MODULE1=✅|' "$SETUP_ENV_FILE"
else
  echo "DNSSEC_MODULE1=✅" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
fi

echo "✅ Модул 1 завърши успешно."
echo ""
echo ""


# =====================================================================
# [МОДУЛ 2] ГЕНЕРИРАНЕ НА DNSSEC КЛЮЧОВЕ
# =====================================================================
echo "[2] ГЕНЕРИРАНЕ НА DNSSEC КЛЮЧОВЕ..."
echo "-----------------------------------------------------------"
echo ""

if sudo grep -q '^DNSSEC_MODULE2=✅' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "ℹ️ Модул 2 вече е изпълнен успешно. Пропускане..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 1: Подготовка на директория за ключове
  # -------------------------------------------------------------------------------------
  DNSSEC_DIR="/etc/bind/keys/dnssec"
  if [[ ! -d "$DNSSEC_DIR" ]]; then
    sudo mkdir -p "$DNSSEC_DIR"
    sudo chown bind:bind "$DNSSEC_DIR"
    sudo chmod 750 "$DNSSEC_DIR"
    echo "✅ Директорията за DNSSEC ключове е създадена: $DNSSEC_DIR"
  fi

  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 2: Извличане на домейна от named.conf.local
  # -------------------------------------------------------------------------------------
  ZONE_FILE=$(grep -E 'file\s+"' /etc/bind/named.conf.local | awk -F'"' '{print $2}')
  DOMAIN=$(grep -E 'zone\s+"' /etc/bind/named.conf.local | awk -F'"' '{print $2}')

  if [[ -z "$ZONE_FILE" || -z "$DOMAIN" ]]; then
    echo "❌ Неуспешно извличане на домейна или зоната."
    exit 1
  fi

  echo "✅ Засечена зона: $DOMAIN (файл: $ZONE_FILE)"
  echo ""

  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 3: Генериране на KSK и ZSK
  # -------------------------------------------------------------------------------------
  echo "🔐 Генериране на KSK и ZSK..."
  cd "$DNSSEC_DIR" || exit 1

  KSK_KEY=$(sudo dnssec-keygen -a ECDSAP256SHA256 -f KSK -b 2048 "$DOMAIN")
  ZSK_KEY=$(sudo dnssec-keygen -a ECDSAP256SHA256 -b 2048 "$DOMAIN")

  echo "✅ Генерирани ключове:"
  echo "KSK: $KSK_KEY"
  echo "ZSK: $ZSK_KEY"
  echo ""

  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 4: Подписване на зоната
  # -------------------------------------------------------------------------------------
  echo "🔍 Подписване на зоната..."
  cd /etc/bind || exit 1
  sudo dnssec-signzone -A -3 $(head -c 1000 /dev/urandom | sha1sum | cut -b 1-16) \
    -N increment -o "$DOMAIN" -t "$ZONE_FILE"
  echo "✅ Зоната е подписана с DNSSEC."
  echo ""

  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 5: Обновяване на named.conf.local
  # -------------------------------------------------------------------------------------
  if ! grep -q "auto-dnssec maintain" /etc/bind/named.conf.local; then
    sudo sed -i "/zone \"$DOMAIN\" {/a \ \ \ \ auto-dnssec maintain;\n\tinline-signing yes;" /etc/bind/named.conf.local
    echo "✅ Включени опции auto-dnssec maintain и inline-signing."
  fi

  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 6: Проверка и рестарт
  # -------------------------------------------------------------------------------------
  echo "🔍 Проверка на конфигурацията..."
  if ! sudo named-checkconf; then
    echo "❌ Грешка в конфигурацията!"
    exit 1
  fi

  echo "🔄 Рестартиране на Bind9..."
  if sudo systemctl restart bind9; then
    echo "✅ Bind9 е рестартиран успешно."
  else
    echo "❌ Bind9 не успя да стартира!"
    exit 1
  fi
  echo ""

  # -------------------------------------------------------------------------------------
  # СЕКЦИЯ 7: Запис на резултата
  # -------------------------------------------------------------------------------------
  if sudo grep -q '^DNSSEC_MODULE2=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^DNSSEC_MODULE2=.*|DNSSEC_MODULE2=✅|' "$SETUP_ENV_FILE"
  else
    echo "DNSSEC_MODULE2=✅" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "✅ Модул 2 завърши успешно."
fi
echo ""
echo ""



exit 0


# =====================================================================
# [МОДУЛ 3] КОНФИГУРАЦИЯ НА named.conf.local
# =====================================================================
echo "[3] АКТИВИРАНЕ НА DNSSEC ПОЛИТИКИ..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - Добавяне на auto-dnssec maintain и inline-signing yes.
# - Проверка за съществуване на директивите (избягване на дублиране).
echo ""
echo ""

# =====================================================================
# [МОДУЛ 4] ВКЛЮЧВАНЕ НА КЛЮЧОВЕТЕ В ЗОНАТА
# =====================================================================
echo "[4] ВКЛЮЧВАНЕ НА КЛЮЧОВЕТЕ..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - Вмъкване на KSK и ZSK файлове в конфигурацията на зоната.
# - Проверка за коректно форматиране.
echo ""
echo ""

# =====================================================================
# [МОДУЛ 5] ИНИЦИАЛИЗАЦИЯ НА ПОДПИСВАНЕТО
# =====================================================================
echo "[5] ПОДПИСВАНЕ НА ЗОНАТА..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - rndc loadkeys $DOMAIN
# - rndc signing -list $DOMAIN
# - Проверка за .signed файл в /var/cache/bind
echo ""
echo ""

# =====================================================================
# [МОДУЛ 6] ВАЛИДАЦИЯ НА DNSSEC
# =====================================================================
echo "[6] ВАЛИДАЦИЯ..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - named-checkzone $DOMAIN /var/cache/bind/$DOMAIN.db.signed
# - dig +dnssec $DOMAIN @127.0.0.1
echo ""
echo ""

# =====================================================================
# [МОДУЛ 7] ФИНАЛЕН ОТЧЕТ
# =====================================================================
echo "[7] ФИНАЛЕН ОТЧЕТ..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - Показване на статуса на всички модули.
# - Запис SETUP_DNSSEC_STATUS=✅ в setup.env.
# - Изтриване на временно todo.modules (ако съществува).
# - (По избор) Изтриване на скрипта.
echo ""
echo ""

# Край на шаблона
