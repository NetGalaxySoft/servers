#!/bin/bash
# ==========================================================================
#  vps-dns-dnssec.sh ‚Äì –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ DNSSEC –∑–∞ Bind9
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-22
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¶–µ–ª:
#    - –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ DNSSEC –≤—ä—Ä—Ö—É –≤–µ—á–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω DNS —Å—ä—Ä–≤—ä—Ä.
#    - –ü–æ–¥–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –∑–æ–Ω–∏—Ç–µ, –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ KSK –∏ ZSK –∫–ª—é—á–æ–≤–µ.
#
#  –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
#    - –°–∫—Ä–∏–ø—Ç–æ–≤–µ—Ç–µ vps-dns-qsetup.sh –∏ vps-dns-secure.sh —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∏.
#    - –†–∞–±–æ—Ç–µ—â Bind9, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω —Å TSIG –∏ ACL.
#
# ==========================================================================

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo ""
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-dns-dnssec.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ DNSSEC –∑–∞ Bind9."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
  echo ""
  echo "–ó–∞–±–µ–ª–µ–∂–∫–∞: –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ –ø—Ä–µ–¥–∏ —Ç–æ–≤–∞ –¥–∞ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ:"
  echo "  1. vps-dns-qsetup.sh"
  echo "  2. vps-dns-secure.sh"
  echo ""
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-dns-dnssec.sh –≤–µ—Ä—Å–∏—è 1.0 (22 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

# =====================================================================
# vps-dns-dnssec.sh ‚Äì –°–∫—Ä–∏–ø—Ç –∑–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ DNSSEC (Bind9)
# –ß–∞—Å—Ç –æ—Ç NetGalaxySoft DevOps Tools
# =====================================================================

NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

echo ""
echo -e "\e[32m=========================================="
echo -e "       –ê–ö–¢–ò–í–ò–†–ê–ù–ï –ù–ê DNSSEC (BIND9)"
echo -e "==========================================\e[0m"
echo ""


# =====================================================================
# [–ú–û–î–£–õ 1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò
# =====================================================================
echo "[1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò..."
echo "-----------------------------------------------------------"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –±–∞–∑–æ–≤–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! sudo grep -q '^SETUP_VPS_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE"; then
  echo "üõë –õ–∏–ø—Å–≤–∞ –±–∞–∑–æ–≤–∞ DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è."
  echo "‚û° –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ø—ä—Ä–≤–æ —Å–∫—Ä–∏–ø—Ç–∞ vps-dns-qsetup.sh –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –≤–µ—á–µ –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–∞
if ! sudo grep -q '^SETUP_SECURE_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE"; then
  echo "üõë –õ–∏–ø—Å–≤–∞ –ø–æ–¥—Å–∏–≥—É—Ä—è–≤–∞–Ω–µ –Ω–∞ DNS (Bind9)."
  echo "‚û° –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ø—ä—Ä–≤–æ —Å–∫—Ä–∏–ø—Ç–∞ vps-dns-secure.sh –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ DNSSEC –≤–µ—á–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω
if sudo grep -q '^SETUP_DNSSEC_STATUS=‚úÖ' "$SETUP_ENV_FILE"; then
  echo "‚ÑπÔ∏è DNSSEC –≤–µ—á–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω. –°–∫—Ä–∏–ø—Ç—ä—Ç —â–µ —Å–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏."
  exit 0
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –û–°
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞..."
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  OS_NAME=$ID
  OS_VERSION=$VERSION_ID
else
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –û–°. –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ Ubuntu –∏–ª–∏ Debian."
  exit 1
fi

SUPPORTED=false
if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
  SUPPORTED=true
elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
  SUPPORTED=true
fi

if [[ "$SUPPORTED" == false ]]; then
  echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ $PRETTY_NAME –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞."
  exit 1
fi

echo "‚úÖ –ó–∞—Å–µ—á–µ–Ω–∞ –ø–æ–¥–¥—ä—Ä–∂–∞–Ω–∞ –û–°: $PRETTY_NAME"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω—É–∂–Ω–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ (bind9, dnssec-keygen)..."
if ! command -v dnssec-keygen >/dev/null || ! command -v named-checkconf >/dev/null; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞—Ç –Ω—É–∂–Ω–∏ –ø–∞–∫–µ—Ç–∏! –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ bind9-utils –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  exit 1
fi
echo "‚úÖ –í—Å–∏—á–∫–∏ –Ω—É–∂–Ω–∏ –ø–∞–∫–µ—Ç–∏ —Å–∞ –Ω–∞–ª–∏—á–Ω–∏."
echo ""

# ‚úÖ –ó–∞–ø–∏—Å –≤ setup.env, —á–µ –º–æ–¥—É–ª—ä—Ç –µ —É—Å–ø–µ—à–µ–Ω
if sudo grep -q '^DNSSEC_MODULE1=' "$SETUP_ENV_FILE"; then
  sudo sed -i 's|^DNSSEC_MODULE1=.*|DNSSEC_MODULE1=‚úÖ|' "$SETUP_ENV_FILE"
else
  echo "DNSSEC_MODULE1=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
fi

echo "‚úÖ –ú–æ–¥—É–ª 1 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 2] –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê DNSSEC –ö–õ–Æ–ß–û–í–ï
# =====================================================================
echo "[2] –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê DNSSEC –ö–õ–Æ–ß–û–í–ï..."
echo "-----------------------------------------------------------"
echo ""

if sudo grep -q '^DNSSEC_MODULE2=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 2 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª—é—á–æ–≤–µ
  # -------------------------------------------------------------------------------------
  DNSSEC_DIR="/etc/bind/keys/dnssec"
  echo "üîß –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ DNSSEC –∫–ª—é—á–æ–≤–µ..."
  if [[ ! -d "$DNSSEC_DIR" ]]; then
    sudo mkdir -p "$DNSSEC_DIR"
    sudo chown bind:bind "$DNSSEC_DIR"
    sudo chmod 750 "$DNSSEC_DIR"
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞ –∑–∞ DNSSEC –∫–ª—é—á–æ–≤–µ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞: $DNSSEC_DIR"
  else
    echo "‚ÑπÔ∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞ $DNSSEC_DIR –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
  fi
  echo ""

  # -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 2: –ó–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –∑–æ–Ω–∞—Ç–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–≤–∞–Ω–µ
# -------------------------------------------------------------------------------------
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–∏—Ç–µ –∑–æ–Ω–∏..."
ZONES=$(sudo grep 'zone "' /etc/bind/named.conf.local | awk -F'"' '{print $2}')

if [[ -z "$ZONES" ]]; then
  echo "‚ùå –ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ –∑–æ–Ω–∏ –≤ named.conf.local!"
  exit 1
fi

echo "‚úÖ –ó–∞—Å–µ—á–µ–Ω–∏ –∑–æ–Ω–∏:"
echo "$ZONES"
echo ""

# –ò–∑–±–æ—Ä –Ω–∞ –ø—ä—Ä–≤–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞ –∑–æ–Ω–∞ (–±–µ–∑ reverse)
DOMAIN=$(echo "$ZONES" | grep -v 'in-addr.arpa' | head -n 1)

if [[ -z "$DOMAIN" ]]; then
  echo "‚ùå –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â–∞ –∑–æ–Ω–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–≤–∞–Ω–µ!"
  exit 1
fi

echo "‚úÖ –ò–∑–±—Ä–∞–Ω–∞ –∑–æ–Ω–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–≤–∞–Ω–µ: $DOMAIN"
echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ó–∞–ø–∏—Å –≤ todo.modules
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$MODULES_FILE" ]]; then
    sudo touch "$MODULES_FILE"
  fi

  for VAR in DNSSEC_DOMAIN DNSSEC_KEYS_DIR; do
    case $VAR in
      DNSSEC_DOMAIN) VALUE="$DOMAIN" ;;
      DNSSEC_KEYS_DIR) VALUE="$DNSSEC_DIR" ;;
    esac
    if sudo grep -q "^$VAR=" "$MODULES_FILE" 2>/dev/null; then
      sudo sed -i "s|^$VAR=.*|$VAR=\"$VALUE\"|" "$MODULES_FILE"
    else
      echo "$VAR=\"$VALUE\"" | sudo tee -a "$MODULES_FILE" > /dev/null
    fi
  done

  echo "‚úÖ –î–æ–±–∞–≤–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –≤ $MODULES_FILE:"
  echo "DNSSEC_DOMAIN=\"$DOMAIN\""
  echo "DNSSEC_KEYS_DIR=\"$DNSSEC_DIR\""
  echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 4: –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ DNSSEC –∫–ª—é—á–æ–≤–µ (KSK –∏ ZSK)
# -------------------------------------------------------------------------------------
echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ KSK –∏ ZSK –∑–∞ $DOMAIN..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ—Å—Ç –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞
if ! sudo test -d "$DNSSEC_DIR"; then
  echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞ $DNSSEC_DIR –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –∏–ª–∏ –Ω—è–º–∞ –¥–æ—Å—Ç—ä–ø!"
  exit 1
fi

# –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ KSK (Key Signing Key)
if sudo dnssec-keygen -a RSASHA256 -b 2048 -f KSK -n ZONE -K "$DNSSEC_DIR" "$DOMAIN"; then
  echo "‚úÖ KSK –∑–∞ $DOMAIN –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
else
  echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ KSK –∑–∞ $DOMAIN!"
  exit 1
fi

# –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ ZSK (Zone Signing Key)
if sudo dnssec-keygen -a RSASHA256 -b 1024 -n ZONE -K "$DNSSEC_DIR" "$DOMAIN"; then
  echo "‚úÖ ZSK –∑–∞ $DOMAIN –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
else
  echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ ZSK –∑–∞ $DOMAIN!"
  exit 1
fi

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞
  # -------------------------------------------------------------------------------------
  if sudo grep -q '^DNSSEC_MODULE2=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^DNSSEC_MODULE2=.*|DNSSEC_MODULE2=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "DNSSEC_MODULE2=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "‚úÖ –ö–ª—é—á–æ–≤–µ—Ç–µ –∑–∞ $DOMAIN —Å–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —É—Å–ø–µ—à–Ω–æ."
  echo "‚úÖ –ú–æ–¥—É–ª 2 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 3] ACL –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û IP
# =====================================================================
echo "[3] ACL –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û IP..."
echo "-----------------------------------------------------------"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if sudo grep -q '^SECURE_DNS_MODULE3=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 3 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏
  # -------------------------------------------------------------------------------------
  echo "‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ—Ç–æ –Ω–∞ $MODULES_FILE..."
  if [[ ! -f "$MODULES_FILE" ]]; then
    sudo touch "$MODULES_FILE"
  fi

  # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ SERVER_IP
  SERVER_IP=$(hostname -I | awk '{print $1}')
  [[ -z "$SERVER_IP" ]] && { echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ IP –∞–¥—Ä–µ—Å."; exit 1; }

  # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ SERVER_FQDN
  SERVER_FQDN=$(hostname -f 2>/dev/null || echo "")
  [[ -z "$SERVER_FQDN" ]] && { echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ FQDN."; exit 1; }

  # –û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ DOMAIN
  DOMAIN=$(echo "$SERVER_FQDN" | cut -d '.' -f2-)

  # –û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ DNS_ROLE
  if [[ "$SERVER_FQDN" =~ ^ns1\. ]]; then
    DNS_ROLE="primary"
  else
    DNS_ROLE="secondary"
  fi

  # –û–ø–∏—Ç –∑–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ SECOND_DNS_IP
  SECOND_DNS_IP=$(dig +short ns2.$DOMAIN A | tail -n 1)
  if [[ -z "$SECOND_DNS_IP" ]]; then
    echo "‚ö†Ô∏è –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ IP –∑–∞ ns2.$DOMAIN."
    read -p "‚û°Ô∏è –í—ä–≤–µ–¥–µ—Ç–µ —Ä—ä—á–Ω–æ IP –∑–∞ –≤—Ç–æ—Ä–∏—è DNS: " SECOND_DNS_IP
    if [[ -z "$SECOND_DNS_IP" ]]; then
      echo "‚ùå SECOND_DNS_IP –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ. –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ."
      exit 1
    fi
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ IP –∞–¥—Ä–µ—Å–∏—Ç–µ
  if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå SERVER_IP ($SERVER_IP) –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω IPv4."
    exit 1
  fi
  if ! [[ "$SECOND_DNS_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå SECOND_DNS_IP ($SECOND_DNS_IP) –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω IPv4."
    exit 1
  fi

  echo "‚úÖ –î–æ–±–∞–≤–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –≤ todo.modules:"
  echo "SERVER_IP=$SERVER_IP"
  echo "SERVER_FQDN=$SERVER_FQDN"
  echo "SECOND_DNS_IP=$SECOND_DNS_IP"
  echo "DNS_ROLE=$DNS_ROLE"
  echo ""

  # –ó–∞–ø–∏—Å –≤ todo.modules
  for VAR in SERVER_IP SECOND_DNS_IP SERVER_FQDN DNS_ROLE; do
    VALUE=$(eval echo "\$$VAR")
    if sudo grep -q "^$VAR=" "$MODULES_FILE" 2>/dev/null; then
      sudo sed -i "s|^$VAR=.*|$VAR=\"$VALUE\"|" "$MODULES_FILE"
    else
      echo "$VAR=\"$VALUE\"" | sudo tee -a "$MODULES_FILE" > /dev/null
    fi
  done

  echo "‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ –≤ $MODULES_FILE."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ named.conf.options
  # -------------------------------------------------------------------------------------
  OPTIONS_FILE="/etc/bind/named.conf.options"
  if [[ ! -f "$OPTIONS_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ $OPTIONS_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "üîß –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ ACL 'trusted' –∏ –ø–æ–ª–∏—Ç–∏–∫–∏..."
  sudo sed -i '/acl "trusted"/,/};/d' "$OPTIONS_FILE"
  sudo sed -i "1i acl \"trusted\" {\n    $SERVER_IP;\n    $SECOND_DNS_IP;\n};\n" "$OPTIONS_FILE"

  sudo sed -i '/allow-transfer/d' "$OPTIONS_FILE"
  sudo sed -i '/options {/,/};/ {
    /^};/i\    allow-transfer { trusted; };
  }' "$OPTIONS_FILE"

  if [[ "$DNS_ROLE" == "primary" ]]; then
    sudo sed -i '/also-notify/d' "$OPTIONS_FILE"
    sudo sed -i '/options {/,/};/ {
      /^};/i\    also-notify { '"$SECOND_DNS_IP"'; };
    }' "$OPTIONS_FILE"
  fi

  echo "‚úÖ ACL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
  if ! sudo named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω."

  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  sudo systemctl restart bind9
  if ! systemctl is-active --quiet bind9; then
    echo "‚ùå Bind9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
  # -------------------------------------------------------------------------------------
  if sudo grep -q '^SECURE_DNS_MODULE3=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^SECURE_DNS_MODULE3=.*|SECURE_DNS_MODULE3=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "SECURE_DNS_MODULE3=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "‚úÖ –ú–æ–¥—É–ª 3 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 4] –ê–ö–¢–ò–í–ò–†–ê–ù–ï –ù–ê DNSSEC –í –ó–û–ù–ò–¢–ï
# =====================================================================
echo "[4] –ê–ö–¢–ò–í–ò–†–ê–ù–ï –ù–ê DNSSEC –í –ó–û–ù–ò–¢–ï..."
echo "-----------------------------------------------------------"
echo ""

if sudo grep -q '^SECURE_DNS_MODULE4=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 4 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ UFW (–ø–æ—Ä—Ç 953 –∑–∞ rndc)
# -------------------------------------------------------------------------------------
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ UFW –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –ø–æ—Ä—Ç 953 (rndc)..."
if command -v ufw >/dev/null && sudo ufw status | grep -q "Status: active"; then
  if ! sudo ufw status | grep -q "953/tcp"; then
    echo "üîß –û—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –ø–æ—Ä—Ç 953/tcp –∑–∞ localhost..."
    sudo ufw allow from 127.0.0.1 to 127.0.0.1 port 953 proto tcp comment 'Allow rndc local control'
    sudo ufw reload
    echo "‚úÖ –ü–æ—Ä—Ç 953 –µ –ø–æ–∑–≤–æ–ª–µ–Ω –∑–∞ localhost."
  else
    echo "‚ÑπÔ∏è –ü–æ—Ä—Ç 953 –≤–µ—á–µ –µ —Ä–∞–∑—Ä–µ—à–µ–Ω."
  fi
else
  echo "‚ÑπÔ∏è UFW –Ω–µ –µ –∞–∫—Ç–∏–≤–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
fi
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ rndc
# -------------------------------------------------------------------------------------
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ rndc –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞..."
RNDC_KEY_FILE="/etc/bind/rndc.key"
NAMED_CONF="/etc/bind/named.conf"

# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–ª—é—á, –∞–∫–æ –ª–∏–ø—Å–≤–∞
if [[ ! -f "$RNDC_KEY_FILE" ]]; then
  echo "üîß –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ rndc –∫–ª—é—á..."
  sudo rndc-confgen -a -c "$RNDC_KEY_FILE"
  sudo chown root:bind "$RNDC_KEY_FILE"
  sudo chmod 640 "$RNDC_KEY_FILE"
  echo "‚úÖ rndc –∫–ª—é—á—ä—Ç –µ —Å—ä–∑–¥–∞–¥–µ–Ω."
else
  echo "‚ÑπÔ∏è rndc –∫–ª—é—á—ä—Ç –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
fi

# –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –≥—Ä–µ—à–µ–Ω include (–∞–∫–æ –∏–º–∞)
sudo sed -i '/include "\/etc\/rndc.key";/d' "$NAMED_CONF"

# –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª–Ω–∏—è include (–∞–∫–æ –ª–∏–ø—Å–≤–∞)
if ! sudo grep -q "include \"$RNDC_KEY_FILE\";" "$NAMED_CONF"; then
  echo "üîß –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ include –∑–∞ rndc.key..."
  echo "include \"$RNDC_KEY_FILE\";" | sudo tee -a "$NAMED_CONF" > /dev/null
fi

# –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ controls —Å–µ–∫—Ü–∏—è (–∞–∫–æ –ª–∏–ø—Å–≤–∞)
if ! sudo grep -q 'controls {' "$NAMED_CONF"; then
  echo "üîß –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ controls —Å–µ–∫—Ü–∏—è –∑–∞ rndc..."
  cat <<EOF | sudo tee -a "$NAMED_CONF" > /dev/null

controls {
    inet 127.0.0.1 port 953 allow { localhost; } keys { "rndc-key"; };
};
EOF
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
if ! sudo named-checkconf; then
  echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –µ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞! –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ."
  exit 1
fi

echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
sudo systemctl restart bind9
if ! systemctl is-active --quiet bind9; then
  echo "‚ùå Bind9 –Ω–µ –µ –∞–∫—Ç–∏–≤–Ω–∞ —Å–ª–µ–¥ —Ä–µ—Å—Ç–∞—Ä—Ç!"
  exit 1
fi
echo "‚úÖ Bind9 —Ä–∞–±–æ—Ç–∏ —É—Å–ø–µ—à–Ω–æ."
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 3: –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –∑–∞ DNSSEC
# -------------------------------------------------------------------------------------
if [[ ! -f "$MODULES_FILE" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ $MODULES_FILE. –ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø—Ä–æ–¥—ä–ª–∂–∏."
  exit 1
fi

DNSSEC_DOMAIN=$(grep '^DNSSEC_DOMAIN=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
DNSSEC_KEYS_DIR=$(grep '^DNSSEC_KEYS_DIR=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')

if [[ -z "$DNSSEC_DOMAIN" || -z "$DNSSEC_KEYS_DIR" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞—Ç DNSSEC_DOMAIN –∏–ª–∏ DNSSEC_KEYS_DIR –≤ $MODULES_FILE."
  exit 1
fi

if ! sudo test -d "$DNSSEC_KEYS_DIR"; then
  echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞ –∑–∞ –∫–ª—é—á–æ–≤–µ ($DNSSEC_KEYS_DIR) –ª–∏–ø—Å–≤–∞."
  exit 1
fi

echo "‚úÖ –ó–∞—Ä–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏:"
echo "DNSSEC_DOMAIN=$DNSSEC_DOMAIN"
echo "DNSSEC_KEYS_DIR=$DNSSEC_KEYS_DIR"
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 4: –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ DNSSEC –∑–∞ –∑–æ–Ω–∞—Ç–∞
# -------------------------------------------------------------------------------------
CONF_LOCAL="/etc/bind/named.conf.local"
if [[ ! -f "$CONF_LOCAL" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∏—è—Ç —Ñ–∞–π–ª $CONF_LOCAL."
  exit 1
fi

echo "üîß –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ DNSSEC –∑–∞ –∑–æ–Ω–∞—Ç–∞ $DNSSEC_DOMAIN..."
if ! sudo grep -q "zone \"$DNSSEC_DOMAIN\"" "$CONF_LOCAL"; then
  echo "‚ùå –ó–æ–Ω–∞—Ç–∞ $DNSSEC_DOMAIN –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –≤ $CONF_LOCAL."
  exit 1
fi

sudo sed -i "/zone \"$DNSSEC_DOMAIN\" {/,/};/ {
  /inline-signing/d
  /auto-dnssec/d
  /^};/i\    inline-signing yes;\n    auto-dnssec maintain;
}" "$CONF_LOCAL"

echo "‚úÖ DNSSEC –æ–ø—Ü–∏–∏—Ç–µ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏."
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 5: –ü–æ–¥–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –∑–æ–Ω–∞—Ç–∞
# -------------------------------------------------------------------------------------
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∑–æ–Ω–∞—Ç–∞ –≤–µ—á–µ –µ –ø–æ–¥–ø–∏—Å–∞–Ω–∞..."
if sudo rndc signing -list "$DNSSEC_DOMAIN" | grep -q "key"; then
  echo "‚ÑπÔ∏è –ó–æ–Ω–∞—Ç–∞ –≤–µ—á–µ –µ –ø–æ–¥–ø–∏—Å–∞–Ω–∞."
else
  echo "üîê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–≤–∞–Ω–µ..."

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–ª—é—á–æ–≤–µ
  if ! sudo ls "$DNSSEC_KEYS_DIR"/*.key >/dev/null 2>&1; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞—Ç DNSSEC –∫–ª—é—á–æ–≤–µ –≤ $DNSSEC_KEYS_DIR!"
    echo "‚û° –ò–∑–ø—ä–ª–Ω–µ—Ç–µ –ú–æ–¥—É–ª 2 –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ –∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
    exit 1
  fi

  # –û—Å–∏–≥—É—Ä—è–≤–∞–Ω–µ –Ω–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –∫–ª—é—á–æ–≤–µ—Ç–µ
  sudo chown -R bind:bind "$DNSSEC_KEYS_DIR"
  sudo chmod -R 640 "$DNSSEC_KEYS_DIR"/*.private
  sudo chmod -R 644 "$DNSSEC_KEYS_DIR"/*.key

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ controls
  if ! sudo rndc status >/dev/null 2>&1; then
    echo "‚ùå rndc –Ω–µ —Ä–∞–±–æ—Ç–∏! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞."
    exit 1
  fi

  echo "üîê –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ—Ç–µ —Å rndc loadkeys..."
  if ! sudo rndc loadkeys "$DNSSEC_DOMAIN"; then
    echo "‚ùå rndc loadkeys —Å–µ –ø—Ä–æ–≤–∞–ª–∏."
    exit 1
  fi

  echo "üîê –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø–æ–¥–ø–∏—Å–≤–∞–Ω–µ..."
  if ! sudo rndc signing -nsec3param 1 0 10 "$DNSSEC_DOMAIN"; then
    echo "‚ùå rndc signing —Å–µ –ø—Ä–æ–≤–∞–ª–∏."
    exit 1
  fi

  echo "‚úÖ –ü–æ–¥–ø–∏—Å–≤–∞–Ω–µ—Ç–æ –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–æ."
fi
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 6: –§–∏–Ω–∞–ª–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø–∏—Å
# -------------------------------------------------------------------------------------
echo "üîç –§–∏–Ω–∞–ª–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
if ! sudo named-checkconf; then
  echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
  exit 1
fi

sudo systemctl restart bind9
if ! systemctl is-active --quiet bind9; then
  echo "‚ùå Bind9 –Ω–µ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ."
  exit 1
fi

if sudo grep -q '^SECURE_DNS_MODULE4=' "$SETUP_ENV_FILE" 2>/dev/null; then
  sudo sed -i 's|^SECURE_DNS_MODULE4=.*|SECURE_DNS_MODULE4=‚úÖ|' "$SETUP_ENV_FILE"
else
  echo "SECURE_DNS_MODULE4=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
fi

echo "‚úÖ –ú–æ–¥—É–ª 4 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
echo ""
fi
echo ""
echo ""



















exit 0
# =====================================================================
# [–ú–û–î–£–õ 5] –í–ê–õ–ò–î–ê–¶–ò–Ø –ù–ê –ü–û–î–ü–ò–°–í–ê–ù–ï–¢–û
# =====================================================================
echo "[5] –í–ê–õ–ò–î–ê–¶–ò–Ø –ù–ê –ü–û–î–ü–ò–°–í–ê–ù–ï–¢–û..."
echo "-----------------------------------------------------------"
echo ""

SIGNED_FILE="/var/cache/bind/$DNSSEC_DOMAIN.db.signed"

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ signed —Ñ–∞–π–ª..."
if [[ -f "$SIGNED_FILE" ]]; then
  echo "‚úÖ Signed —Ñ–∞–π–ª—ä—Ç —Å—ä—â–µ—Å—Ç–≤—É–≤–∞: $SIGNED_FILE"
else
  echo "‚ùå –õ–∏–ø—Å–≤–∞ signed —Ñ–∞–π–ª –∑–∞ $DNSSEC_DOMAIN!"
  exit 1
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∞—Ç–∞ –∑–æ–Ω–∞..."
if ! sudo named-checkzone "$DNSSEC_DOMAIN" "$SIGNED_FILE"; then
  echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∞—Ç–∞ –∑–æ–Ω–∞."
  exit 1
fi
echo "‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω–∞—Ç–∞ –∑–æ–Ω–∞ –µ –≤–∞–ª–∏–¥–Ω–∞."
echo ""


# =====================================================================
# [–ú–û–î–£–õ 6] –¢–ï–°–¢ –° DIG
# =====================================================================
echo "[6] –¢–ï–°–¢ –ù–ê DNSSEC –° DIG..."
echo "-----------------------------------------------------------"
echo ""
if dig +dnssec "$DNSSEC_DOMAIN" @127.0.0.1 | grep -q "RRSIG"; then
  echo "‚úÖ DNSSEC –∑–∞–ø–∏—Å–∏—Ç–µ —Å–∞ –Ω–∞–ª–∏—á–Ω–∏ –≤ –æ—Ç–≥–æ–≤–æ—Ä–∞."
else
  echo "‚ùå DNSSEC –∑–∞–ø–∏—Å–∏—Ç–µ –ª–∏–ø—Å–≤–∞—Ç! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞."
  exit 1
fi
echo ""


# =====================================================================
# [–ú–û–î–£–õ 7] –§–ò–ù–ê–õ–ï–ù –û–¢–ß–ï–¢
# =====================================================================
echo "[7] –§–ò–ù–ê–õ–ï–ù –û–¢–ß–ï–¢..."
echo "-----------------------------------------------------------"
echo ""

# –ó–∞–ø–∏—Å –Ω–∞ –≥–ª–æ–±–∞–ª–Ω–∏—è —Å—Ç–∞—Ç—É—Å
if sudo grep -q '^SETUP_DNSSEC_STATUS=' "$SETUP_ENV_FILE" 2>/dev/null; then
  sudo sed -i 's|^SETUP_DNSSEC_STATUS=.*|SETUP_DNSSEC_STATUS=‚úÖ|' "$SETUP_ENV_FILE"
else
  echo "SETUP_DNSSEC_STATUS=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
fi

echo "‚úÖ DNSSEC –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""

# –ö—Ä–∞–π –Ω–∞ —à–∞–±–ª–æ–Ω–∞
