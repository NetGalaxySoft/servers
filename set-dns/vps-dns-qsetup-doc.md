# Въведение

`vps-dns-qsetup.sh` е скрипт за **първоначална инсталация и конфигуриране на DNS сървър с Bind9** в роля **MASTER** или **SLAVE**.  
Целта му е да осигури бърза и правилна настройка на основните конфигурационни файлове и услуги за работа на DNS сървър, включително:

- Автоматично инсталиране на Bind9 и необходимите пакети.
- Настройка на основните конфигурационни файлове (`named.conf.options`, `named.conf.local`).
- Определяне на роля на сървъра (MASTER или SLAVE) и съответните параметри.
- Проверка на работоспособността след инсталацията.

## Структура на скрипта
Скриптът е модулен и изпълнява стъпките последователно. Всеки модул е самостоятелно проверяем и записва резултатите си в лог файл.

## Какво НЕ прави скриптът
- Не създава конкретни DNS зони (това се изпълнява чрез отделни скриптове).
- Не конфигурира мерки за сигурност като TSIG или DNSSEC (ще бъдат реализирани в следващи скриптове).


## Модул 1: ПРЕДВАРИТЕЛНИ ПРОВЕРКИ

Модул 1 извършва задължителни проверки и събира основна информация преди инсталирането на DNS сървъра. Това гарантира, че скриптът се стартира в правилна среда и предотвратява фатални грешки.

### Какво включва модулът:

#### **Секция 1: Проверка за базова конфигурация**
- Проверява дали е изпълнен скриптът `vps-base-qsetup.sh` и дали системата има статус `SETUP_VPS_BASE_STATUS=✅`.
- Ако условието не е изпълнено → скриптът спира и се изтрива.
- Проверява дали DNS конфигурацията вече е завършена (`SETUP_VPS_DNS_STATUS=✅`), за да избегне повторна инсталация.

#### **Секция 2: Проверка на операционната система**
- Проверява дали файлът `/etc/os-release` съществува.
- Чете информация за ОС (ID и VERSION_ID).
- Поддържани системи:
  - Ubuntu: 22.04, 24.04
  - Debian: 11, 12
- Ако ОС е неподдържана → скриптът спира с ясно съобщение.
- Ако ОС е поддържана → показва потвърждение ✅.

#### **Секция 3: Проверка на IP адреса**
- Изисква от потребителя да въведе публичния IP адрес на сървъра.
- Проверява:
  - Формат на IP (валиден IPv4).
  - Съответствие с реалния IP (`ifconfig.me`).
- Изисква IP адрес на втория DNS сървър (MASTER ↔ SLAVE).
- Не допуска:
  - Празна стойност.
  - Съвпадение с текущия IP.
  - Невалиден формат.

#### **Секция 4: Проверка на hostname**
- Извлича пълния hostname (FQDN) чрез `hostname -f`.
- Валидира, че FQDN отговаря на правилото за DNS сървъри: `ns1.example.com`, `ns2.example.com` и т.н.
- Ако hostname е неправилен или липсва → прекратява изпълнението.

#### **Секция 5: Запис на данни в конфигурационни файлове**
- Създава файла `/etc/netgalaxy/todo.modules` при липса.
- Записва:
  - `SERVER_IP`
  - `SERVER_FQDN`
  - `SECOND_DNS_IP`
- Обновява статуса в `/etc/netgalaxy/setup.env` с `DNS_RESULT_MODULE1=✅`.

---

### ✅ Ключови проверки и защита
- Скриптът прекратява изпълнението при всяка критична грешка (неподдържана ОС, грешен IP, невалиден hostname).
- Не допуска повторно изпълнение, за да предотврати конфликтни конфигурации.

---

## Модул 2: ИНСТАЛИРАНЕ НА BIND9

Модул 2 се грижи за инсталирането на DNS сървъра **Bind9** и основните му инструменти. Той гарантира, че услугата е активна преди да продължи следващите стъпки.

### Какво включва модулът:

#### **Секция 1: Проверка дали модулът вече е изпълнен**
- Чете файла `/etc/netgalaxy/setup.env`.
- Ако е наличен ред `DNS_RESULT_MODULE2=✅` → модулът се пропуска.

#### **Секция 2: Проверка дали Bind9 вече е инсталиран**
- Използва `dpkg -s bind9` за да провери.
- Ако е инсталиран → показва съобщение и записва `DNS_RESULT_MODULE2=✅` в `setup.env`.

#### **Секция 3: Инсталация при липса**
- Стартира:
  ```bash
  sudo apt-get update && sudo apt-get install -y bind9 bind9-utils bind9-dnsutils
  ```
- След инсталацията проверява статуса:
  - Ако услугата **bind9** е активна → записва `DNS_RESULT_MODULE2=✅` в `setup.env`.
  - Ако не е активна → извежда грешка и спира скрипта.

#### **Секция 4: Обработка на грешки**
- Ако възникне грешка при инсталацията или стартирането на услугата:
  - Показва ясно съобщение.
  - Спира изпълнението.
  - Изтрива скрипта (`rm -- "$0"`), за да се предотврати повторно изпълнение.

---

### ✅ Ключови особености
- Всички резултати се записват в `/etc/netgalaxy/setup.env` с ключ `DNS_RESULT_MODULE2`.
- Модулът е **идемпотентен** (може да се стартира повторно без странични ефекти, ако вече е инсталиран).

---

## Модул 3: КОНФИГУРИРАНЕ НА named.conf.options

Модул 3 настройва основния конфигурационен файл `named.conf.options` за Bind9. Целта е да осигури базова и сигурна конфигурация за DNS сървъра.

### Какво включва модулът:

#### **Секция 1: Проверка дали модулът вече е изпълнен**
- Чете файла `/etc/netgalaxy/setup.env`.
- Ако е наличен ред `DNS_RESULT_MODULE3=✅` → модулът се пропуска.

#### **Секция 2: Четене на данни**
- Чете данните от `/etc/netgalaxy/todo.modules`:
  - `SERVER_IP` – основният IPv4 адрес на сървъра.
  - `IPV6_ENABLED` – указва дали има IPv6 поддръжка (`yes` или `no`).
- Ако данните липсват → скриптът спира с грешка.

#### **Секция 3: Създаване на нова конфигурация за named.conf.options**
- Създава файл `/etc/bind/named.conf.options` със съдържание:
  ```text
  options {
      directory "/var/cache/bind";

      listen-on { 127.0.0.1; SERVER_IP; };
      listen-on-v6 { any; } или { none; } (според IPv6 поддръжката);

      allow-query { any; };

      recursion no;

      forwarders {
          1.1.1.1;
          8.8.8.8;
      };

      dnssec-validation auto;
  };
  ```

#### **Секция 4: Проверка на синтаксиса**
- Използва `named-checkconf`.
- Ако има грешка → показва съобщение и прекратява изпълнението.

#### **Секция 5: Отваряне на порт 53**
- Отваря порт 53 (TCP и UDP) в UFW:
  ```bash
  sudo ufw allow 53/tcp
  sudo ufw allow 53/udp
  ```

#### **Секция 6: Рестартиране на услугата**
- Рестартира `bind9` и проверява дали е активна.
- Ако услугата не стартира → показва грешка и спира скрипта.

#### **Секция 7: Запис на резултата**
- Добавя или обновява ред в `/etc/netgalaxy/setup.env`:
  ```text
  DNS_RESULT_MODULE3=✅
  ```

---

### ✅ Ключови особености
- Конфигурацията е **изцяло нова**, старият файл не се архивира (няма такава стъпка).
- IPv6 се настройва само за listen-on-v6; ако е изключен → { none; }.
- Модулът е **идемпотентен** – не се изпълнява повторно, ако вече е завършен.

---

## Модул 4: ОПРЕДЕЛЯНЕ НА РОЛЯТА НА DNS СЪРВЪРА

Модул 4 определя дали текущият DNS сървър ще бъде **MASTER (primary)** или **SLAVE (secondary)** на база пълното име на хоста (FQDN). Това е критична стъпка за правилната конфигурация на DNS репликацията.

### Какво включва модулът:

#### **Секция 1: Проверка дали модулът вече е изпълнен**
- Чете файла `/etc/netgalaxy/setup.env`.
- Ако е наличен ред `DNS_RESULT_MODULE4=✅` → модулът се пропуска.

#### **Секция 2: Четене на FQDN**
- Чете от файла `/etc/netgalaxy/todo.modules` стойността на:
  - `SERVER_FQDN` – пълното име на сървъра.
- Ако липсва → скриптът прекратява изпълнението.

#### **Секция 3: Определяне на роля**
- Логика:
  - Ако FQDN започва с `ns1.` → ролята е **primary**.
  - Ако FQDN започва с `ns2.` или `ns3.` → ролята е **secondary**.
  - В други случаи → показва грешка и прекратява изпълнението.

#### **Секция 4: Запис на ролята**
- Записва или обновява променливата `DNS_ROLE` в `/etc/netgalaxy/todo.modules`.

#### **Секция 5: Проверка на синтаксиса**
- Стартира `named-checkconf`.
- Ако има грешка → прекратява изпълнението.

#### **Секция 6: Рестартиране на услугата**
- Рестартира `bind9`.
- Проверява дали услугата е активна.
- Ако не стартира → прекратява скрипта.

#### **Секция 7: Запис на резултата**
- Добавя или обновява ред в `/etc/netgalaxy/setup.env`:
  ```text
  DNS_RESULT_MODULE4=✅
  ```

---

### ✅ Ключови особености
- Определянето на ролята се базира на конвенцията за имена:
  - `ns1.domain.tld` → primary
  - `ns2.domain.tld` или `ns3.domain.tld` → secondary
- Модулът е критичен за следващите стъпки (MASTER/SLAVE синхронизация).
- Модулът е **идемпотентен** – не се изпълнява повторно, ако вече е завършен.

---

## Модул 5: СЪЗДАВАНЕ НА ЗОНИ

Модул 5 създава основните DNS зони (forward и reverse) и добавя конфигурация в `named.conf.local`. Логиката зависи от ролята на сървъра – **PRIMARY (master)** или **SECONDARY (slave)**.

### Какво включва модулът:

#### **Секция 1: Проверка дали модулът вече е изпълнен**
- Ако `DNS_RESULT_MODULE5=✅` присъства в `setup.env`, модулът се пропуска.

#### **Секция 2: Проверка на предходния модул и зареждане на данни**
- Уверява се, че Модул 4 е изпълнен успешно (`DNS_RESULT_MODULE4=✅`).
- Зарежда:
  - `SERVER_FQDN` – пълното име на сървъра.
  - `SERVER_IP` – IP адрес на сървъра.
  - `DNS_ROLE` – роля (primary или secondary).
  - `SECOND_DNS_IP` – IP на другия DNS сървър.

#### **Секция 3: Проверка на данните**
- Потвърждава, че всички ключови данни са налични.
- Определя домейна от FQDN (всичко след първия компонент).

#### **Секция 4: Подготовка на конфигурационните файлове**
- Създава директория `/etc/bind/zones` за файловете на зоните (ако не съществува).
- Изчислява името на reverse зоната (пример: `3.2.1` за IP 1.2.3.X).
- Подготвя пътищата:
  - Forward зона: `/etc/bind/zones/db.DOMAIN`
  - Reverse зона: `/etc/bind/zones/db.X.X.X.in-addr.arpa`

#### **Секция 5: Конфигуриране според ролята**
- **PRIMARY (master):**
  - Добавя зони в `named.conf.local` (forward + reverse).
  - При наличие на `SECOND_DNS_IP` → добавя `allow-transfer` и `also-notify`.
  - Създава forward зона с:
    - SOA (Serial динамично на база дата/час).
    - NS записи (ns1, ns2 при втори DNS).
    - A записи (ns1, ns2).
  - Създава reverse зона с PTR записи за IP адреса на ns1.
- **SECONDARY (slave):**
  - Добавя зона в `named.conf.local` с тип `slave` и задава `masters { PRIMARY_IP; }`.
  - При повторно изпълнение актуализира IP на master.

#### **Секция 6: Проверка на синтаксиса и рестарт**
- Проверява конфигурацията с `named-checkconf`.
- Ако е валидна → рестартира `bind9`.
- Проверява дали услугата е активна.
- Показва диагностична информация (`rndc status` → брой зони).

#### **Секция 7: Финален запис**
- Записва:
  ```text
  DNS_RESULT_MODULE5=✅
  ```

---

### ✅ Ключови особености
- Създава основните зони автоматично според ролята на сървъра.
- Добавя синхронна логика между PRIMARY и SECONDARY чрез `allow-transfer` и `also-notify`.
- Подготвя forward и reverse зона (SOA, NS, A, PTR).
- Модулът е **идемпотентен** – не се изпълнява повторно, ако вече е завършен.

---

## Модул 6: ФИНАЛЕН ОТЧЕТ

Модул 6 предоставя обобщение на всички изпълнени модули и извършва автоматични проверки за валидност на конфигурацията на DNS сървъра. Завършва с потвърждение от оператора за окончателно приемане на конфигурацията.

### Какво включва модулът:

#### **Секция 1: Обобщение на статуса на модулите**
- Чете резултатите от `/etc/netgalaxy/setup.env` и показва:
  - Модул 1 – Предварителни проверки
  - Модул 2 – Инсталиране на BIND9
  - Модул 3 – Конфигурация options
  - Модул 4 – Определяне на роля
  - Модул 5 – Създаване на зони

#### **Секция 2: Автоматични проверки**
1. **Статус на услугата BIND9**  
   - Проверява дали услугата `bind9` е активна.
2. **Резолюция на основната зона**  
   - С помощта на `dig` проверява дали домейнът връща IP адрес.
3. **Реверсна зона (само за primary)**  
   - Проверява дали PTR записът за основния IP връща `ns1.DOMAIN`.
4. **Проверка на заредените зони**  
   - Използва `rndc dumpdb` и проверява дали зоната присъства в `named_dump.db`.
5. **Синхронизация на serial номера (само за secondary)**  
   - Сравнява serial номера на SOA записа между MASTER и SLAVE.
   - Ако не съвпадат → скриптът прекратява с грешка.

#### **Секция 3: Потвърждение от оператора**
- Изисква потвърждение (`y/n`) за успешна конфигурация.
- При потвърждение:
  - Записва `SETUP_VPS_DNS_STATUS=✅` в `setup.env`.
  - Изтрива файла `todo.modules`.
  - Премахва скрипта (`rm -- "$0"`).
- Ако отговорът е `n` → нищо не се изтрива.

---

### ✅ Ключови особености
- Извършва пълна автоматична проверка на състоянието на DNS преди финализиране.
- Проверява както forward, така и reverse зона.
- Гарантира, че SLAVE е синхронизиран с MASTER чрез serial номера.
- Премахва временните файлове и самия скрипт след успешно приключване.

---
