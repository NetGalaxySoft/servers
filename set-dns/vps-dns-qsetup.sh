#!/bin/bash

# ==========================================================================
#  vps-dns-qsetup - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9)
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-18
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∏–∑–≤—ä—Ä—à–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9)
#  –≤—ä—Ä—Ö—É VPS, –ø–æ–¥–≥–æ—Ç–≤–µ–Ω —Å –±–∞–∑–æ–≤–∏—è —Å–∫—Ä–∏–ø—Ç vps-base-qsetup.sh.
#  –°–∫—Ä–∏–ø—Ç—ä—Ç —Å–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞ –¥–∏—Ä–µ–∫—Ç–Ω–æ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ –∏ —Å–ª–µ–¥–≤–∞ –º–æ–¥—É–ª–µ–Ω –ø—Ä–∏–Ω—Ü–∏–ø.
#
#  –ú–æ–¥—É–ª–∏:
#    1. –ü—Ä–æ–≤–µ—Ä–∫–∏ (IP, hostname, setup.env, –ø—Ä–µ–¥–∏—à–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ)
#    2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞
#    3. –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Bind9
#    4. –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏ –∑–æ–Ω–∏ –∏ –∑–∞–ø–∏—Å–∏
#    5. –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –∏ —Ç–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ DNS —É—Å–ª—É–≥–∞—Ç–∞
# ==========================================================================

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-dns-qsetup.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9) –≤—ä—Ä—Ö—É VPS."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-dns-qsetup –≤–µ—Ä—Å–∏—è 1.0 (18 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

echo ""
echo -e "\e[32m=========================================="
echo -e " –ù–ê–ß–ê–õ–ù–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –û–¢–î–ê–õ–ï–ß–ï–ù –°–™–†–í–™–†"
echo -e "==========================================\e[0m"
echo ""

NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"


# === [–ú–û–î–£–õ 1] –ö–û–ù–§–ò–ì–£–†–ò–†–ê–ù–ï –ù–ê DNS –°–™–†–í–™–† =========================
echo "[1] –ö–û–ù–§–ò–ì–£–†–ò–†–ê–ù–ï –ù–ê DNS –°–™–†–í–™–†..."
echo "-----------------------------------------------------------"
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç—ä—Ç —â–µ –±—ä–¥–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –Ω–∞ –ø—Ä–∞–≤–∏–ª–Ω–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞ —Å–∏—Å—Ç–µ–º–∞.
# -------------------------------------------------------------------------------------

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ ---
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞..."
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  OS_NAME=$ID
  OS_VERSION=$VERSION_ID
else
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –û–°. –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ Ubuntu –∏–ª–∏ Debian."
  exit 1
fi

SUPPORTED=false
if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
  SUPPORTED=true
elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
  SUPPORTED=true
fi

if [[ "$SUPPORTED" == false ]]; then
  echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ $PRETTY_NAME –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –æ—Ç —Ç–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç."
  echo "–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏ —Å–∏—Å—Ç–µ–º–∏: Ubuntu 22.04/24.04, Debian 11/12"
  exit 1
fi

echo "‚úÖ –ó–∞—Å–µ—á–µ–Ω–∞ –ø–æ–¥–¥—ä—Ä–∂–∞–Ω–∞ –û–°: $PRETTY_NAME"
echo ""
echo ""

#------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç—ä—Ç —â–µ –±—ä–¥–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –Ω–∞ –ø—Ä–∞–≤–∏–ª–Ω–∏—è —Å—ä—Ä–≤—ä—Ä.
#-------------------------------------------------------------------------
while true; do
  printf "üåê –í—ä–≤–µ–¥–µ—Ç–µ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): "
  read SERVER_IP

  if [[ "$SERVER_IP" == "q" || "$SERVER_IP" == "Q" ]]; then
    echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
    exit 0
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–µ–Ω IPv4 —Ñ–æ—Ä–º–∞—Ç
  if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω IPv4 –∞–¥—Ä–µ—Å (–ø—Ä–∏–º–µ—Ä: 192.168.1.100)."
    continue
  fi

  # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ —Ä–µ–∞–ª–Ω–∏—è –ø—É–±–ª–∏—á–µ–Ω IP
  ACTUAL_IP=$(curl -s -4 ifconfig.me)

  if [[ "$ACTUAL_IP" != "$SERVER_IP" ]]; then
    echo ""
    echo "üö´ –ù–µ—Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ! –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç IP ($SERVER_IP) –Ω–µ —Å—ä–≤–ø–∞–¥–∞ —Å —Ä–µ–∞–ª–Ω–∏—è IP –Ω–∞ –º–∞—à–∏–Ω–∞—Ç–∞."
    echo ""
    read -p "üîÅ –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –æ–ø–∏—Ç–∞—Ç–µ –æ—Ç–Ω–æ–≤–æ? [Enter –∑–∞ –î–ê, 'q' –∑–∞ –∏–∑—Ö–æ–¥]: " retry
    if [[ "$retry" == "q" || "$retry" == "Q" ]]; then
      echo "‚õî –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    fi
    echo ""
  else
    echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: —Å–∫—Ä–∏–ø—Ç—ä—Ç –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ —Å IP $SERVER_IP."
    break
  fi
done
echo ""
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ hostname –µ –¥–æ–º–µ–π–Ω –æ—Ç —Ç—Ä–µ—Ç–æ –Ω–∏–≤–æ, –∑–∞–ø–æ—á–≤–∞—â —Å ns1, ns2 –∏–ª–∏ ns3.
# -------------------------------------------------------------------------------------

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hostname..."
HOSTNAME_FQDN=$(hostname -f 2>/dev/null || echo "")

if [[ -z "$HOSTNAME_FQDN" ]]; then
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –ø—ä–ª–Ω–∏—è hostname (FQDN)."
  echo "–°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏ –±–µ–∑ –≤–∞–ª–∏–¥–µ–Ω FQDN."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Ç—Ä–µ—Ç–æ –Ω–∏–≤–æ –∏ –ø—Ä–µ—Ñ–∏–∫—Å ns1/ns2/ns3
if [[ ! "$HOSTNAME_FQDN" =~ ^ns[1-3]\..+\..+$ ]]; then
  echo ""
  echo "üö´ –ù–µ—Å—ä–≤–º–µ—Å—Ç–∏–º –∏–ª–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º –¥–æ–º–µ–π–Ω: $HOSTNAME_FQDN"
  echo ""
  echo "‚ÑπÔ∏è –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä–∏, —Ä–∞–±–æ—Ç–µ—â–∏ –≤ –º—Ä–µ–∂–∞—Ç–∞ NetGalaxy"
  echo "–∏–ª–∏ –æ–±—Å–ª—É–∂–≤–∞—â–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ç–∞ NetGalaxy. –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç hostname –Ω–µ –æ—Ç–≥–æ–≤–∞—Ä—è –Ω–∞ –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è—Ç–∞."
  echo ""
  exit 1
fi

echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: hostname –æ—Ç–≥–æ–≤–∞—Ä—è –Ω–∞ –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è—Ç–∞ ($HOSTNAME_FQDN)."
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ä–≤ —Ñ–∞–π–ª–∞ —Ñ–∞–π–ª–∞ /etc/netgalaxy/setup.env –¥–∞–ª–∏ —Å—ä—Ä–≤—ä—Ä—ä—Ç –∏–º–∞ —É—Å–ø–µ—à–Ω–∞ 
# –Ω–∞—á–∞–ª–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –¥–∞–ª–∏ —Ç–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –≤–µ—á–µ –µ –±–∏–ª –∏–∑–ø—ä–ª–Ω–µ–Ω –Ω–∞ —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä.
# -------------------------------------------------------------------------------------

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ –≤ $SETUP_ENV_FILE..."
echo ""

# üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –µ –±–∏–ª–∞ –∏–∑–≤—ä—Ä—à–µ–Ω–∞:
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! sudo grep -q '^SETUP_VPS_BASE_STATUS=‚úÖ' "$SETUP_ENV_FILE"; then
  echo "üõë –ù–∞—á–∞–ª–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä –Ω–µ –µ –≤ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è—Ç–∞ "
  echo "   –∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∏—Ç–µ –æ—Ç –º—Ä–µ–∂–∞—Ç–∞ NetGalaxy. –ú–æ–ª—è, –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç–∞ "
  echo "   vps-base-qsetup.sh –∑–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ—Ç–æ –Ω–∞—á–∞–ª–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞."
  echo ""
  echo "üîß –ò–∑–ø—ä–ª–Ω–µ–Ω–∏–µ—Ç–æ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
  echo ""
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å —Ç–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –≤–µ—á–µ –µ –±–∏–ª–∞ –∏–∑–≤—ä—Ä—à–µ–Ω–∞
if sudo grep -q '^SETUP_VPS_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE"; then
  echo "üõë –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –≤–µ—á–µ –µ –±–∏–ª –∏–∑–ø—ä–ª–Ω–µ–Ω –Ω–∞ —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä."
  echo "   –ü–æ–≤—Ç–æ—Ä–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–µ —Å–µ —Ä–∞–∑—Ä–µ—à–∞–≤–∞ –∑–∞ –ø—Ä–µ–¥–ø–∞–∑–≤–∞–Ω–µ –æ—Ç —Å–±–æ–π –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞."
  echo ""
  [[ -f "$0" ]] && rm -- "$0"
  exit 0
fi

# ‚úÖ –ó–∞–ø–∏—Å –∏–ª–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ IP –∏ FQDN –≤ todo.modules
if sudo grep -q '^SERVER_IP=' "$MODULES_FILE" 2>/dev/null; then
  sudo sed -i "s|^SERVER_IP=.*|SERVER_IP=\"$SERVER_IP\"|" "$MODULES_FILE"
else
  echo "SERVER_IP=\"$SERVER_IP\"" | sudo tee -a "$MODULES_FILE" > /dev/null
fi

if sudo grep -q '^SERVER_FQDN=' "$MODULES_FILE" 2>/dev/null; then
  sudo sed -i "s|^SERVER_FQDN=.*|SERVER_FQDN=\"$HOSTNAME_FQDN\"|" "$MODULES_FILE"
else
  echo "SERVER_FQDN=\"$HOSTNAME_FQDN\"" | sudo tee -a "$MODULES_FILE" > /dev/null
fi

# ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –≤ setup.env
if sudo grep -q '^SETUP_VPS_DNS_STATUS=' "$SETUP_ENV_FILE" 2>/dev/null; then
  sudo sed -i 's|^SETUP_VPS_DNS_STATUS=.*|SETUP_VPS_DNS_STATUS=‚úÖ|' "$SETUP_ENV_FILE"
else
  echo "RESULT_DNS_CHECKS=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
fi

echo "‚úÖ –°—ä—Ä–≤—ä—Ä—ä—Ç –µ —Å –≤–∞–ª–∏–¥–Ω–∞ –Ω–∞—á–∞–ª–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è."
echo ""
echo ""


# === [–ú–û–î–£–õ 2] –ò–ù–°–¢–ê–õ–ò–†–ê–ù–ï –ù–ê BIND9 =========================
echo "[2] –ò–ù–°–¢–ê–õ–ò–†–ê–ù–ï –ù–ê BIND9..."
echo "-----------------------------------------------------------"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ BIND9 –≤–µ—á–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω
if dpkg -s bind9 >/dev/null 2>&1; then
  echo "‚ÑπÔ∏è BIND9 –≤–µ—á–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ —Ç–æ–∑–∏ –º–æ–¥—É–ª."
  # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –≤ setup.env (–æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –∏–ª–∏ –¥–æ–±–∞–≤—è–Ω–µ)
  if sudo grep -q '^RESULT_BIND9_INSTALL=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^RESULT_BIND9_INSTALL=.*|RESULT_BIND9_INSTALL=‚úÖ (–≤–µ—á–µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω)|' "$SETUP_ENV_FILE"
  else
    echo "RESULT_BIND9_INSTALL=‚úÖ (–≤–µ—á–µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω)" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi
else
  echo "‚è≥ –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ BIND9 (bind9 bind9-utils bind9-dnsutils)..."
  if sudo apt-get update && sudo apt-get install -y bind9 bind9-utils bind9-dnsutils; then
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞ BIND9..."
    if systemctl is-active --quiet bind9; then
      echo "‚úÖ BIND9 –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω –∏ —É—Å–ª—É–≥–∞—Ç–∞ —Ä–∞–±–æ—Ç–∏."
      # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –≤ setup.env
      if sudo grep -q '^RESULT_BIND9_INSTALL=' "$SETUP_ENV_FILE" 2>/dev/null; then
        sudo sed -i 's|^RESULT_BIND9_INSTALL=.*|RESULT_BIND9_INSTALL=‚úÖ|' "$SETUP_ENV_FILE"
      else
        echo "RESULT_BIND9_INSTALL=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
      fi
    else
      echo "‚ùå –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏, –Ω–æ —É—Å–ª—É–≥–∞—Ç–∞ BIND9 –Ω–µ –µ –∞–∫—Ç–∏–≤–Ω–∞."
      echo "‚õî –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Ä—ä—á–Ω–æ."
      [[ -f "$0" ]] && rm -- "$0"
      exit 1
    fi
  else
    echo "‚ùå –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ BIND9."
    echo "‚õî –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    [[ -f "$0" ]] && rm -- "$0"
    exit 1
  fi
fi
echo ""
echo ""

# === [–ú–û–î–£–õ 4] –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê –ù–ê DNS –°–™–†–í–™–†–ê =========================
echo "[4] –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê –†–û–õ–Ø–¢–ê –ù–ê DNS –°–™–†–í–™–†–ê..."
echo "-----------------------------------------------------------"
echo ""

# üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if sudo grep -q '^RESULT_BIND9_ROLE=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 4 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
  return 0 2>/dev/null || exit 0
fi

# ‚úÖ –ß–µ—Ç–µ–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –æ—Ç todo.modules
if [[ -f "$MODULES_FILE" ]]; then
  SERVER_FQDN=$(grep '^SERVER_FQDN=' "$MODULES_FILE" | cut -d '"' -f2)
else
  echo "‚ùå –õ–∏–ø—Å–≤–∞ —Ñ–∞–π–ª—ä—Ç $MODULES_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∏–º–∞–º–µ –≤–∞–ª–∏–¥–µ–Ω FQDN
if [[ -z "$SERVER_FQDN" ]]; then
  echo "‚ùå –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω SERVER_FQDN –≤ $MODULES_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —Ä–æ–ª—è—Ç–∞ –ø–æ FQDN
DNS_ROLE=""
if [[ "$SERVER_FQDN" =~ ^ns1\. ]]; then
  DNS_ROLE="primary"
elif [[ "$SERVER_FQDN" =~ ^ns[23]\. ]]; then
  DNS_ROLE="secondary"
else
  echo "üõë –ù–µ—Å—ä–≤–º–µ—Å—Ç–∏–º–æ –∏–º–µ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: $SERVER_FQDN"
  echo "–°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏, –∑–∞—â–æ—Ç–æ —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω DNS (ns1/ns2/ns3)."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

echo "‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—è: $DNS_ROLE"
echo ""

# ‚úÖ –ó–∞–ø–∏—Å –∏–ª–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ DNS_ROLE –≤ todo.modules
if sudo grep -q '^DNS_ROLE=' "$MODULES_FILE" 2>/dev/null; then
  sudo sed -i "s|^DNS_ROLE=.*|DNS_ROLE=\"$DNS_ROLE\"|" "$MODULES_FILE"
else
  echo "DNS_ROLE=\"$DNS_ROLE\"" | sudo tee -a "$MODULES_FILE" > /dev/null
fi

# ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ named.conf.local (–∞–∫–æ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞)
if [[ ! -f /etc/bind/named.conf.local ]]; then
  echo "// –õ–æ–∫–∞–ª–Ω–∏ DNS –∑–æ–Ω–∏ —â–µ —Å–µ –¥–æ–±–∞–≤—è—Ç —Ç—É–∫" | sudo tee /etc/bind/named.conf.local > /dev/null
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
if ! sudo named-checkconf; then
  echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ BIND9. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# ‚úÖ –†–µ—Å—Ç–∞—Ä—Ç –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞
echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ BIND9..."
sudo systemctl restart bind9
if ! systemctl is-active --quiet bind9; then
  echo "‚ùå –£—Å–ª—É–≥–∞—Ç–∞ BIND9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –≤ setup.env
if sudo grep -q '^RESULT_BIND9_ROLE=' "$SETUP_ENV_FILE" 2>/dev/null; then
  sudo sed -i 's|^RESULT_BIND9_ROLE=.*|RESULT_BIND9_ROLE=‚úÖ|' "$SETUP_ENV_FILE"
else
  echo "RESULT_BIND9_ROLE=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
fi

echo "‚úÖ –ú–æ–¥—É–ª 4 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ: —Ä–æ–ª—è—Ç–∞ –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä–∞ –µ $DNS_ROLE."
echo ""
echo ""
