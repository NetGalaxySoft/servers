#!/bin/bash

# ==========================================================================
#  vps-dns-qsetup - ะะฒัะพะผะฐัะธะทะธัะฐะฝะฐ ะบะพะฝัะธะณััะฐัะธั ะฝะฐ DNS ัััะฒัั (Bind9)
# --------------------------------------------------------------------------
#  ะะตััะธั: 1.0
#  ะะฐัะฐ: 2025-07-18
#  ะะฒัะพั: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  ะขะพะทะธ ัะบัะธะฟั ะธะทะฒัััะฒะฐ ะฐะฒัะพะผะฐัะธะทะธัะฐะฝะฐ ะบะพะฝัะธะณััะฐัะธั ะฝะฐ DNS ัััะฒัั (Bind9)
#  ะฒัััั VPS, ะฟะพะดะณะพัะฒะตะฝ ั ะฑะฐะทะพะฒะธั ัะบัะธะฟั vps-base-qsetup.sh.
#  ะกะบัะธะฟััั ัะต ะธะทะฟัะปะฝัะฒะฐ ะดะธัะตะบัะฝะพ ะฝะฐ ัััะฒััะฐ ะธ ัะปะตะดะฒะฐ ะผะพะดัะปะตะฝ ะฟัะธะฝัะธะฟ.
#
#  ะะพะดัะปะธ:
#    1. ะัะพะฒะตัะบะธ (IP, hostname, setup.env, ะฟัะตะดะธัะฝะพ ะธะทะฟัะปะฝะตะฝะธะต)
#    2. ะะพะดะณะพัะพะฒะบะฐ ะฝะฐ ัะธััะตะผะฐัะฐ
#    3. ะะฝััะฐะปะธัะฐะฝะต ะธ ะบะพะฝัะธะณััะธัะฐะฝะต ะฝะฐ Bind9
#    4. ะกัะทะดะฐะฒะฐะฝะต ะฝะฐ ะพัะฝะพะฒะฝะธ ะทะพะฝะธ ะธ ะทะฐะฟะธัะธ
#    5. ะะบัะธะฒะธัะฐะฝะต ะธ ัะตััะฒะฐะฝะต ะฝะฐ DNS ััะปัะณะฐัะฐ
# ==========================================================================

# === ะะะะะฉะะ ะะะคะะะะะฆะะฏ ===================================================
show_help() {
  echo "ะะทะฟะพะปะทะฒะฐะฝะต: vps-dns-qsetup.sh [ะพะฟัะธั]"
  echo ""
  echo "ะะฒัะพะผะฐัะธะทะธัะฐะฝะฐ ะธ ะฑะตะทะพะฟะฐัะฝะฐ ะบะพะฝัะธะณััะฐัะธั ะฝะฐ DNS ัััะฒัั (Bind9) ะฒัััั VPS."
  echo ""
  echo "ะะฟัะธะธ:"
  echo "  --version       ะะพะบะฐะทะฒะฐ ะฒะตััะธััะฐ ะฝะฐ ัะบัะธะฟัะฐ"
  echo "  --help          ะะพะบะฐะทะฒะฐ ัะฐะทะธ ะฟะพะผะพั"
}

# === ะะะะะะะขะะ ะะ ะะะฆะะ ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-dns-qsetup ะฒะตััะธั 1.0 (18 ัะปะธ 2025 ะณ.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "โ ะะตัะฐะทะฟะพะทะฝะฐัะฐ ะพะฟัะธั: $1"
      show_help
      exit 1
      ;;
  esac
fi

echo ""
echo -e "\e[32m=========================================="
echo -e " ะะะงะะะะ ะะะะคะะะฃะะะฆะะฏ ะะ ะะขะะะะะงะะ ะกะชะะะชะ"
echo -e "==========================================\e[0m"
echo ""

NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"


# === [ะะะะฃะ 1] ะะะะคะะะฃะะะะะะ ะะ DNS ะกะชะะะชะ =========================
echo "[1] ะะะะคะะะฃะะะะะะ ะะ DNS ะกะชะะะชะ..."
echo "-----------------------------------------------------------"
echo ""

# ะกะะะฆะะฏ 1: ะัะพะฒะตัะบะฐ ะดะฐะปะธ ัะบัะธะฟััั ัะต ะฑัะดะต ััะฐััะธัะฐะฝ ะฝะฐ ะฟัะฐะฒะธะปะฝะฐัะฐ ะพะฟะตัะฐัะธะพะฝะฝะฐ ัะธััะตะผะฐ.

# --- ะัะพะฒะตัะบะฐ ะฝะฐ ะพะฟะตัะฐัะธะพะฝะฝะฐัะฐ ัะธััะตะผะฐ ---
echo "๐ ะัะพะฒะตัะบะฐ ะฝะฐ ะพะฟะตัะฐัะธะพะฝะฝะฐัะฐ ัะธััะตะผะฐ..."
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  OS_NAME=$ID
  OS_VERSION=$VERSION_ID
else
  echo "โ ะะตััะฟะตัะฝะพ ะพัะบัะธะฒะฐะฝะต ะฝะฐ ะะก. ะกะบัะธะฟััั ะธะทะธัะบะฒะฐ Ubuntu ะธะปะธ Debian."
  exit 1
fi

SUPPORTED=false
if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
  SUPPORTED=true
elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
  SUPPORTED=true
fi

if [[ "$SUPPORTED" == false ]]; then
  echo "โ ะะฟะตัะฐัะธะพะฝะฝะฐัะฐ ัะธััะตะผะฐ $PRETTY_NAME ะฝะต ัะต ะฟะพะดะดััะถะฐ ะพั ัะพะทะธ ัะบัะธะฟั."
  echo "ะะพะดะดััะถะฐะฝะธ ัะธััะตะผะธ: Ubuntu 22.04/24.04, Debian 11/12"
  exit 1
fi

echo "โ ะะฐัะตัะตะฝะฐ ะฟะพะดะดััะถะฐะฝะฐ ะะก: $PRETTY_NAME"
echo ""
echo ""

# ะกะะะฆะะฏ 2: ะัะพะฒะตัะบะฐ ะดะฐะปะธ ัะบัะธะฟััั ัะต ะฑัะดะต ััะฐััะธัะฐะฝ ะฝะฐ ะฟัะฐะฒะธะปะฝะธั ัััะฒัั.
while true; do
  printf "๐ ะัะฒะตะดะตัะต ะฟัะฑะปะธัะฝะธั IP ะฐะดัะตั ะฝะฐ ัััะฒััะฐ (ะธะปะธ 'q' ะทะฐ ะธะทัะพะด): "
  read SERVER_IP

  if [[ "$SERVER_IP" == "q" || "$SERVER_IP" == "Q" ]]; then
    echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
    exit 0
  fi

  # ะัะพะฒะตัะบะฐ ะทะฐ ะฒะฐะปะธะดะตะฝ IPv4 ัะพัะผะฐั
  if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "โ ะะตะฒะฐะปะธะดะตะฝ IP ะฐะดัะตั. ะะพะปั, ะฒัะฒะตะดะตัะต ะฒะฐะปะธะดะตะฝ IPv4 ะฐะดัะตั (ะฟัะธะผะตั: 192.168.1.100)."
    continue
  fi

  # ะะทะฒะปะธัะฐะฝะต ะฝะฐ ัะตะฐะปะฝะธั ะฟัะฑะปะธัะตะฝ IP
  ACTUAL_IP=$(curl -s -4 ifconfig.me)

  if [[ "$ACTUAL_IP" != "$SERVER_IP" ]]; then
    echo ""
    echo "๐ซ ะะตััะพัะฒะตัััะฒะธะต! ะัะฒะตะดะตะฝะธัั IP ($SERVER_IP) ะฝะต ััะฒะฟะฐะดะฐ ั ัะตะฐะปะฝะธั IP ะฝะฐ ะผะฐัะธะฝะฐัะฐ ($ACTUAL_IP)."
    echo ""
    read -p "๐ ะัะบะฐัะต ะปะธ ะดะฐ ะพะฟะธัะฐัะต ะพัะฝะพะฒะพ? [Enter ะทะฐ ะะ, 'q' ะทะฐ ะธะทัะพะด]: " retry
    if [[ "$retry" == "q" || "$retry" == "Q" ]]; then
      echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
      exit 0
    fi
    echo ""
  else
    echo "โ ะะพัะฒััะดะตะฝะพ: ัะบัะธะฟััั ะต ััะฐััะธัะฐะฝ ะฝะฐ ัััะฒััะฐ ั IP $SERVER_IP."
    break
  fi
done
echo ""
echo ""

# ะกะะะฆะะฏ 3: ะัะพะฒะตัะบะฐ ะดะฐะปะธ hostname ะต ะดะพะผะตะนะฝ ะพั ััะตัะพ ะฝะธะฒะพ, ะทะฐะฟะพัะฒะฐั ั ns1, ns2 ะธะปะธ ns3.

echo "๐ ะัะพะฒะตัะบะฐ ะฝะฐ hostname..."
HOSTNAME_FQDN=$(hostname -f 2>/dev/null || echo "")

if [[ -z "$HOSTNAME_FQDN" ]]; then
  echo "โ ะะตััะฟะตัะฝะพ ะธะทะฒะปะธัะฐะฝะต ะฝะฐ ะฟัะปะฝะธั hostname (FQDN)."
  echo "ะกะบัะธะฟััั ะฝะต ะผะพะถะต ะดะฐ ะฟัะพะดัะปะถะธ ะฑะตะท ะฒะฐะปะธะดะตะฝ FQDN."
  exit 1
fi

# ะัะพะฒะตัะบะฐ ะทะฐ ััะตัะพ ะฝะธะฒะพ ะธ ะฟัะตัะธะบั ns1/ns2/ns3
if [[ ! "$HOSTNAME_FQDN" =~ ^ns[1-3]\..+\..+$ ]]; then
  echo ""
  echo "๐ซ ะะตััะฒะผะตััะธะผ ะธะปะธ ะฝะตะดะพะฟัััะธะผ ะดะพะผะตะนะฝ: $HOSTNAME_FQDN"
  echo ""
  echo "โน๏ธ ะขะพะทะธ ัะบัะธะฟั ะต ะฟัะตะดะฝะฐะทะฝะฐัะตะฝ ะทะฐ ะบะพะฝัะธะณััะธัะฐะฝะต ะฝะฐ DNS ัััะฒััะธ, ัะฐะฑะพัะตัะธ ะฒ ะผัะตะถะฐัะฐ NetGalaxy"
  echo "ะธะปะธ ะพะฑัะปัะถะฒะฐัะธ ะฟะปะฐััะพัะผะฐัะฐ NetGalaxy. ะัะฒะตะดะตะฝะธัั hostname ะฝะต ะพัะณะพะฒะฐัั ะฝะฐ ะธะทะธัะบะฒะฐะฝะธััะฐ."
  echo ""
  exit 1
fi

echo "โ ะะพัะฒััะดะตะฝะพ: hostname ะพัะณะพะฒะฐัั ะฝะฐ ะธะทะธัะบะฒะฐะฝะธััะฐ ($HOSTNAME_FQDN)."
echo ""








# --- ะัะพะฒะตัะบะฐ ะดะฐะปะธ ัะบัะธะฟััั ะฒะตัะต ะต ะธะทะฟัะปะฝะตะฝ ััะฟะตัะฝะพ ---
if [[ -f "$SETUP_ENV_FILE" ]] && sudo grep -q '^SETUP_VPS_BASE_STATUS=โ' "$SETUP_ENV_FILE"; then
  echo "๐ ะขะพะทะธ ัะบัะธะฟั ะฒะตัะต ะต ะฑะธะป ะธะทะฟัะปะฝะตะฝ ััะฟะตัะฝะพ ะฝะฐ ัะพะทะธ ัััะฒัั."
  echo "ะะพะฒัะพัะฝะพ ะธะทะฟัะปะฝะตะฝะธะต ะฝะต ะต ะฟะพะทะฒะพะปะตะฝะพ, ะทะฐ ะดะฐ ัะต ะธะทะฑะตะณะฝะต ะฟะพะฒัะตะดะฐ ะฝะฐ ัะธััะตะผะฐัะฐ."
  [[ -f "$0" ]] && sudo rm -- "$0"
  exit 0
fi



# --- ะัะพะฒะตัะบะฐ ะดะฐะปะธ IP ะฒะตัะต ะต ะฟะพัะฒััะดะตะฝ ---
if sudo grep -q "^RESULT_IP_CHECK=โ" "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "๐ ะัะพะฟััะบะฐะฝะต (IP ะฐะดัะตััั ะฒะตัะต ะต ะฟะพัะฒััะดะตะฝ)..."
  echo ""
else
 
