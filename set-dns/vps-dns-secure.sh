#!/bin/bash
# ==========================================================================
#  vps-dns-secure.sh ‚Äì –ü–æ–¥—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9)
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-22
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤—è –º–µ—Ä–∫–∏ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç –≤—ä—Ä—Ö—É –≤–µ—á–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω DNS —Å—ä—Ä–≤—ä—Ä
#  (Bind9), —Å–ª–µ–¥ –∫–∞—Ç–æ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —Å–∫—Ä–∏–ø—Ç—ä—Ç vps-dns-qsetup.sh.
#
#  –°–∫—Ä–∏–ø—Ç—ä—Ç –µ –º–æ–¥—É–ª–µ–Ω –∏ –∏–∑–ø—ä–ª–Ω—è–≤–∞ —Å–ª–µ–¥–Ω–∏—Ç–µ —Å—Ç—ä–ø–∫–∏:
#    1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ (OS, IP, FQDN, –ø—Ä–µ–¥–∏—à–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ)
#    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Å–∏–≥—É—Ä—è–≤–∞–Ω–µ –Ω–∞ –±–∞–∑–æ–≤–∏ –ø–æ–ª–∏—Ç–∏–∫–∏
#    3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ ACL (Access Control Lists)
#    4. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –∏ –≤–Ω–µ–¥—Ä—è–≤–∞–Ω–µ –Ω–∞ TSIG –∫–ª—é—á–æ–≤–µ
#    5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç –Ω–∞ Bind9
#    6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω —Ç–µ—Å—Ç –∑–∞ TSIG —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
#    7. –§–∏–Ω–∞–ª–µ–Ω –æ—Ç—á–µ—Ç –∏ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
# ==========================================================================
#
# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo ""
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-dns-secure.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–æ –ø–æ–¥—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9)."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
  echo ""
  echo "–ó–∞–±–µ–ª–µ–∂–∫–∞: –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ –¥–∞ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω vps-dns-qsetup.sh –ø—Ä–µ–¥–∏ –Ω–µ–≥–æ."
  echo ""
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-dns-secure.sh –≤–µ—Ä—Å–∏—è 1.0 (22 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi


# =====================================================================
# vps-dns-secure.sh ‚Äì –°–∫—Ä–∏–ø—Ç –∑–∞ –ø–æ–¥—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ DNS (Bind9)
# –ß–∞—Å—Ç –æ—Ç NetGalaxySoft DevOps Tools
# =====================================================================

echo ""
echo -e "\e[32m=========================================="
echo -e "      DNS SECURITY HARDENING (BIND9)"
echo -e "==========================================\e[0m"
echo ""

# –û—Å–Ω–æ–≤–Ω–∏ –ø—ä—Ç–∏—â–∞ –∏ —Ñ–∞–π–ª–æ–≤–µ
NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

# =====================================================================
# [–ú–û–î–£–õ 1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò
# =====================================================================
echo "[1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò..."
echo "-----------------------------------------------------------"
echo ""

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Ñ–∞–π–ª–æ–≤–µ
NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –±–∞–∑–æ–≤–∞ DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -------------------------------------------------------------------------------------
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! sudo grep -q '^SETUP_VPS_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "üõë –ù–µ –µ –æ—Ç–∫—Ä–∏—Ç–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ –±–∞–∑–æ–≤–∞ DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è."
  echo "‚ÑπÔ∏è –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ø—ä—Ä–≤–æ —Å–∫—Ä–∏–ø—Ç–∞ vps-dns-qsetup.sh –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  echo "üóëÔ∏è –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
  [[ -f "$0" ]] && sudo rm -- "$0"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∑–∞—â–∏—Ç–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–µ—á–µ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞
if sudo grep -q '^SETUP_SECURE_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "üõë –°–∫—Ä–∏–ø—Ç—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω (DNS —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–∞)."
  echo "üóëÔ∏è –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
  [[ -f "$0" ]] && sudo rm -- "$0"
  exit 0
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –ú–æ–¥—É–ª 1 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if sudo grep -q '^SECURE_DNS_MODULE1=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 1 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞..."
  if [[ -f /etc/os-release ]]; then
    source /etc/os-release
    OS_NAME=$ID
    OS_VERSION=$VERSION_ID
  else
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –û–°. –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ Ubuntu –∏–ª–∏ Debian."
    exit 1
  fi

  SUPPORTED=false
  if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
    SUPPORTED=true
  elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
    SUPPORTED=true
  fi

  if [[ "$SUPPORTED" == false ]]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ $PRETTY_NAME –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞."
    echo "–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏: Ubuntu 22.04/24.04, Debian 11/12"
    exit 1
  fi

  echo "‚úÖ –ó–∞—Å–µ—á–µ–Ω–∞ –ø–æ–¥–¥—ä—Ä–∂–∞–Ω–∞ –û–°: $PRETTY_NAME"
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ IP –∞–¥—Ä–µ—Å–∞
  # -------------------------------------------------------------------------------------
  while true; do
    printf "üåê –í—ä–≤–µ–¥–µ—Ç–µ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): "
    read SERVER_IP

    if [[ "$SERVER_IP" == "q" || "$SERVER_IP" == "Q" ]]; then
      echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    fi

    if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω IPv4."
      continue
    fi

    ACTUAL_IP=$(curl -s -4 ifconfig.me)
    if [[ "$ACTUAL_IP" != "$SERVER_IP" ]]; then
      echo "üö´ –ù–µ—Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ! –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç IP –Ω–µ —Å—ä–≤–ø–∞–¥–∞ —Å —Ä–µ–∞–ª–Ω–∏—è IP."
      read -p "üîÅ –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –æ–ø–∏—Ç–∞—Ç–µ –æ—Ç–Ω–æ–≤–æ? [Enter –∑–∞ –î–ê, 'q' –∑–∞ –∏–∑—Ö–æ–¥]: " retry
      [[ "$retry" == "q" || "$retry" == "Q" ]] && exit 0
      echo ""
    else
      echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: IP $SERVER_IP –µ –≤–∞–ª–∏–¥–Ω–æ."
      break
    fi
  done
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hostname
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hostname..."
  HOSTNAME_FQDN=$(hostname -f 2>/dev/null || echo "")

  if [[ -z "$HOSTNAME_FQDN" ]]; then
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ FQDN. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: hostname = $HOSTNAME_FQDN"
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –≤ todo.modules
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$MODULES_FILE" ]]; then
    sudo touch "$MODULES_FILE"
  fi

  # SERVER_IP
  if sudo grep -q '^SERVER_IP=' "$MODULES_FILE" 2>/dev/null; then
    sudo sed -i "s|^SERVER_IP=.*|SERVER_IP=\"$SERVER_IP\"|" "$MODULES_FILE"
  else
    echo "SERVER_IP=\"$SERVER_IP\"" | sudo tee -a "$MODULES_FILE" > /dev/null
  fi

  # SERVER_FQDN
  if sudo grep -q '^SERVER_FQDN=' "$MODULES_FILE" 2>/dev/null; then
    sudo sed -i "s|^SERVER_FQDN=.*|SERVER_FQDN=\"$HOSTNAME_FQDN\"|" "$MODULES_FILE"
  else
    echo "SERVER_FQDN=\"$HOSTNAME_FQDN\"" | sudo tee -a "$MODULES_FILE" > /dev/null
  fi

  echo "‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ –≤ $MODULES_FILE."
  echo ""

  # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –ú–æ–¥—É–ª 1
  if sudo grep -q '^SECURE_DNS_MODULE1=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^SECURE_DNS_MODULE1=.*|SECURE_DNS_MODULE1=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "SECURE_DNS_MODULE1=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "‚úÖ –ú–æ–¥—É–ª 1 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
  echo ""
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 2] –ü–û–î–°–ò–ì–£–†–Ø–í–ê–ù–ï –ù–ê –ë–ê–ó–û–í–ò –ü–û–õ–ò–¢–ò–ö–ò
# =====================================================================
echo "[2] –ü–û–î–°–ò–ì–£–†–Ø–í–ê–ù–ï –ù–ê –ë–ê–ó–û–í–ò –ü–û–õ–ò–¢–ò–ö–ò..."
echo "-----------------------------------------------------------"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if sudo grep -q '^SECURE_DNS_MODULE2=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 2 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞–Ω–µ –Ω–∞ named.conf.options
  # -------------------------------------------------------------------------------------
  OPTIONS_FILE="/etc/bind/named.conf.options"
  if [[ ! -f "$OPTIONS_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ —Ñ–∞–π–ª—ä—Ç $OPTIONS_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "‚úÖ –§–∞–π–ª—ä—Ç $OPTIONS_FILE –µ –æ—Ç–∫—Ä–∏—Ç."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ named.conf.options
  # -------------------------------------------------------------------------------------
  echo "üîß –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç –≤ $OPTIONS_FILE..."

  # –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ —Å—Ç–∞—Ä–∏ –¥–∏—Ä–µ–∫—Ç–∏–≤–∏ (–∞–∫–æ –ø—Ä–∏—Å—ä—Å—Ç–≤–∞—Ç —Å —Ä–∞–∑–ª–∏—á–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏)
  sudo sed -i '/recursion/d' "$OPTIONS_FILE"
  sudo sed -i '/allow-transfer/d' "$OPTIONS_FILE"
  sudo sed -i '/allow-recursion/d' "$OPTIONS_FILE"

  # –î–æ–±–∞–≤—è–º–µ –Ω—É–∂–Ω–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–∏–≤–∏ (–∞–∫–æ –≥–∏ –Ω—è–º–∞)
  sudo sed -i '/options {/,/};/ {
    /^};/i\    recursion no;
    /^};/i\    allow-transfer { none; };
    /^};/i\    dnssec-validation auto;
  }' "$OPTIONS_FILE"

  echo "‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏—Ç–µ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏: recursion=no, allow-transfer=none, dnssec-validation=auto."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
  if ! sudo named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ Bind9 —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞
  # -------------------------------------------------------------------------------------
  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  sudo systemctl restart bind9
  if ! systemctl is-active --quiet bind9; then
    echo "‚ùå –£—Å–ª—É–≥–∞—Ç–∞ Bind9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –ú–æ–¥—É–ª 2
  # -------------------------------------------------------------------------------------
  if sudo grep -q '^SECURE_DNS_MODULE2=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^SECURE_DNS_MODULE2=.*|SECURE_DNS_MODULE2=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "SECURE_DNS_MODULE2=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "‚úÖ –ú–æ–¥—É–ª 2 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
  echo ""
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 3] ACL –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û IP
# =====================================================================
echo "[3] ACL –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û IP..."
echo "-----------------------------------------------------------"
echo ""

if sudo grep -q '^SECURE_DNS_MODULE3=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 3 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ç–µ–∫—É—â–∏ –¥–∞–Ω–Ω–∏
  # -------------------------------------------------------------------------------------
  SERVER_IP=""
  SECOND_DNS_IP=""
  DNS_ROLE=""

  # –ê–∫–æ —Ñ–∞–π–ª—ä—Ç —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ ‚Üí —á–µ—Ç–µ–º
  if [[ -f "$MODULES_FILE" ]]; then
    SERVER_IP=$(grep '^SERVER_IP=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
    SECOND_DNS_IP=$(grep '^SECOND_DNS_IP=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
    DNS_ROLE=$(grep '^DNS_ROLE=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
  else
    sudo touch "$MODULES_FILE"
  fi

  # –ê–∫–æ –ª–∏–ø—Å–≤–∞ SERVER_IP ‚Üí –∏–∑–∏—Å–∫–≤–∞–º–µ
  if [[ -z "$SERVER_IP" ]]; then
    read -p "üåê –í—ä–≤–µ–¥–µ—Ç–µ –ø—É–±–ª–∏—á–Ω–∏—è IP –Ω–∞ —Ç–æ–∑–∏ DNS —Å—ä—Ä–≤—ä—Ä: " SERVER_IP
    if [[ -z "$SERVER_IP" ]]; then
      echo "‚ùå SERVER_IP –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω."
      exit 1
    fi
    if sudo grep -q '^SERVER_IP=' "$MODULES_FILE" 2>/dev/null; then
      sudo sed -i "s|^SERVER_IP=.*|SERVER_IP=\"$SERVER_IP\"|" "$MODULES_FILE"
    else
      echo "SERVER_IP=\"$SERVER_IP\"" | sudo tee -a "$MODULES_FILE" > /dev/null
    fi
  fi

  # –ê–∫–æ –ª–∏–ø—Å–≤–∞ SECOND_DNS_IP ‚Üí –∏–∑–∏—Å–∫–≤–∞–º–µ
  if [[ -z "$SECOND_DNS_IP" ]]; then
    read -p "üåê –í—ä–≤–µ–¥–µ—Ç–µ IP –Ω–∞ –¥—Ä—É–≥–∏—è DNS —Å—ä—Ä–≤—ä—Ä: " SECOND_DNS_IP
    if [[ -z "$SECOND_DNS_IP" ]]; then
      echo "‚ùå SECOND_DNS_IP –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω."
      exit 1
    fi
    if sudo grep -q '^SECOND_DNS_IP=' "$MODULES_FILE" 2>/dev/null; then
      sudo sed -i "s|^SECOND_DNS_IP=.*|SECOND_DNS_IP=\"$SECOND_DNS_IP\"|" "$MODULES_FILE"
    else
      echo "SECOND_DNS_IP=\"$SECOND_DNS_IP\"" | sudo tee -a "$MODULES_FILE" > /dev/null
    fi
  fi

  # –ê–∫–æ –ª–∏–ø—Å–≤–∞ DNS_ROLE ‚Üí –æ–ø—Ä–µ–¥–µ–ª—è–º–µ –ø–æ hostname
  if [[ -z "$DNS_ROLE" ]]; then
    HOSTNAME_FQDN=$(hostname -f 2>/dev/null || echo "")
    if [[ "$HOSTNAME_FQDN" =~ ^ns1\. ]]; then
      DNS_ROLE="primary"
    elif [[ "$HOSTNAME_FQDN" =~ ^ns[23]\. ]]; then
      DNS_ROLE="secondary"
    else
      echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ DNS_ROLE (hostname=$HOSTNAME_FQDN)."
      exit 1
    fi
    if sudo grep -q '^DNS_ROLE=' "$MODULES_FILE" 2>/dev/null; then
      sudo sed -i "s|^DNS_ROLE=.*|DNS_ROLE=\"$DNS_ROLE\"|" "$MODULES_FILE"
    else
      echo "DNS_ROLE=\"$DNS_ROLE\"" | sudo tee -a "$MODULES_FILE" > /dev/null
    fi
  fi

  echo "‚úÖ –î–∞–Ω–Ω–∏ –∑–∞ ACL: SERVER_IP=$SERVER_IP | SECOND_DNS_IP=$SECOND_DNS_IP | DNS_ROLE=$DNS_ROLE"
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ named.conf.options
  # -------------------------------------------------------------------------------------
  OPTIONS_FILE="/etc/bind/named.conf.options"
  if [[ ! -f "$OPTIONS_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ $OPTIONS_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "üîß –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ ACL 'trusted' –≤ $OPTIONS_FILE..."
  sudo sed -i '/acl "trusted"/,/};/d' "$OPTIONS_FILE"
  sudo sed -i "1i acl \"trusted\" {\n    $SERVER_IP;\n    $SECOND_DNS_IP;\n};\n" "$OPTIONS_FILE"

  sudo sed -i '/allow-transfer/d' "$OPTIONS_FILE"
  sudo sed -i '/options {/,/};/ {
    /^};/i\    allow-transfer { trusted; };
  }' "$OPTIONS_FILE"

  if [[ "$DNS_ROLE" == "primary" ]]; then
    sudo sed -i '/also-notify/d' "$OPTIONS_FILE"
    sudo sed -i '/options {/,/};/ {
      /^};/i\    also-notify { '"$SECOND_DNS_IP"'; };
    }' "$OPTIONS_FILE"
  fi

  echo "‚úÖ ACL –¥–æ–±–∞–≤–µ–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
  if ! sudo named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω."

  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  sudo systemctl restart bind9
  if ! systemctl is-active --quiet bind9; then
    echo "‚ùå Bind9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
  # -------------------------------------------------------------------------------------
  if sudo grep -q '^SECURE_DNS_MODULE3=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^SECURE_DNS_MODULE3=.*|SECURE_DNS_MODULE3=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "SECURE_DNS_MODULE3=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "‚úÖ –ú–æ–¥—É–ª 3 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""






exit 0


# =====================================================================
# [–ú–û–î–£–õ 4] –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê TSIG –ö–õ–Æ–ß
# =====================================================================
echo "[4] –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê TSIG –ö–õ–Æ–ß..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ TSIG –∫–ª—é—á —Å tsig-keygen (hmac-sha256).
# - –ó–∞–ø–∏—Å–≤–∞–Ω–µ –≤ /etc/bind/keys/tsig.key.
# - –î–æ–±–∞–≤—è–Ω–µ –≤ named.conf.local –∏ –∑–æ–Ω–∏—Ç–µ.
echo ""
echo ""

# =====================================================================
# [–ú–û–î–£–õ 5] –ü–†–û–í–ï–†–ö–ê –ò –†–ï–°–¢–ê–†–¢
# =====================================================================
echo "[5] –ü–†–û–í–ï–†–ö–ê –ò –†–ï–°–¢–ê–†–¢..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å named-checkconf.
# - –†–µ—Å—Ç–∞—Ä—Ç –Ω–∞ bind9.
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —É—Å–ª—É–≥–∞—Ç–∞ –µ –∞–∫—Ç–∏–≤–Ω–∞.
echo ""
echo ""

# =====================================================================
# [–ú–û–î–£–õ 6] –¢–ï–°–¢ –ù–ê TSIG
# =====================================================================
echo "[6] –¢–ï–°–¢ –ù–ê TSIG..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - –ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ dig –∑–∞ —Ç–µ—Å—Ç–æ–≤ AXFR —Å—ä—Å —Å–µ–∫—Ä–µ—Ç–µ–Ω –∫–ª—é—á.
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≥—Ä–µ—à–∫–∏ –≤ –ª–æ–≥–æ–≤–µ—Ç–µ.
echo ""
echo ""

# =====================================================================
# [–ú–û–î–£–õ 7] –§–ò–ù–ê–õ–ï–ù –û–¢–ß–ï–¢
# =====================================================================
echo "[7] –§–ò–ù–ê–õ–ï–ù –û–¢–ß–ï–¢..."
echo "-----------------------------------------------------------"
echo ""
# TODO:
# - –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –≤—Å–∏—á–∫–∏ –º–æ–¥—É–ª–∏.
# - –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
# - –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ –∏ (–ø–æ –∏–∑–±–æ—Ä) —Å–∫—Ä–∏–ø—Ç–∞.
echo ""
echo ""

echo "‚úÖ –®–∞–±–ª–æ–Ω—ä—Ç –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ –µ –≥–æ—Ç–æ–≤. –ü–æ–ø—ä–ª–Ω–µ—Ç–µ –º–æ–¥—É–ª–∏—Ç–µ —Å —Ä–µ–∞–ª–Ω–∞ –ª–æ–≥–∏–∫–∞."
