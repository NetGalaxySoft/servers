#!/bin/bash
# ==========================================================================
#  vps-dns-secure.sh ‚Äì –ü–æ–¥—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9)
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-22
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤—è –º–µ—Ä–∫–∏ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç –≤—ä—Ä—Ö—É –≤–µ—á–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω DNS —Å—ä—Ä–≤—ä—Ä
#  (Bind9), —Å–ª–µ–¥ –∫–∞—Ç–æ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —Å–∫—Ä–∏–ø—Ç—ä—Ç vps-dns-qsetup.sh.
#
#  –°–∫—Ä–∏–ø—Ç—ä—Ç –µ –º–æ–¥—É–ª–µ–Ω –∏ –∏–∑–ø—ä–ª–Ω—è–≤–∞ —Å–ª–µ–¥–Ω–∏—Ç–µ —Å—Ç—ä–ø–∫–∏:
#    1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ (OS, IP, FQDN, –ø—Ä–µ–¥–∏—à–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ)
#    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Å–∏–≥—É—Ä—è–≤–∞–Ω–µ –Ω–∞ –±–∞–∑–æ–≤–∏ –ø–æ–ª–∏—Ç–∏–∫–∏
#    3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ ACL (Access Control Lists)
#    4. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –∏ –≤–Ω–µ–¥—Ä—è–≤–∞–Ω–µ –Ω–∞ TSIG –∫–ª—é—á–æ–≤–µ
#    5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç –Ω–∞ Bind9
#    6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω —Ç–µ—Å—Ç –∑–∞ TSIG —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
#    7. –§–∏–Ω–∞–ª–µ–Ω –æ—Ç—á–µ—Ç –∏ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
# ==========================================================================
#
# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo ""
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-dns-secure.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–æ –ø–æ–¥—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ DNS —Å—ä—Ä–≤—ä—Ä (Bind9)."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
  echo ""
  echo "–ó–∞–±–µ–ª–µ–∂–∫–∞: –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ –¥–∞ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω vps-dns-qsetup.sh –ø—Ä–µ–¥–∏ –Ω–µ–≥–æ."
  echo ""
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-dns-secure.sh –≤–µ—Ä—Å–∏—è 1.0 (22 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi


# =====================================================================
# vps-dns-secure.sh ‚Äì –°–∫—Ä–∏–ø—Ç –∑–∞ –ø–æ–¥—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ DNS (Bind9)
# –ß–∞—Å—Ç –æ—Ç NetGalaxySoft DevOps Tools
# =====================================================================

echo ""
echo -e "\e[32m=========================================="
echo -e "      DNS SECURITY HARDENING (BIND9)"
echo -e "==========================================\e[0m"
echo ""

# –û—Å–Ω–æ–≤–Ω–∏ –ø—ä—Ç–∏—â–∞ –∏ —Ñ–∞–π–ª–æ–≤–µ
NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

# =====================================================================
# [–ú–û–î–£–õ 1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò
# =====================================================================
echo "[1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
MODULES_FILE="/etc/netgalaxy/todo.modules"

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –±–∞–∑–æ–≤–∞ DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -------------------------------------------------------------------------------------
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! grep -q '^SETUP_VPS_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "üõë –ù–µ –µ –æ—Ç–∫—Ä–∏—Ç–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ –±–∞–∑–æ–≤–∞ DNS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è."
  echo "‚ÑπÔ∏è –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ø—ä—Ä–≤–æ —Å–∫—Ä–∏–ø—Ç–∞ vps-dns-qsetup.sh –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  echo "üóëÔ∏è –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
  rm -- "$0"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∑–∞—â–∏—Ç–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–µ—á–µ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞
if grep -q '^SETUP_SECURE_DNS_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "üõë –°–∫—Ä–∏–ø—Ç—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω (DNS —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–∞)."
  echo "üóëÔ∏è –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
  rm -- "$0"
  exit 0
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –ú–æ–¥—É–ª 1 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if grep -q '^SECURE_DNS_MODULE1=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 1 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞..."
  if [[ -f /etc/os-release ]]; then
    source /etc/os-release
    OS_NAME=$ID
    OS_VERSION=$VERSION_ID
  else
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –û–°. –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ Ubuntu –∏–ª–∏ Debian."
    exit 1
  fi

  SUPPORTED=false
  if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
    SUPPORTED=true
  elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
    SUPPORTED=true
  fi

  if [[ "$SUPPORTED" == false ]]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ $PRETTY_NAME –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞."
    echo "–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏: Ubuntu 22.04/24.04, Debian 11/12"
    exit 1
  fi

  echo "‚úÖ –ó–∞—Å–µ—á–µ–Ω–∞ –ø–æ–¥–¥—ä—Ä–∂–∞–Ω–∞ –û–°: $PRETTY_NAME"
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ IP –∞–¥—Ä–µ—Å–∞
  # -------------------------------------------------------------------------------------
  while true; do
    printf "üåê –í—ä–≤–µ–¥–µ—Ç–µ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): "
    read SERVER_IP

    if [[ "$SERVER_IP" == "q" || "$SERVER_IP" == "Q" ]]; then
      echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    fi

    if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω IPv4."
      continue
    fi

    ACTUAL_IP=$(curl -s -4 ifconfig.me)
    if [[ -z "$ACTUAL_IP" ]]; then
      echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ —Ä–µ–∞–ª–µ–Ω IP (curl ifconfig.me)."
      exit 1
    fi

    if [[ "$ACTUAL_IP" != "$SERVER_IP" ]]; then
      echo "üö´ –ù–µ—Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ! –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç IP –Ω–µ —Å—ä–≤–ø–∞–¥–∞ —Å —Ä–µ–∞–ª–Ω–∏—è IP."
      read -p "üîÅ –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –æ–ø–∏—Ç–∞—Ç–µ –æ—Ç–Ω–æ–≤–æ? [Enter –∑–∞ –î–ê, 'q' –∑–∞ –∏–∑—Ö–æ–¥]: " retry
      [[ "$retry" == "q" || "$retry" == "Q" ]] && exit 0
      echo ""
    else
      echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: IP $SERVER_IP –µ –≤–∞–ª–∏–¥–Ω–æ."
      break
    fi
  done
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hostname
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hostname..."
  HOSTNAME_FQDN=$(hostname -f 2>/dev/null || echo "")

  if [[ -z "$HOSTNAME_FQDN" ]]; then
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ FQDN. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: hostname = $HOSTNAME_FQDN"
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –≤ todo.modules
  # -------------------------------------------------------------------------------------
  touch "$MODULES_FILE"

  grep -q '^SERVER_IP=' "$MODULES_FILE" && sed -i "s|^SERVER_IP=.*|SERVER_IP=\"$SERVER_IP\"|" "$MODULES_FILE" || echo "SERVER_IP=\"$SERVER_IP\"" >> "$MODULES_FILE"
  grep -q '^SERVER_FQDN=' "$MODULES_FILE" && sed -i "s|^SERVER_FQDN=.*|SERVER_FQDN=\"$HOSTNAME_FQDN\"|" "$MODULES_FILE" || echo "SERVER_FQDN=\"$HOSTNAME_FQDN\"" >> "$MODULES_FILE"

  echo "‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ –≤ $MODULES_FILE."
  echo ""

  # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –ú–æ–¥—É–ª 1
  grep -q '^SECURE_DNS_MODULE1=' "$SETUP_ENV_FILE" && sed -i 's|^SECURE_DNS_MODULE1=.*|SECURE_DNS_MODULE1=‚úÖ|' "$SETUP_ENV_FILE" || echo "SECURE_DNS_MODULE1=‚úÖ" >> "$SETUP_ENV_FILE"

  echo "‚úÖ –ú–æ–¥—É–ª 1 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
  echo ""
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 2] –ü–û–î–°–ò–ì–£–†–Ø–í–ê–ù–ï –ù–ê –ë–ê–ó–û–í–ò –ü–û–õ–ò–¢–ò–ö–ò
# =====================================================================
echo "[2] –ü–û–î–°–ò–ì–£–†–Ø–í–ê–ù–ï –ù–ê –ë–ê–ó–û–í–ò –ü–û–õ–ò–¢–ò–ö–ò..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
OPTIONS_FILE="/etc/bind/named.conf.options"

if [[ ! -f "$SETUP_ENV_FILE" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ $SETUP_ENV_FILE. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ú–æ–¥—É–ª 1 –ø—ä—Ä–≤–æ."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if grep -q '^SECURE_DNS_MODULE2=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 2 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 2..."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞–Ω–µ –Ω–∞ named.conf.options
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$OPTIONS_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ —Ñ–∞–π–ª—ä—Ç $OPTIONS_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "‚úÖ –§–∞–π–ª—ä—Ç $OPTIONS_FILE –µ –æ—Ç–∫—Ä–∏—Ç."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ named.conf.options
  # -------------------------------------------------------------------------------------
  echo "üîß –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç –≤ $OPTIONS_FILE..."

  sed -i '/options {/,/};/ {
    /recursion/d
    /allow-transfer/d
    /allow-recursion/d
    /dnssec-validation/d
  }' "$OPTIONS_FILE"

  sed -i '/options {/,/};/ {
    /^};/i\    recursion no;
    /^};/i\    allow-transfer { none; };
    /^};/i\    dnssec-validation auto;
  }' "$OPTIONS_FILE"

  echo "‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏—Ç–µ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏: recursion=no, allow-transfer=none, dnssec-validation=auto."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
  if ! named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ Bind9 —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞
  # -------------------------------------------------------------------------------------
  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  systemctl restart bind9
  if ! systemctl is-active --quiet bind9; then
    echo "‚ùå –£—Å–ª—É–≥–∞—Ç–∞ Bind9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –ú–æ–¥—É–ª 2
  # -------------------------------------------------------------------------------------
  grep -q '^SECURE_DNS_MODULE2=' "$SETUP_ENV_FILE" && sed -i 's|^SECURE_DNS_MODULE2=.*|SECURE_DNS_MODULE2=‚úÖ|' "$SETUP_ENV_FILE" || echo "SECURE_DNS_MODULE2=‚úÖ" >> "$SETUP_ENV_FILE"

  echo "‚úÖ –ú–æ–¥—É–ª 2 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
  echo ""
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 3] ACL –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û IP
# =====================================================================
echo "[3] ACL –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û IP..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
MODULES_FILE="/etc/netgalaxy/todo.modules"
OPTIONS_FILE="/etc/bind/named.conf.options"

if grep -q '^SECURE_DNS_MODULE3=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 3 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 3..."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$MODULES_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ $MODULES_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  if ! command -v dig &>/dev/null; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ –∫–æ–º–∞–Ω–¥–∞—Ç–∞ dig. –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –ø–∞–∫–µ—Ç dnsutils."
    exit 1
  fi

  SERVER_IP=$(hostname -I | awk '{print $1}')
  SERVER_FQDN=$(grep '^SERVER_FQDN=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
  DNS_ROLE=$(grep '^DNS_ROLE=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')

  if [[ -z "$SERVER_FQDN" ]]; then
    SERVER_FQDN=$(hostname -f 2>/dev/null || echo "")
  fi

  if [[ -z "$DNS_ROLE" ]]; then
    if [[ "$SERVER_FQDN" =~ ^ns1\. ]]; then
      DNS_ROLE="primary"
    elif [[ "$SERVER_FQDN" =~ ^ns[23]\. ]]; then
      DNS_ROLE="secondary"
    fi
  fi

  if [[ -z "$SERVER_FQDN" || -z "$DNS_ROLE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞—Ç SERVER_FQDN –∏–ª–∏ DNS_ROLE –∏ –Ω–µ –º–æ–≥–∞—Ç –¥–∞ —Å–µ –æ–ø—Ä–µ–¥–µ–ª—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ."
    exit 1
  fi

  DOMAIN=$(echo "$SERVER_FQDN" | cut -d '.' -f2-)
  SECOND_DNS_IP=$(dig +short ns2.$DOMAIN A | tail -n 1)

  if [[ -z "$SECOND_DNS_IP" ]]; then
    echo "‚ùå –ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∏–∑–≤–ª–µ—á–µ IP –∑–∞ ns2.$DOMAIN."
    echo "‚û° –î–æ–±–∞–≤–µ—Ç–µ –≥–æ —Ä—ä—á–Ω–æ –≤ $MODULES_FILE:"
    echo "SECOND_DNS_IP=\"xxx.xxx.xxx.xxx\""
    exit 1
  fi

  if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå SERVER_IP ($SERVER_IP) –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω IPv4."
    exit 1
  fi
  if ! [[ "$SECOND_DNS_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå SECOND_DNS_IP ($SECOND_DNS_IP) –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω IPv4."
    exit 1
  fi

  echo "‚úÖ –ó–∞—Ä–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏:"
  echo "SERVER_IP=$SERVER_IP"
  echo "SERVER_FQDN=$SERVER_FQDN"
  echo "SECOND_DNS_IP=$SECOND_DNS_IP"
  echo "DNS_ROLE=$DNS_ROLE"
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ named.conf.options
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$OPTIONS_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ $OPTIONS_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  echo "üîß –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ ACL 'trusted' –∏ –ø–æ–ª–∏—Ç–∏–∫–∏..."
  sed -i '/acl "trusted"/,/};/d' "$OPTIONS_FILE"
  sed -i "1i acl \"trusted\" {\n    $SERVER_IP;\n    $SECOND_DNS_IP;\n};\n" "$OPTIONS_FILE"

  sed -i '/allow-transfer/d' "$OPTIONS_FILE"
  sed -i '/options {/,/};/ {
    /^};/i\    allow-transfer { trusted; };
  }' "$OPTIONS_FILE"

  if [[ "$DNS_ROLE" == "primary" ]]; then
    sed -i '/also-notify/d' "$OPTIONS_FILE"
    sed -i '/options {/,/};/ {
      /^};/i\    also-notify { '"$SECOND_DNS_IP"'; };
    }' "$OPTIONS_FILE"
  fi

  echo "‚úÖ ACL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
  if ! named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω."

  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  systemctl restart bind9
  if ! systemctl is-active --quiet bind9; then
    echo "‚ùå Bind9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ó–∞–ø–∏—Å –≤ todo.modules
  # -------------------------------------------------------------------------------------
  touch "$MODULES_FILE"
  for VAR in SERVER_IP SECOND_DNS_IP SERVER_FQDN DNS_ROLE; do
    VALUE=$(eval echo "\$$VAR")
    grep -q "^$VAR=" "$MODULES_FILE" && sed -i "s|^$VAR=.*|$VAR=\"$VALUE\"|" "$MODULES_FILE" || echo "$VAR=\"$VALUE\"" >> "$MODULES_FILE"
  done

  echo "‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ –≤ $MODULES_FILE."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
  # -------------------------------------------------------------------------------------
  grep -q '^SECURE_DNS_MODULE3=' "$SETUP_ENV_FILE" && sed -i 's|^SECURE_DNS_MODULE3=.*|SECURE_DNS_MODULE3=‚úÖ|' "$SETUP_ENV_FILE" || echo "SECURE_DNS_MODULE3=‚úÖ" >> "$SETUP_ENV_FILE"

  echo "‚úÖ –ú–æ–¥—É–ª 3 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 4] –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê TSIG –ö–õ–Æ–ß
# =====================================================================
echo "[4] –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê TSIG –ö–õ–Æ–ß..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
KEYS_DIR="/etc/bind/keys"
TSIG_KEY_FILE="$KEYS_DIR/tsig.key"
CONF_LOCAL="/etc/bind/named.conf.local"

if grep -q '^SECURE_DNS_MODULE4=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 4 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 4..."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª—é—á–æ–≤–µ
  # -------------------------------------------------------------------------------------
  if [[ ! -d "$KEYS_DIR" ]]; then
    mkdir -p "$KEYS_DIR"
    chown bind:bind "$KEYS_DIR"
    chmod 750 "$KEYS_DIR"
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞ $KEYS_DIR –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞."
  else
    echo "‚ÑπÔ∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ç–∞ $KEYS_DIR –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
  fi

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ TSIG –∫–ª—é—á (hmac-sha256)
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$TSIG_KEY_FILE" ]]; then
    echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ TSIG –∫–ª—é—á (hmac-sha256)..."
    if command -v tsig-keygen >/dev/null 2>&1; then
      tsig-keygen -a hmac-sha256 netgalaxy-key > "$TSIG_KEY_FILE"
      chown bind:bind "$TSIG_KEY_FILE"
      chmod 640 "$TSIG_KEY_FILE"
      echo "‚úÖ TSIG –∫–ª—é—á—ä—Ç –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω –∏ –∑–∞–ø–∏—Å–∞–Ω –≤ $TSIG_KEY_FILE."
    else
      echo "‚ùå –õ–∏–ø—Å–≤–∞ tsig-keygen! –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –ø–∞–∫–µ—Ç–∞ bind9-utils –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
      exit 1
    fi
  else
    echo "‚ÑπÔ∏è TSIG –∫–ª—é—á—ä—Ç –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –≤ $TSIG_KEY_FILE."
  fi

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª—é—á–∞ –≤ named.conf.local
  # -------------------------------------------------------------------------------------
  if [[ ! -f "$CONF_LOCAL" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ $CONF_LOCAL. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  if ! grep -q "include \"$TSIG_KEY_FILE\"" "$CONF_LOCAL"; then
    echo "include \"$TSIG_KEY_FILE\";" >> "$CONF_LOCAL"
    echo "‚úÖ TSIG –∫–ª—é—á—ä—Ç –µ –≤–∫–ª—é—á–µ–Ω –≤ $CONF_LOCAL."
  else
    echo "‚ÑπÔ∏è TSIG –∫–ª—é—á—ä—Ç –≤–µ—á–µ –µ –¥–æ–±–∞–≤–µ–Ω –≤ $CONF_LOCAL."
  fi

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
  if ! named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å–ª–µ–¥ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ TSIG –∫–ª—é—á–∞."
    exit 1
  fi
  echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω."

  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  systemctl restart bind9
  if ! systemctl is-active --quiet bind9; then
    echo "‚ùå Bind9 –Ω–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏."
    exit 1
  fi
  echo "‚úÖ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 5: –ó–∞–ø–∏—Å –≤ setup.env
  # -------------------------------------------------------------------------------------
  grep -q '^SECURE_DNS_MODULE4=' "$SETUP_ENV_FILE" && sed -i 's|^SECURE_DNS_MODULE4=.*|SECURE_DNS_MODULE4=‚úÖ|' "$SETUP_ENV_FILE" || echo "SECURE_DNS_MODULE4=‚úÖ" >> "$SETUP_ENV_FILE"

  echo "‚úÖ –ú–æ–¥—É–ª 4 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 5] –ü–†–û–í–ï–†–ö–ê –ò –†–ï–°–¢–ê–†–¢
# =====================================================================
echo "[5] –ü–†–û–í–ï–†–ö–ê –ò –†–ï–°–¢–ê–†–¢..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"

if [[ ! -f "$SETUP_ENV_FILE" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ $SETUP_ENV_FILE. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ø—Ä–µ–¥–∏—à–Ω–∏—Ç–µ –º–æ–¥—É–ª–∏!"
  exit 1
fi

if grep -q '^SECURE_DNS_MODULE5=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 5 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 5..."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –Ω–∞ BIND –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞..."
  if ! named-checkconf; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ BIND —Å—ä–¥—ä—Ä–∂–∞ –ø—Ä–æ–±–ª–µ–º–∏!"
    echo "‚û° –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ –ø—Ä–µ–¥–∏ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ."
    exit 1
  fi
  echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –µ –≤–∞–ª–∏–¥–Ω–∞."
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 2: –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞ Bind9
  # -------------------------------------------------------------------------------------
  echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Bind9..."
  if systemctl restart bind9; then
    echo "‚úÖ –£—Å–ª—É–≥–∞—Ç–∞ Bind9 –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–∞."
  else
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–µ–Ω —Ä–µ—Å—Ç–∞—Ä—Ç –Ω–∞ Bind9!"
    exit 1
  fi

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —É—Å–ª—É–≥–∞—Ç–∞ –µ –∞–∫—Ç–∏–≤–Ω–∞
  # -------------------------------------------------------------------------------------
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ Bind9 –µ –∞–∫—Ç–∏–≤–Ω–∞..."
  if systemctl is-active --quiet bind9; then
    echo "‚úÖ Bind9 –µ –∞–∫—Ç–∏–≤–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∏."
  else
    echo "‚ùå Bind9 –Ω–µ –µ –∞–∫—Ç–∏–≤–Ω–∞ —Å–ª–µ–¥ —Ä–µ—Å—Ç–∞—Ä—Ç!"
    exit 1
  fi
  echo ""

  # -------------------------------------------------------------------------------------
  # –°–ï–ö–¶–ò–Ø 4: –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞
  # -------------------------------------------------------------------------------------
  grep -q '^SECURE_DNS_MODULE5=' "$SETUP_ENV_FILE" && sed -i 's|^SECURE_DNS_MODULE5=.*|SECURE_DNS_MODULE5=‚úÖ|' "$SETUP_ENV_FILE" || echo "SECURE_DNS_MODULE5=‚úÖ" >> "$SETUP_ENV_FILE"

  echo "‚úÖ –ú–æ–¥—É–ª 5 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 6] –ü–û–î–ì–û–¢–û–í–ö–ê –ó–ê TSIG –¢–ï–°–¢
# =====================================================================
echo "[6] –ü–û–î–ì–û–¢–û–í–ö–ê –ó–ê TSIG –¢–ï–°–¢..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
MODULES_FILE="/etc/netgalaxy/todo.modules"
TSIG_KEY_FILE="/etc/bind/keys/tsig.key"

if [[ ! -f "$SETUP_ENV_FILE" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ $SETUP_ENV_FILE. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –ø—Ä–µ–¥–∏—à–Ω–∏—Ç–µ –º–æ–¥—É–ª–∏!"
  exit 1
fi

if grep -q '^SECURE_DNS_MODULE6=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 6 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 6..."
  echo ""

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ TSIG –∫–ª—é—á
  if [[ ! -f "$TSIG_KEY_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ TSIG –∫–ª—é—á ($TSIG_KEY_FILE). –ú–æ–¥—É–ª 4 –Ω–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω."
    exit 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–æ–º–∞–Ω–¥–∞ dig
  if ! command -v dig &>/dev/null; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ –∫–æ–º–∞–Ω–¥–∞—Ç–∞ dig! –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –ø–∞–∫–µ—Ç dnsutils."
    exit 1
  fi

  # –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏
  if [[ ! -f "$MODULES_FILE" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞ $MODULES_FILE. –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏."
    exit 1
  fi

  SERVER_FQDN=$(grep '^SERVER_FQDN=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
  DNS_ROLE=$(grep '^DNS_ROLE=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
  SECOND_DNS_IP=$(grep '^SECOND_DNS_IP=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')

  if [[ -z "$SERVER_FQDN" || -z "$DNS_ROLE" || -z "$SECOND_DNS_IP" ]]; then
    echo "‚ùå –õ–∏–ø—Å–≤–∞—Ç –∫—Ä–∏—Ç–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ (SERVER_FQDN, DNS_ROLE –∏–ª–∏ SECOND_DNS_IP)."
    exit 1
  fi

  DOMAIN=$(echo "$SERVER_FQDN" | cut -d '.' -f2-)

  # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∏–º–µ—Ç–æ –Ω–∞ –∫–ª—é—á–∞
  TSIG_KEY_NAME=$(grep 'key "' "$TSIG_KEY_FILE" | awk '{print $2}' | tr -d '"')
  if [[ -z "$TSIG_KEY_NAME" ]]; then
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∏–º–µ—Ç–æ –Ω–∞ TSIG –∫–ª—é—á–∞."
    exit 1
  fi

  # –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏
  echo "‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞ TSIG —Ç–µ—Å—Ç:"
  echo "SERVER_FQDN=$SERVER_FQDN"
  echo "DNS_ROLE=$DNS_ROLE"
  echo "DOMAIN=$DOMAIN"
  echo "SECOND_DNS_IP=$SECOND_DNS_IP"
  echo "TSIG_KEY_NAME=$TSIG_KEY_NAME"
  echo ""

  # –ó–∞–ø–∏—Å –≤ setup.env
  grep -q '^SECURE_DNS_MODULE6=' "$SETUP_ENV_FILE" && sed -i 's|^SECURE_DNS_MODULE6=.*|SECURE_DNS_MODULE6=‚úÖ|' "$SETUP_ENV_FILE" || echo "SECURE_DNS_MODULE6=‚úÖ" >> "$SETUP_ENV_FILE"

  echo "‚úÖ –ú–æ–¥—É–ª 6 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""










exit 0



# =====================================================================
# [–ú–û–î–£–õ 7] –§–ò–ù–ê–õ–ï–ù –û–¢–ß–ï–¢
# =====================================================================
echo "[7] –§–ò–ù–ê–õ–ï–ù –û–¢–ß–ï–¢..."
echo "-----------------------------------------------------------"
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 1: –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –≤—Å–∏—á–∫–∏ –º–æ–¥—É–ª–∏
# -------------------------------------------------------------------------------------
echo -e "\e[32m=========================================="
echo -e "         –û–¢–ß–ï–¢ –ó–ê DNS HARDENING"
echo -e "==========================================\e[0m"
echo ""

MODULE1_STATUS=$(sudo grep '^SECURE_DNS_MODULE1=' "$SETUP_ENV_FILE" 2>/dev/null | cut -d '=' -f2)
MODULE2_STATUS=$(sudo grep '^SECURE_DNS_MODULE2=' "$SETUP_ENV_FILE" 2>/dev/null | cut -d '=' -f2)
MODULE3_STATUS=$(sudo grep '^SECURE_DNS_MODULE3=' "$SETUP_ENV_FILE" 2>/dev/null | cut -d '=' -f2)
MODULE4_STATUS=$(sudo grep '^SECURE_DNS_MODULE4=' "$SETUP_ENV_FILE" 2>/dev/null | cut -d '=' -f2)
MODULE5_STATUS=$(sudo grep '^SECURE_DNS_MODULE5=' "$SETUP_ENV_FILE" 2>/dev/null | cut -d '=' -f2)
MODULE6_STATUS=$(sudo grep '^SECURE_DNS_MODULE6=' "$SETUP_ENV_FILE" 2>/dev/null | cut -d '=' -f2)

echo "üìå –ú–æ–¥—É–ª 1 ‚Äì –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:     ${MODULE1_STATUS:-‚ùå}"
echo "üìå –ú–æ–¥—É–ª 2 ‚Äì –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∞–∫–µ—Ç–∏:      ${MODULE2_STATUS:-‚ùå}"
echo "üìå –ú–æ–¥—É–ª 3 ‚Äì ACL –∏ IP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:       ${MODULE3_STATUS:-‚ùå}"
echo "üìå –ú–æ–¥—É–ª 4 ‚Äì –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ TSIG –∫–ª—é—á:    ${MODULE4_STATUS:-‚ùå}"
echo "üìå –ú–æ–¥—É–ª 5 ‚Äì –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–µ—Å—Ç–∞—Ä—Ç:         ${MODULE5_STATUS:-‚ùå}"
echo "üìå –ú–æ–¥—É–ª 6 ‚Äì –¢–µ—Å—Ç –Ω–∞ TSIG:               ${MODULE6_STATUS:-‚ùå}"
echo ""
echo "------------------------------------------------------------------"
echo ""

# -------------------------------------------------------------------------------------
# –°–ï–ö–¶–ò–Ø 2: –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
# -------------------------------------------------------------------------------------
read -p "‚úÖ –ü—Ä–∏–µ–º–∞—Ç–µ –ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –∫–∞—Ç–æ —É—Å–ø–µ—à–Ω–∞? (y/n): " confirm
if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
  # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ñ–∏–Ω–∞–ª–µ–Ω —Å—Ç–∞—Ç—É—Å
  if sudo grep -q '^SETUP_SECURE_DNS_STATUS=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^SETUP_SECURE_DNS_STATUS=.*|SETUP_SECURE_DNS_STATUS=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "SETUP_SECURE_DNS_STATUS=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  # ‚úÖ –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ
  if [[ -f "$MODULES_FILE" ]]; then
    sudo rm -f "$MODULES_FILE"
    echo "üóëÔ∏è –§–∞–π–ª—ä—Ç $MODULES_FILE –±–µ—à–µ –∏–∑—Ç—Ä–∏—Ç."
  fi

  # ‚úÖ –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞
  echo "üóëÔ∏è –°–∫—Ä–∏–ø—Ç—ä—Ç —â–µ —Å–µ –ø—Ä–µ–º–∞—Ö–Ω–µ."
  [[ -f "$0" ]] && sudo rm -- "$0"

  echo "üéØ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ DNS —Å–∏–≥—É—Ä–Ω–æ—Å—Ç—Ç–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ."
else
  echo "‚ÑπÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–µ –µ –º–∞—Ä–∫–∏—Ä–∞–Ω–∞ –∫–∞—Ç–æ —É—Å–ø–µ—à–Ω–∞. –ù–∏—â–æ –Ω–µ –µ –∏–∑—Ç—Ä–∏—Ç–æ."
fi

echo ""
echo ""

# ------------ –ö—Ä–∞–π –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ ------------
