#!/bin/bash
# ==========================================================================
#  vps-vpn-client-register - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤ WireGuard VPN –∫–ª–∏–µ–Ω—Ç
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-24
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞ –ø—Ä–æ—Ü–µ—Å–∞ –ø–æ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∫–ª–∏–µ–Ω—Ç –∫—ä–º –≤–µ—á–µ
#  –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω WireGuard VPN —Å—ä—Ä–≤—ä—Ä (wg0). –ò–∑–ø—ä–ª–Ω—è–≤–∞ —Å–µ –ª–æ–∫–∞–ª–Ω–æ –Ω–∞
#  —Å—ä—Ä–≤—ä—Ä–∞ —Å root –ø—Ä–∞–≤–∞.
#
#  –û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:
#    1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ VPN –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è (vps-vpn-qsetup.sh)
#    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–∫—Ç–∏–≤–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å wg0
#    3. –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –º—Ä–µ–∂–æ–≤–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (VPN IP, Allowed IPs)
#    4. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
#    5. –ó–∞–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –≤ /etc/wireguard/clients/<CLIENT_NAME>
#    6. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å—ä—Ä–≤—ä—Ä–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (wg0.conf)
#    7. –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ WireGuard –±–µ–∑ –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–µ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞ (wg syncconf)
#    8. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ QR –∫–æ–¥ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∞–∫–æ qrencode –µ –Ω–∞–ª–∏—á–µ–Ω)
#    9. –ò–∑–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –æ–±–æ–±—â–µ–Ω–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-vpn-client-register.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ WireGuard VPN –∫–ª–∏–µ–Ω—Ç –∫—ä–º —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â VPN —Å—ä—Ä–≤—ä—Ä."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ===================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-vpn-client-register –≤–µ—Ä—Å–∏—è 1.0 (24 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi


# =====================================================================
# –°–∫—Ä–∏–ø—Ç: vps-vpn-client-register.sh
# –¶–µ–ª: –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ VPN –∫–ª–∏–µ–Ω—Ç –∫—ä–º WireGuard —Å—ä—Ä–≤—ä—Ä
# =====================================================================

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
WG_CONF="/etc/wireguard/wg0.conf"
CLIENTS_DIR="/etc/wireguard/clients"
WG_INTERFACE="wg0"

echo "[VPN CLIENT REGISTER] –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∫–ª–∏–µ–Ω—Ç..."
echo "-----------------------------------------------------------"
echo ""

# =====================================================================
# [–ú–û–î–£–õ 1] –ü—Ä–æ–≤–µ—Ä–∫–∏
# =====================================================================

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
WG_INTERFACE="wg0"
WG_CONF="/etc/wireguard/wg0.conf"
CLIENTS_DIR="/etc/wireguard/clients"

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ root
if [[ $EUID -ne 0 ]]; then
  echo "‚ùå –°–∫—Ä–∏–ø—Ç—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å root –ø—Ä–∞–≤–∞ (sudo)."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —É—Å–ø–µ—à–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ VPN (setup.env)
if ! sudo grep -q '^SETUP_VPS_VPN_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ùå VPN —Å—ä—Ä–≤—ä—Ä—ä—Ç –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω –Ω–∞–ø—ä–ª–Ω–æ. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ vps-vpn-qsetup.sh –ø—Ä–µ–¥–∏ —Ç–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–∫—Ç–∏–≤–µ–Ω WireGuard –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
if ! sudo systemctl is-active --quiet "wg-quick@$WG_INTERFACE"; then
  echo "‚ùå WireGuard –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ä—Ç ($WG_INTERFACE) –Ω–µ –µ –∞–∫—Ç–∏–≤–µ–Ω. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –≥–æ —Ä—ä—á–Ω–æ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ—Ç–æ –Ω–∞ qrencode
if ! command -v qrencode &>/dev/null; then
  echo "‚ö†Ô∏è qrencode –Ω–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω. QR –∫–æ–¥–æ–≤–µ –Ω—è–º–∞ –¥–∞ –º–æ–≥–∞—Ç –¥–∞ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç."
  echo "‚ÑπÔ∏è –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –≥–æ —Å: sudo apt-get install -y qrencode"
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ wg0.conf
if [[ ! -f "$WG_CONF" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∏—è—Ç —Ñ–∞–π–ª: $WG_CONF"
  exit 1
fi

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏, –∞–∫–æ –ª–∏–ø—Å–≤–∞
sudo mkdir -p "$CLIENTS_DIR"
sudo chmod 700 "$CLIENTS_DIR"

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏—Ç–µ —Å–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ."
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 2] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –ò–ú–ï –ù–ê –ö–õ–ò–ï–ù–¢–ê
# =====================================================================

CLIENTS_DIR="/etc/wireguard/clients"
WG_CONF="/etc/wireguard/wg0.conf"

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏, –∞–∫–æ –ª–∏–ø—Å–≤–∞
sudo mkdir -p "$CLIENTS_DIR"
sudo chmod 700 "$CLIENTS_DIR"

while true; do
  read -p "üë§ –í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (3-15 —Å–∏–º–≤–æ–ª–∞, –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, '-', '_'): " CLIENT_NAME

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø—Ä–∞–∑–Ω–æ –∏–º–µ
  if [[ -z "$CLIENT_NAME" ]]; then
    echo "‚ùå –ò–º–µ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–∞–∑–Ω–æ."
    continue
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –¥—ä–ª–∂–∏–Ω–∞
  if (( ${#CLIENT_NAME} < 3 || ${#CLIENT_NAME} > 15 )); then
    echo "‚ùå –î—ä–ª–∂–∏–Ω–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–µ–∂–¥—É 3 –∏ 15 —Å–∏–º–≤–æ–ª–∞."
    continue
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–Ω–∏ —Å–∏–º–≤–æ–ª–∏
  if [[ ! "$CLIENT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "‚ùå –ò–º–µ—Ç–æ —Å—ä–¥—ä—Ä–∂–∞ –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–∏ —Å–∏–º–≤–æ–ª–∏. –†–∞–∑—Ä–µ—à–µ–Ω–∏: –ª–∞—Ç–∏–Ω—Å–∫–∏ –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, '-', '_'."
    continue
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç—ä—Ç –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
  CLIENT_DIR="$CLIENTS_DIR/$CLIENT_NAME"
  if [[ -d "$CLIENT_DIR" ]]; then
    echo "‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç '$CLIENT_NAME' –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
    read -p "–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –ø—Ä–µ–∑–∞–ø–∏—à–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞? (y/q): " choice
    case "$choice" in
      [Yy]*)
        echo "‚ñ∂ –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è..."
        sudo rm -rf "$CLIENT_DIR"

        echo "‚ñ∂ –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ Peer –æ—Ç wg0.conf..."
        sudo sed -i "/# Client: $CLIENT_NAME/,/^$/d" "$WG_CONF"

        echo "‚ñ∂ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ WireGuard..."
        sudo wg syncconf wg0 <(sudo wg-quick strip wg0)

        break
        ;;
      [Qq]*)
        echo "‚ùé –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
        exit 0
        ;;
      *)
        echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –í—ä–≤–µ–¥–µ—Ç–µ 'y' –∏–ª–∏ 'q'."
        continue
        ;;
    esac
  else
    break
  fi
done

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –Ω–æ–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞
sudo mkdir -p "$CLIENT_DIR"
sudo chmod 700 "$CLIENT_DIR"

echo "‚úÖ –ò–º–µ—Ç–æ –µ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–æ: $CLIENT_NAME"
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 3] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê IP –ê–î–†–ï–° –ó–ê –ö–õ–ò–ï–ù–¢–ê
# =====================================================================

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
WG_CONF="/etc/wireguard/wg0.conf"

# ‚úÖ –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
SERVER_IP=$(sudo grep '^SERVER_IP=' "$SETUP_ENV_FILE" | awk -F'=' '{print $2}' | tr -d '"')

# ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è: –≤—ä—Ä—Ç—è—â —Å–µ –∫—É—Ä—Å–æ—Ä –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ
spinner="/-\|"
echo -n "üîç –û—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ VPN –ø–æ–¥–º—Ä–µ–∂–∞—Ç–∞ "
for i in {1..8}; do
  printf "\b${spinner:i%4:1}"
  sleep 0.2
done
echo ""

# ‚úÖ –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ VPN –ø–æ–¥–º—Ä–µ–∂–∞—Ç–∞ –æ—Ç wg0.conf (–ø—Ä–∏–º–µ—Ä: 10.20.0.1/24)
VPN_SUBNET=$(sudo grep '^Address' "$WG_CONF" | awk '{print $3}' | head -n 1)
SUBNET_IP=$(echo "$VPN_SUBNET" | cut -d'/' -f1)
SUBNET_MASK=$(echo "$VPN_SUBNET" | cut -d'/' -f2)

echo "‚ÑπÔ∏è VPN –ø–æ–¥–º—Ä–µ–∂–∞: $VPN_SUBNET"

# ‚úÖ –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è: —Ç–æ—á–∫–∏ –∑–∞ ‚Äû–æ–±—Ä–∞–±–æ—Ç–∫–∞‚Äú
for i in {1..5}; do
  echo -n "."
  sleep 0.3
done
echo ""

# ‚úÖ –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ IP –µ –≤ –ø–æ–¥–º—Ä–µ–∂–∞—Ç–∞
function ip_in_subnet() {
    local ip=$1
    local network=$2
    local maskbits=$3
    local IFS=.
    read -r i1 i2 i3 i4 <<< "$ip"
    read -r n1 n2 n3 n4 <<< "$network"
    local ip_dec=$(( (i1<<24) + (i2<<16) + (i3<<8) + i4 ))
    local net_dec=$(( (n1<<24) + (n2<<16) + (n3<<8) + n4 ))
    local mask=$(( 0xFFFFFFFF << (32 - maskbits) & 0xFFFFFFFF ))
    [[ $((ip_dec & mask)) -eq $((net_dec & mask)) ]]
}

# ‚úÖ –§—É–Ω–∫—Ü–∏—è –∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–Ω–µ IP -> —á–∏—Å–ª–æ
function ip_to_dec() {
    local IFS=.
    read -r i1 i2 i3 i4 <<< "$1"
    echo $(( (i1<<24) + (i2<<16) + (i3<<8) + i4 ))
}

# ‚úÖ –§—É–Ω–∫—Ü–∏—è –∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–Ω–µ —á–∏—Å–ª–æ -> IP
function dec_to_ip() {
    local ip_dec=$1
    echo "$(( (ip_dec>>24) & 255 )).$(( (ip_dec>>16) & 255 )).$(( (ip_dec>>8) & 255 )).$(( ip_dec & 255 ))"
}

# ‚úÖ –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
NET_DEC=$(ip_to_dec "$SUBNET_IP")
START_IP=$((NET_DEC + 2))  # –ü—Ä–µ—Å–∫–∞—á–∞–º–µ –º—Ä–µ–∂–æ–≤–∏—è –∞–¥—Ä–µ—Å –∏ IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
END_IP=$((NET_DEC + (1 << (32 - SUBNET_MASK)) - 2))

# ‚úÖ –°—ä–±–∏—Ä–∞–Ω–µ –Ω–∞ —Å–≤–æ–±–æ–¥–Ω–∏—Ç–µ IP –∞–¥—Ä–µ—Å–∏
FREE_IPS=()
for (( ip_dec=START_IP; ip_dec<=END_IP; ip_dec++ )); do
    candidate=$(dec_to_ip "$ip_dec")
    if [[ "$candidate" != "$SERVER_IP" ]] && ! sudo grep -q "$candidate/32" "$WG_CONF"; then
        FREE_IPS+=("$candidate")
    fi
done

if [[ ${#FREE_IPS[@]} -eq 0 ]]; then
    echo "‚ùå –ù—è–º–∞ —Å–≤–æ–±–æ–¥–Ω–∏ IP –∞–¥—Ä–µ—Å–∏ –≤ –ø–æ–¥–º—Ä–µ–∂–∞—Ç–∞ $VPN_SUBNET."
    exit 1
fi

# ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–µ–¥–∏ –∏–∑–±–æ—Ä–∞ –Ω–∞ —Å–≤–æ–±–æ–¥–µ–Ω IP
echo -n "üéØ –ò–∑–±–æ—Ä –Ω–∞ —Å–≤–æ–±–æ–¥–µ–Ω IP "
for i in {1..16}; do
  echo -n "."
  sleep 0.3
done
echo ""

# ‚úÖ –ò–∑–±–æ—Ä –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª–µ–Ω —Å–≤–æ–±–æ–¥–µ–Ω IP
FREE_IP=$(printf "%s\n" "${FREE_IPS[@]}" | shuf -n 1)

# ‚úÖ –ü–æ–¥—Å–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ IP –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
while true; do
  read -p "üåê –í—ä–≤–µ–¥–µ—Ç–µ VPN IP –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞ [–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ $FREE_IP]: " CLIENT_IP
  CLIENT_IP=${CLIENT_IP:-$FREE_IP}

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–µ–Ω IPv4
  if [[ ! "$CLIENT_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å."
    continue
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –Ω–µ –µ IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
  if [[ "$CLIENT_IP" == "$SERVER_IP" || "$CLIENT_IP" == "$SUBNET_IP" ]]; then
    echo "‚ùå –¢–æ–∑–∏ IP –µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–∞–Ω (—Å—ä—Ä–≤—ä—Ä –∏–ª–∏ –º—Ä–µ–∂–æ–≤ –∞–¥—Ä–µ—Å)."
    continue
  fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ IP –µ –≤ –ø–æ–¥–º—Ä–µ–∂–∞—Ç–∞
if ! ip_in_subnet "$CLIENT_IP" "$SUBNET_IP" "$SUBNET_MASK"; then
  echo "‚ùå IP –∞–¥—Ä–µ—Å—ä—Ç –Ω–µ –µ –≤ –ø–æ–¥–º—Ä–µ–∂–∞—Ç–∞ $VPN_SUBNET."
  continue
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ IP –≤–µ—á–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞
if sudo grep -q "$CLIENT_IP/32" "$WG_CONF"; then
  echo "‚ùå IP –∞–¥—Ä–µ—Å—ä—Ç –≤–µ—á–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞."
  continue
fi

break
done

# ‚úÖ –£—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ AllowedIPs –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
ALLOWED_IPS="0.0.0.0/0"

echo ""
echo "‚úÖ IP –∞–¥—Ä–µ—Å—ä—Ç –µ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω: $CLIENT_IP"
echo "‚úÖ Allowed IPs: $ALLOWED_IPS"
echo ""
echo ""


exit 0
# =====================================================================
# [3] –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# =====================================================================

echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ..."
CLIENT_PRIVATE_KEY=$(wg genkey)
CLIENT_PUBLIC_KEY=$(echo "$CLIENT_PRIVATE_KEY" | wg pubkey)
SERVER_PUBLIC_KEY=$(grep -m 1 'PrivateKey' "$WG_CONF" | awk '{print $3}' | wg pubkey)

SERVER_IP=$(grep '^Address' "$WG_CONF" | awk '{print $3}' | cut -d'/' -f1)
WG_PORT=$(grep '^ListenPort' "$WG_CONF" | awk '{print $3}')
ENDPOINT=$(grep '^SERVER_IP=' "$SETUP_ENV_FILE" | awk -F'=' '{print $2}' | tr -d '"')

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
cat <<EOF > "$CLIENT_CONF"
[Interface]
PrivateKey = $CLIENT_PRIVATE_KEY
Address = $CLIENT_IP/32
DNS = 1.1.1.1

[Peer]
PublicKey = $SERVER_PUBLIC_KEY
Endpoint = $ENDPOINT:$WG_PORT
AllowedIPs = $ALLOWED_IPS
EOF

chmod 600 "$CLIENT_CONF"
echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞: $CLIENT_CONF"
echo ""

# =====================================================================
# [4] –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ wg0.conf
# =====================================================================
echo "üîó –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å—ä—Ä–≤—ä—Ä–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è..."
cat <<EOF >> "$WG_CONF"

# Client: $CLIENT_NAME
[Peer]
PublicKey = $CLIENT_PUBLIC_KEY
AllowedIPs = $CLIENT_IP/32
EOF

# ‚úÖ –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ WireGuard –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
wg syncconf $WG_INTERFACE <(wg-quick strip $WG_INTERFACE)
echo "‚úÖ –ö–ª–∏–µ–Ω—Ç—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω —É—Å–ø–µ—à–Ω–æ."
echo ""

# =====================================================================
# [5] –û–±–æ–±—â–µ–Ω–∏–µ –∏ QR –∫–æ–¥
# =====================================================================

echo "üìã –û–±–æ–±—â–µ–Ω–∏–µ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞:"
echo "-------------------------------------"
echo "–ò–º–µ:          $CLIENT_NAME"
echo "VPN IP:       $CLIENT_IP"
echo "Allowed IPs:  $ALLOWED_IPS"
echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $CLIENT_CONF"
echo "-------------------------------------"
echo ""

if command -v qrencode &>/dev/null; then
  echo "üì± –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ QR –∫–æ–¥ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
  qrencode -t ansiutf8 < "$CLIENT_CONF"
else
  echo "‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ä—Ç qrencode –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω. QR –∫–æ–¥ –Ω—è–º–∞ –¥–∞ –±—ä–¥–µ –ø–æ–∫–∞–∑–∞–Ω."
fi

echo ""
echo "‚úÖ –î–æ–±–∞–≤—è–Ω–µ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ."
