#!/bin/bash
# ==========================================================================
#  vps-vpn-client-register - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤ WireGuard VPN –∫–ª–∏–µ–Ω—Ç
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-24
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞ –ø—Ä–æ—Ü–µ—Å–∞ –ø–æ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∫–ª–∏–µ–Ω—Ç –∫—ä–º –≤–µ—á–µ
#  –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω WireGuard VPN —Å—ä—Ä–≤—ä—Ä (wg0). –ò–∑–ø—ä–ª–Ω—è–≤–∞ —Å–µ –ª–æ–∫–∞–ª–Ω–æ –Ω–∞
#  —Å—ä—Ä–≤—ä—Ä–∞ —Å root –ø—Ä–∞–≤–∞.
#
#  –û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:
#    1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ VPN –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è (vps-vpn-qsetup.sh)
#    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–∫—Ç–∏–≤–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å wg0
#    3. –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –º—Ä–µ–∂–æ–≤–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (VPN IP, Allowed IPs)
#    4. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
#    5. –ó–∞–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –≤ /etc/wireguard/clients/<CLIENT_NAME>
#    6. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å—ä—Ä–≤—ä—Ä–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (wg0.conf)
#    7. –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ WireGuard –±–µ–∑ –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–µ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞ (wg syncconf)
#    8. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ QR –∫–æ–¥ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∞–∫–æ qrencode –µ –Ω–∞–ª–∏—á–µ–Ω)
#    9. –ò–∑–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –æ–±–æ–±—â–µ–Ω–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-vpn-client-register.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ WireGuard VPN –∫–ª–∏–µ–Ω—Ç –∫—ä–º —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â VPN —Å—ä—Ä–≤—ä—Ä."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ===================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-vpn-client-register –≤–µ—Ä—Å–∏—è 1.0 (24 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi


# =====================================================================
# –°–∫—Ä–∏–ø—Ç: vps-vpn-client-register.sh
# –¶–µ–ª: –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ VPN –∫–ª–∏–µ–Ω—Ç –∫—ä–º WireGuard —Å—ä—Ä–≤—ä—Ä
# =====================================================================

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
WG_CONF="/etc/wireguard/wg0.conf"
CLIENTS_DIR="/etc/wireguard/clients"
WG_INTERFACE="wg0"

echo "[VPN CLIENT REGISTER] –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤ –∫–ª–∏–µ–Ω—Ç..."
echo "-----------------------------------------------------------"
echo ""

# =====================================================================
# [1] –ü—Ä–æ–≤–µ—Ä–∫–∏
# =====================================================================

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
WG_INTERFACE="wg0"
WG_CONF="/etc/wireguard/wg0.conf"
CLIENTS_DIR="/etc/wireguard/clients"

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ root
if [[ $EUID -ne 0 ]]; then
  echo "‚ùå –°–∫—Ä–∏–ø—Ç—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å root –ø—Ä–∞–≤–∞ (sudo)."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —É—Å–ø–µ—à–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ VPN (setup.env)
if ! sudo grep -q '^SETUP_VPS_VPN_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ùå VPN —Å—ä—Ä–≤—ä—Ä—ä—Ç –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω –Ω–∞–ø—ä–ª–Ω–æ. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ vps-vpn-qsetup.sh –ø—Ä–µ–¥–∏ —Ç–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–∫—Ç–∏–≤–µ–Ω WireGuard –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
if ! sudo systemctl is-active --quiet "wg-quick@$WG_INTERFACE"; then
  echo "‚ùå WireGuard –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ä—Ç ($WG_INTERFACE) –Ω–µ –µ –∞–∫—Ç–∏–≤–µ–Ω. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –≥–æ —Ä—ä—á–Ω–æ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ—Ç–æ –Ω–∞ qrencode
if ! command -v qrencode &>/dev/null; then
  echo "‚ö†Ô∏è qrencode –Ω–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω. QR –∫–æ–¥–æ–≤–µ –Ω—è–º–∞ –¥–∞ –º–æ–≥–∞—Ç –¥–∞ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç."
  echo "‚ÑπÔ∏è –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –≥–æ —Å: sudo apt-get install -y qrencode"
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ wg0.conf
if [[ ! -f "$WG_CONF" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∏—è—Ç —Ñ–∞–π–ª: $WG_CONF"
  exit 1
fi

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏, –∞–∫–æ –ª–∏–ø—Å–≤–∞
sudo mkdir -p "$CLIENTS_DIR"
sudo chmod 700 "$CLIENTS_DIR"

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏—Ç–µ —Å–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ."
echo ""


# =====================================================================
# [–ú–û–î–£–õ 2] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –ò–ú–ï –ù–ê –ö–õ–ò–ï–ù–¢–ê
# =====================================================================

CLIENTS_DIR="/etc/wireguard/clients"

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏, –∞–∫–æ –ª–∏–ø—Å–≤–∞
sudo mkdir -p "$CLIENTS_DIR"
sudo chmod 700 "$CLIENTS_DIR"

while true; do
  read -p "üë§ –í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–ø—Ä–∏–º–µ—Ä: client1): " CLIENT_NAME

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø—Ä–∞–∑–Ω–æ –∏–º–µ
  if [[ -z "$CLIENT_NAME" ]]; then
    echo "‚ùå –ò–º–µ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–∞–∑–Ω–æ."
    continue
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –¥—ä–ª–∂–∏–Ω–∞
  if (( ${#CLIENT_NAME} < 3 || ${#CLIENT_NAME} > 32 )); then
    echo "‚ùå –î—ä–ª–∂–∏–Ω–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–µ–∂–¥—É 3 –∏ 32 —Å–∏–º–≤–æ–ª–∞."
    continue
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–Ω–∏ —Å–∏–º–≤–æ–ª–∏ (–±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, —Ç–∏—Ä–µ –∏ –¥–æ–ª–Ω–∞ —á–µ—Ä—Ç–∞)
  if [[ ! "$CLIENT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "‚ùå –ò–º–µ—Ç–æ —Å—ä–¥—ä—Ä–∂–∞ –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–∏ —Å–∏–º–≤–æ–ª–∏. –†–∞–∑—Ä–µ—à–µ–Ω–∏ —Å–∞: –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, '-', '_'."
    continue
  fi

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç—ä—Ç –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
  CLIENT_DIR="$CLIENTS_DIR/$CLIENT_NAME"
  if [[ -d "$CLIENT_DIR" ]]; then
    echo "‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç '$CLIENT_NAME' –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
    read -p "–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –ø—Ä–µ–∑–∞–ø–∏—à–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞? (y/q): " choice
    case "$choice" in
      [Yy]*)
        echo "‚ñ∂ –ü—Ä–µ–∑–∞–ø–∏—Å –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞..."
        sudo rm -rf "$CLIENT_DIR"
        break
        ;;
      [Qq]*)
        echo "‚ùé –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
        exit 0
        ;;
      *)
        echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –í—ä–≤–µ–¥–µ—Ç–µ 'y' –∏–ª–∏ 'q'."
        continue
        ;;
    esac
  else
    break
  fi
done

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –Ω–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
sudo mkdir -p "$CLIENT_DIR"
sudo chmod 700 "$CLIENT_DIR"

echo "‚úÖ –ò–º–µ—Ç–æ –µ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–æ: $CLIENT_NAME"
echo ""

exit 0
# =====================================================================
# [3] –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# =====================================================================

echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ..."
CLIENT_PRIVATE_KEY=$(wg genkey)
CLIENT_PUBLIC_KEY=$(echo "$CLIENT_PRIVATE_KEY" | wg pubkey)
SERVER_PUBLIC_KEY=$(grep -m 1 'PrivateKey' "$WG_CONF" | awk '{print $3}' | wg pubkey)

SERVER_IP=$(grep '^Address' "$WG_CONF" | awk '{print $3}' | cut -d'/' -f1)
WG_PORT=$(grep '^ListenPort' "$WG_CONF" | awk '{print $3}')
ENDPOINT=$(grep '^SERVER_IP=' "$SETUP_ENV_FILE" | awk -F'=' '{print $2}' | tr -d '"')

# ‚úÖ –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
cat <<EOF > "$CLIENT_CONF"
[Interface]
PrivateKey = $CLIENT_PRIVATE_KEY
Address = $CLIENT_IP/32
DNS = 1.1.1.1

[Peer]
PublicKey = $SERVER_PUBLIC_KEY
Endpoint = $ENDPOINT:$WG_PORT
AllowedIPs = $ALLOWED_IPS
EOF

chmod 600 "$CLIENT_CONF"
echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞: $CLIENT_CONF"
echo ""

# =====================================================================
# [4] –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ wg0.conf
# =====================================================================
echo "üîó –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å—ä—Ä–≤—ä—Ä–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è..."
cat <<EOF >> "$WG_CONF"

# Client: $CLIENT_NAME
[Peer]
PublicKey = $CLIENT_PUBLIC_KEY
AllowedIPs = $CLIENT_IP/32
EOF

# ‚úÖ –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ WireGuard –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
wg syncconf $WG_INTERFACE <(wg-quick strip $WG_INTERFACE)
echo "‚úÖ –ö–ª–∏–µ–Ω—Ç—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω —É—Å–ø–µ—à–Ω–æ."
echo ""

# =====================================================================
# [5] –û–±–æ–±—â–µ–Ω–∏–µ –∏ QR –∫–æ–¥
# =====================================================================

echo "üìã –û–±–æ–±—â–µ–Ω–∏–µ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞:"
echo "-------------------------------------"
echo "–ò–º–µ:          $CLIENT_NAME"
echo "VPN IP:       $CLIENT_IP"
echo "Allowed IPs:  $ALLOWED_IPS"
echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $CLIENT_CONF"
echo "-------------------------------------"
echo ""

if command -v qrencode &>/dev/null; then
  echo "üì± –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ QR –∫–æ–¥ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
  qrencode -t ansiutf8 < "$CLIENT_CONF"
else
  echo "‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ä—Ç qrencode –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω. QR –∫–æ–¥ –Ω—è–º–∞ –¥–∞ –±—ä–¥–µ –ø–æ–∫–∞–∑–∞–Ω."
fi

echo ""
echo "‚úÖ –î–æ–±–∞–≤—è–Ω–µ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ."
