#!/bin/bash

# ==========================================================================
#  vps-vpn-qsetup - Ð˜Ð½ÑÑ‚Ð°Ð»Ð°Ñ†Ð¸Ñ Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ð° WireGuard VPN Ð·Ð° VPS
# --------------------------------------------------------------------------
#  Ð’ÐµÑ€ÑÐ¸Ñ: 1.0
#  Ð”Ð°Ñ‚Ð°: 2025-07-24
#  ÐÐ²Ñ‚Ð¾Ñ€: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  Ð¢Ð¾Ð·Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ‚Ð° Ð½Ð° WireGuard VPN Ð½Ð° VPS ÑÑŠÑ€Ð²ÑŠÑ€.
#  Ð˜Ð·Ð¿ÑŠÐ»Ð½ÑÐ²Ð° ÑÐµ Ð»Ð¾ÐºÐ°Ð»Ð½Ð¾ Ð½Ð° ÑÑŠÑ€Ð²ÑŠÑ€Ð° (root Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»).
#
#  ÐžÑÐ½Ð¾Ð²Ð½Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:
#    1. ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»Ð½Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
#    2. Ð˜Ð½ÑÑ‚Ð°Ð»Ð¸Ñ€Ð°Ð½Ðµ Ð½Ð° WireGuard
#    3. ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€Ð°Ð½Ðµ Ð½Ð° VPN Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (wg0)
#    4. Ð¡ÑŠÐ·Ð´Ð°Ð²Ð°Ð½Ðµ Ð½Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
#    5. Ð”Ð¾Ð±Ð°Ð²ÑÐ½Ðµ Ð½Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¸ Ð² ÑÑŠÑ€Ð²ÑŠÑ€Ð½Ð°Ñ‚Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
#    6. Ð ÐµÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½Ðµ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÑƒÑÐ»ÑƒÐ³Ð°Ñ‚Ð°
#    7. ÐžÐ±Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸Ñ‚Ðµ
# ==========================================================================

# === ÐŸÐžÐœÐžÐ©ÐÐ Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ ===================================================
show_help() {
  echo "Ð˜Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ð½Ðµ: vps-vpn-qsetup.sh [Ð¾Ð¿Ñ†Ð¸Ñ]"
  echo ""
  echo "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð°Ð½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ð° WireGuard VPN Ð·Ð° VPS."
  echo ""
  echo "ÐžÐ¿Ñ†Ð¸Ð¸:"
  echo "  --version       ÐŸÐ¾ÐºÐ°Ð·Ð²Ð° Ð²ÐµÑ€ÑÐ¸ÑÑ‚Ð° Ð½Ð° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°"
  echo "  --help          ÐŸÐ¾ÐºÐ°Ð·Ð²Ð° Ñ‚Ð°Ð·Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‰"
}

# === ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ ÐÐ ÐžÐŸÐ¦Ð˜Ð˜ ===================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-vpn-qsetup Ð²ÐµÑ€ÑÐ¸Ñ 1.0 (24 ÑŽÐ»Ð¸ 2025 Ð³.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "âŒ ÐÐµÑ€Ð°Ð·Ð¿Ð¾Ð·Ð½Ð°Ñ‚Ð° Ð¾Ð¿Ñ†Ð¸Ñ: $1"
      show_help
      exit 1
      ;;
  esac
fi

# === Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ÐÐ ÐŸÐªÐ¢Ð˜Ð©Ð =============================================
echo ""
echo -e "\e[32m============================================"
echo -e "  ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ÐÐ WIREGUARD VPN ÐÐ VPS Ð¡ÐªÐ Ð’ÐªÐ "
echo -e "============================================\e[0m"
echo ""

NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

# =====================================================================
# [ÐœÐžÐ”Ð£Ð› 1] ÐŸÐ Ð•Ð”Ð’ÐÐ Ð˜Ð¢Ð•Ð›ÐÐ˜ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ˜ Ð˜ Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯
# =====================================================================
echo "[1] ÐŸÐ Ð•Ð”Ð’ÐÐ Ð˜Ð¢Ð•Ð›ÐÐ˜ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ˜ ÐÐ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ..."
echo "-----------------------------------------------------------"
echo ""

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð° root Ð¿Ñ€Ð°Ð²Ð°
if [[ $EUID -ne 0 ]]; then
  echo "âŒ Ð¢Ñ€ÑÐ±Ð²Ð° Ð´Ð° ÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ñ root Ð¿Ñ€Ð°Ð²Ð° (sudo)."
  exit 1
fi

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð° Ð±Ð°Ð·Ð¾Ð²Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! sudo grep -q '^SETUP_VPS_BASE_STATUS=âœ…' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "ðŸ›‘ Ð¡ÑŠÑ€Ð²ÑŠÑ€ÑŠÑ‚ Ðµ Ñ Ð½ÐµÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð° Ð½Ð°Ñ‡Ð°Ð»Ð½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ. ÐœÐ¾Ð»Ñ, ÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ð° vps-base-qsetup.sh Ð¸ Ð¾Ð¿Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾."
  echo "ðŸ—‘ï¸ ÐŸÑ€ÐµÐ¼Ð°Ñ…Ð²Ð°Ð½Ðµ Ð½Ð° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð°Ð»Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð²ÐµÑ‡Ðµ Ðµ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
if [[ -f "$SETUP_ENV_FILE" ]] && sudo grep -q '^SETUP_VPS_VPN_STATUS=âœ…' "$SETUP_ENV_FILE"; then
  echo "ðŸ›‘ Ð¢Ð¾Ð·Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð²ÐµÑ‡Ðµ Ðµ Ð±Ð¸Ð» Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð½Ð° Ñ‚Ð¾Ð·Ð¸ ÑÑŠÑ€Ð²ÑŠÑ€."
  echo "ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½Ð¸Ðµ Ð½Ðµ Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ð¾, Ð·Ð° Ð´Ð° ÑÐµ Ð¸Ð·Ð±ÐµÐ³Ð½Ðµ Ð¿Ð¾Ð²Ñ€ÐµÐ´Ð° Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ñ‚Ð°."
  [[ -f "$0" ]] && sudo rm -- "$0"
  exit 0
fi

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°..."
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  OS_NAME=$ID
  OS_VERSION=$VERSION_ID
else
  echo "âŒ ÐÐµÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚ÐºÑ€Ð¸Ð²Ð°Ð½Ðµ Ð½Ð° ÐžÐ¡. Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð¸Ð·Ð¸ÑÐºÐ²Ð° Ubuntu Ð¸Ð»Ð¸ Debian."
  exit 1
fi

SUPPORTED=false
if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
  SUPPORTED=true
elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
  SUPPORTED=true
fi

if [[ "$SUPPORTED" == false ]]; then
  echo "âŒ ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð° $PRETTY_NAME Ð½Ðµ ÑÐµ Ð¿Ð¾Ð´Ð´ÑŠÑ€Ð¶Ð° Ð¾Ñ‚ Ñ‚Ð¾Ð·Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚."
  echo "ÐŸÐ¾Ð´Ð´ÑŠÑ€Ð¶Ð°Ð½Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸: Ubuntu 22.04/24.04, Debian 11/12"
  exit 1
fi

echo "âœ… Ð—Ð°ÑÐµÑ‡ÐµÐ½Ð° Ð¿Ð¾Ð´Ð´ÑŠÑ€Ð¶Ð°Ð½Ð° ÐžÐ¡: $PRETTY_NAME"
echo ""

# âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð°Ð»Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑŠÑ‚ Ð²ÐµÑ‡Ðµ Ðµ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½
if sudo grep -q '^VPN_RESULT_MODULE1=âœ…' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "â„¹ï¸ ÐœÐ¾Ð´ÑƒÐ» 1 Ð²ÐµÑ‡Ðµ Ðµ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°Ð½Ðµ..."
else
  # âœ… ÐŸÐ¾Ñ‚Ð²ÑŠÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð½Ð° IP Ð°Ð´Ñ€ÐµÑ
  while true; do
    printf "ðŸŒ Ð’ÑŠÐ²ÐµÐ´ÐµÑ‚Ðµ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¸Ñ IP Ð°Ð´Ñ€ÐµÑ Ð½Ð° ÑÑŠÑ€Ð²ÑŠÑ€Ð° (Ð¸Ð»Ð¸ 'q' Ð·Ð° Ð¸Ð·Ñ…Ð¾Ð´): "
    read SERVER_IP

    if [[ "$SERVER_IP" == "q" || "$SERVER_IP" == "Q" ]]; then
      echo "âŽ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð±ÐµÑˆÐµ Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‚ÐµÐ½ Ð¾Ñ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ñ."
      exit 0
    fi

    if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "âŒ ÐÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½ IP Ð°Ð´Ñ€ÐµÑ. ÐœÐ¾Ð»Ñ, Ð²ÑŠÐ²ÐµÐ´ÐµÑ‚Ðµ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½ IPv4 Ð°Ð´Ñ€ÐµÑ (Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 192.168.1.100)."
      continue
    fi

    ACTUAL_IP=$(curl -s -4 ifconfig.me)

    if [[ "$ACTUAL_IP" != "$SERVER_IP" ]]; then
      echo ""
      echo "ðŸš« ÐÐµÑÑŠÐ¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ! Ð’ÑŠÐ²ÐµÐ´ÐµÐ½Ð¸ÑÑ‚ IP ($SERVER_IP) Ð½Ðµ ÑÑŠÐ²Ð¿Ð°Ð´Ð° Ñ Ñ€ÐµÐ°Ð»Ð½Ð¸Ñ IP Ð½Ð° Ð¼Ð°ÑˆÐ¸Ð½Ð°Ñ‚Ð° ($ACTUAL_IP)."
      echo ""
      read -p "ðŸ” Ð˜ÑÐºÐ°Ñ‚Ðµ Ð»Ð¸ Ð´Ð° Ð¾Ð¿Ð¸Ñ‚Ð°Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾? [Enter Ð·Ð° Ð”Ð, 'q' Ð·Ð° Ð¸Ð·Ñ…Ð¾Ð´]: " retry
      if [[ "$retry" == "q" || "$retry" == "Q" ]]; then
        echo "â›” Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð±ÐµÑˆÐµ Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‚ÐµÐ½ Ð¾Ñ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ñ."
        exit 0
      fi
      echo ""
    else
      echo "âœ… ÐŸÐ¾Ñ‚Ð²ÑŠÑ€Ð´ÐµÐ½Ð¾: ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ðµ ÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½ Ð½Ð° ÑÑŠÑ€Ð²ÑŠÑ€Ð° Ñ IP $SERVER_IP."
      break
    fi
  done

  # âœ… Ð—Ð°Ð¿Ð¸Ñ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²ÑÐ²Ð°Ð½Ðµ Ð½Ð° SERVER_IP Ð² todo.modules
  if sudo grep -q '^SERVER_IP=' "$MODULES_FILE" 2>/dev/null; then
    sudo sed -i "s|^SERVER_IP=.*|SERVER_IP=\"$SERVER_IP\"|" "$MODULES_FILE"
  else
    echo "SERVER_IP=\"$SERVER_IP\"" | sudo tee -a "$MODULES_FILE" > /dev/null
  fi

  # âœ… Ð—Ð°Ð¿Ð¸Ñ Ð½Ð° Ñ€ÐµÐ·ÑƒÐ»Ñ‚Ð°Ñ‚ Ð·Ð° ÐœÐ¾Ð´ÑƒÐ» 1
  if sudo grep -q '^VPN_RESULT_MODULE1=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^VPN_RESULT_MODULE1=.*|VPN_RESULT_MODULE1=âœ…|' "$SETUP_ENV_FILE"
  else
    echo "VPN_RESULT_MODULE1=âœ…" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi
fi

echo ""
echo ""

exit 0
