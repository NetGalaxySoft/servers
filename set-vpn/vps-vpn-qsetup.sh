#!/bin/bash

# ==========================================================================
#  vps-vpn-qsetup - –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ WireGuard VPN –∑–∞ VPS
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-07-24
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ç–∞ –Ω–∞ WireGuard VPN –Ω–∞ VPS —Å—ä—Ä–≤—ä—Ä.
#  –ò–∑–ø—ä–ª–Ω—è–≤–∞ —Å–µ –ª–æ–∫–∞–ª–Ω–æ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (root –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª).
#
#  –û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:
#    1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
#    2. –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ WireGuard
#    3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (wg0)
#    4. –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
#    5. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –≤ —Å—ä—Ä–≤—ä—Ä–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
#    6. –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞
#    7. –û–±–æ–±—â–µ–Ω–∏–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
# ==========================================================================

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-vpn-qsetup.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ WireGuard VPN –∑–∞ VPS."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ===================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-vpn-qsetup –≤–µ—Ä—Å–∏—è 1.0 (24 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

# === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ù–ê –ü–™–¢–ò–©–ê =============================================
echo ""
echo -e "\e[32m============================================"
echo -e "  –ù–ê–°–¢–†–û–ô–ö–ê –ù–ê WIREGUARD VPN –ù–ê VPS –°–™–†–í–™–†"
echo -e "============================================\e[0m"
echo ""

NETGALAXY_DIR="/etc/netgalaxy"
MODULES_FILE="$NETGALAXY_DIR/todo.modules"
SETUP_ENV_FILE="$NETGALAXY_DIR/setup.env"

# =====================================================================
# [–ú–û–î–£–õ 1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
# =====================================================================
echo "[1] –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–ù–ò –ü–†–û–í–ï–†–ö–ò –ù–ê –°–ò–°–¢–ï–ú–ê..."
echo "-----------------------------------------------------------"
echo ""

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ root –ø—Ä–∞–≤–∞
if [[ $EUID -ne 0 ]]; then
  echo "‚ùå –¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞—Ç–µ —Å–∫—Ä–∏–ø—Ç–∞ —Å root –ø—Ä–∞–≤–∞ (sudo)."
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –±–∞–∑–æ–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
if [[ ! -f "$SETUP_ENV_FILE" ]] || ! sudo grep -q '^SETUP_VPS_BASE_STATUS=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "üõë –°—ä—Ä–≤—ä—Ä—ä—Ç –µ —Å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –Ω–∞—á–∞–ª–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è. –ú–æ–ª—è, —Å—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ —Ñ–∞–π–ª–∞ vps-base-qsetup.sh –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  echo "üóëÔ∏è –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞."
  [[ -f "$0" ]] && rm -- "$0"
  exit 1
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
if [[ -f "$SETUP_ENV_FILE" ]] && sudo grep -q '^SETUP_VPS_VPN_STATUS=‚úÖ' "$SETUP_ENV_FILE"; then
  echo "üõë –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –≤–µ—á–µ –µ –±–∏–ª –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞ —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä."
  echo "–ü–æ–≤—Ç–æ—Ä–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–µ –µ –ø–æ–∑–≤–æ–ª–µ–Ω–æ, –∑–∞ –¥–∞ —Å–µ –∏–∑–±–µ–≥–Ω–µ –ø–æ–≤—Ä–µ–¥–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞."
  [[ -f "$0" ]] && sudo rm -- "$0"
  exit 0
fi

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞..."
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  OS_NAME=$ID
  OS_VERSION=$VERSION_ID
else
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –û–°. –°–∫—Ä–∏–ø—Ç—ä—Ç –∏–∑–∏—Å–∫–≤–∞ Ubuntu –∏–ª–∏ Debian."
  exit 1
fi

SUPPORTED=false
if [[ "$OS_NAME" == "ubuntu" && ( "$OS_VERSION" == "22.04" || "$OS_VERSION" == "24.04" ) ]]; then
  SUPPORTED=true
elif [[ "$OS_NAME" == "debian" && ( "$OS_VERSION" == "11" || "$OS_VERSION" == "12" ) ]]; then
  SUPPORTED=true
fi

if [[ "$SUPPORTED" == false ]]; then
  echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ $PRETTY_NAME –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –æ—Ç —Ç–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç."
  echo "–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏ —Å–∏—Å—Ç–µ–º–∏: Ubuntu 22.04/24.04, Debian 11/12"
  exit 1
fi

echo "‚úÖ –ó–∞—Å–µ—á–µ–Ω–∞ –ø–æ–¥–¥—ä—Ä–∂–∞–Ω–∞ –û–°: $PRETTY_NAME"
echo ""

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if sudo grep -q '^VPN_RESULT_MODULE1=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 1 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
else
  # ‚úÖ –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ IP –∞–¥—Ä–µ—Å
  while true; do
    printf "üåê –í—ä–≤–µ–¥–µ—Ç–µ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): "
    read SERVER_IP

    if [[ "$SERVER_IP" == "q" || "$SERVER_IP" == "Q" ]]; then
      echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    fi

    if ! [[ "$SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω IPv4 –∞–¥—Ä–µ—Å (–ø—Ä–∏–º–µ—Ä: 192.168.1.100)."
      continue
    fi

    ACTUAL_IP=$(curl -s -4 ifconfig.me)

    if [[ "$ACTUAL_IP" != "$SERVER_IP" ]]; then
      echo ""
      echo "üö´ –ù–µ—Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ! –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç IP ($SERVER_IP) –Ω–µ —Å—ä–≤–ø–∞–¥–∞ —Å —Ä–µ–∞–ª–Ω–∏—è IP –Ω–∞ –º–∞—à–∏–Ω–∞—Ç–∞ ($ACTUAL_IP)."
      echo ""
      read -p "üîÅ –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –æ–ø–∏—Ç–∞—Ç–µ –æ—Ç–Ω–æ–≤–æ? [Enter –∑–∞ –î–ê, 'q' –∑–∞ –∏–∑—Ö–æ–¥]: " retry
      if [[ "$retry" == "q" || "$retry" == "Q" ]]; then
        echo "‚õî –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
        exit 0
      fi
      echo ""
    else
      echo "‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ: —Å–∫—Ä–∏–ø—Ç—ä—Ç –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ —Å IP $SERVER_IP."
      break
    fi
  done

  # ‚úÖ –ó–∞–ø–∏—Å –∏–ª–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ SERVER_IP –≤ todo.modules
  if sudo grep -q '^SERVER_IP=' "$MODULES_FILE" 2>/dev/null; then
    sudo sed -i "s|^SERVER_IP=.*|SERVER_IP=\"$SERVER_IP\"|" "$MODULES_FILE"
  else
    echo "SERVER_IP=\"$SERVER_IP\"" | sudo tee -a "$MODULES_FILE" > /dev/null
  fi

  # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –ú–æ–¥—É–ª 1
  if sudo grep -q '^VPN_RESULT_MODULE1=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^VPN_RESULT_MODULE1=.*|VPN_RESULT_MODULE1=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "VPN_RESULT_MODULE1=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 2] –ò–ù–°–¢–ê–õ–ò–†–ê–ù–ï –ù–ê WIREGUARD
# =====================================================================
echo "[2] –ò–ù–°–¢–ê–õ–ò–†–ê–ù–ï –ù–ê WIREGUARD..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω
if sudo grep -q '^VPN_RESULT_MODULE2=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 2 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 2..."
  echo ""

  # ‚úÖ –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø–∞–∫–µ—Ç–∏—Ç–µ
  echo "üîç –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä–∫–∞ —Å –ø–∞–∫–µ—Ç–∏..."
  if ! sudo apt-get update -y; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä–∫–∞ —Å –ø–∞–∫–µ—Ç–∏."
    exit 1
  fi
  echo "‚úÖ –°–ø–∏—Å—ä–∫—ä—Ç —Å –ø–∞–∫–µ—Ç–∏ –µ –æ–±–Ω–æ–≤–µ–Ω."
  echo ""

  # ‚úÖ –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ WireGuard
  echo "üîç –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ WireGuard –∏ –Ω—É–∂–Ω–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏..."
  if ! sudo apt-get install -y wireguard wireguard-tools; then
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ WireGuard."
    exit 1
  fi
  echo "‚úÖ WireGuard –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
  echo ""

  # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ –∫–æ–º–∞–Ω–¥–∞—Ç–∞ wg
  if ! command -v wg >/dev/null 2>&1; then
    echo "‚ùå WireGuard –Ω–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω –∫–æ—Ä–µ–∫—Ç–Ω–æ (–ª–∏–ø—Å–≤–∞ –∫–æ–º–∞–Ω–¥–∞ wg)."
    exit 1
  fi
  echo "‚úÖ WireGuard –µ –Ω–∞–ª–∏—á–µ–Ω."
  echo ""

  # ‚úÖ –ó–∞–ø–∏—Å –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –ú–æ–¥—É–ª 2
  if sudo grep -q '^VPN_RESULT_MODULE2=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sudo sed -i 's|^VPN_RESULT_MODULE2=.*|VPN_RESULT_MODULE2=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "VPN_RESULT_MODULE2=‚úÖ" | sudo tee -a "$SETUP_ENV_FILE" > /dev/null
  fi

  echo "‚úÖ –ú–æ–¥—É–ª 2 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


# =====================================================================
# [–ú–û–î–£–õ 3] –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –û–°–ù–û–í–ù–ò–Ø VPN –ò–ù–¢–ï–†–§–ï–ô–° (WG0)
# =====================================================================
echo "[3] –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –û–°–ù–û–í–ù–ò–Ø VPN –ò–ù–¢–ï–†–§–ï–ô–°..."
echo "-----------------------------------------------------------"
echo ""

SETUP_ENV_FILE="/etc/netgalaxy/setup.env"
MODULES_FILE="/etc/netgalaxy/todo.modules"
WG_CONF="/etc/wireguard/wg0.conf"

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –º–æ–¥—É–ª—ä—Ç –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω ---
if grep -q '^VPN_RESULT_MODULE3=‚úÖ' "$SETUP_ENV_FILE" 2>/dev/null; then
  echo "‚ÑπÔ∏è –ú–æ–¥—É–ª 3 –≤–µ—á–µ –µ –∏–∑–ø—ä–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ..."
  echo ""
else
  echo "‚ñ∂ –ó–∞–ø–æ—á–≤–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ú–æ–¥—É–ª 3..."
  echo ""

  # ===========================================================
  # –°–ï–ö–¶–ò–Ø 1: –î–ò–ê–õ–û–ì –° –û–ü–ï–†–ê–¢–û–†–ê (–°–™–ë–ò–†–ê–ù–ï –ù–ê –î–ê–ù–ù–ò)
  # ===========================================================
  # –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ –æ—Ç todo.modules
  SERVER_IP=$(grep '^SERVER_IP=' "$MODULES_FILE" | awk -F'=' '{print $2}' | tr -d '"')
  echo "‚ÑπÔ∏è –ó–∞—Å–µ—á–µ–Ω IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: $SERVER_IP"
  echo ""

  # –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ VPN –ø–æ–¥–º—Ä–µ–∂–∞
  while true; do
    read -p "üåê –í—ä–≤–µ–¥–µ—Ç–µ VPN –ø–æ–¥–º—Ä–µ–∂–∞ (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ 10.20.0.0/24): " VPN_SUBNET
    VPN_SUBNET=${VPN_SUBNET:-10.20.0.0/24}
    if [[ "$VPN_SUBNET" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$ ]]; then
      break
    else
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ CIDR, –Ω–∞–ø—Ä. 10.20.0.0/24."
    fi
  done

  # –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ VPN –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
  while true; do
    read -p "üîë –í—ä–≤–µ–¥–µ—Ç–µ VPN IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ 10.20.0.1): " VPN_SERVER_IP
    VPN_SERVER_IP=${VPN_SERVER_IP:-10.20.0.1}
    if [[ "$VPN_SERVER_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+.[0-9]+$ ]]; then
      break
    else
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –ü—Ä–∏–º–µ—Ä: 10.20.0.1"
    fi
  done

  # –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ—Ä—Ç
  while true; do
    read -p "üì° –í—ä–≤–µ–¥–µ—Ç–µ –ø–æ—Ä—Ç –∑–∞ WireGuard (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ 51820): " WG_PORT
    WG_PORT=${WG_PORT:-51820}
    if [[ "$WG_PORT" =~ ^[0-9]+$ && "$WG_PORT" -ge 1024 && "$WG_PORT" -le 65535 ]]; then
      break
    else
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –ø–æ—Ä—Ç. –î–æ–ø—É—Å—Ç–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω: 1024-65535."
    fi
  done

  # –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
  echo ""
  echo "–ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –≤—ä–≤–µ–¥–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏:"
  echo "---------------------------------"
  echo "–ü—É–±–ª–∏—á–µ–Ω IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: $SERVER_IP"
  echo "VPN –ø–æ–¥–º—Ä–µ–∂–∞:          $VPN_SUBNET"
  echo "VPN IP –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞:     $VPN_SERVER_IP"
  echo "WireGuard –ø–æ—Ä—Ç:        $WG_PORT"
  echo "---------------------------------"
  read -p "‚úÖ –ü–æ—Ç–≤—ä—Ä–∂–¥–∞–≤–∞—Ç–µ –ª–∏? (y/n): " confirm
  if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
    exit 0
  fi

  # –ó–∞–ø–∏—Å –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –≤ todo.modules
  for VAR in VPN_SUBNET VPN_SERVER_IP WG_PORT; do
    VALUE=$(eval echo "\$$VAR")
    if grep -q "^$VAR=" "$MODULES_FILE" 2>/dev/null; then
      sed -i "s|^$VAR=.*|$VAR=\"$VALUE\"|" "$MODULES_FILE"
    else
      echo "$VAR=\"$VALUE\"" >> "$MODULES_FILE"
    fi
  done

  # ===========================================================
  # –°–ï–ö–¶–ò–Ø 2: –ò–ó–ü–™–õ–ù–ï–ù–ò–ï
  # ===========================================================
  echo ""
  echo "üîç –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ WireGuard..."
  
  # –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è
  if ! command -v wg &>/dev/null; then
    apt update && apt install -y wireguard wireguard-tools
  fi

  # –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ
  SERVER_PRIVATE_KEY=$(wg genkey)
  SERVER_PUBLIC_KEY=$(echo "$SERVER_PRIVATE_KEY" | wg pubkey)

  # –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  cat <<EOF > "$WG_CONF"
[Interface]
Address = $VPN_SERVER_IP/24
ListenPort = $WG_PORT
PrivateKey = $SERVER_PRIVATE_KEY

PostUp = sysctl -w net.ipv4.ip_forward=1
PostDown = sysctl -w net.ipv4.ip_forward=0
SaveConfig = true
EOF

  chmod 600 "$WG_CONF"

  # –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ
  systemctl enable --now wg-quick@wg0

  if systemctl is-active --quiet wg-quick@wg0; then
    echo "‚úÖ WireGuard –µ –∞–∫—Ç–∏–≤–µ–Ω."
  else
    echo "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ WireGuard."
    exit 1
  fi

  # –ó–∞–ø–∏—Å –≤ setup.env
  if grep -q '^VPN_RESULT_MODULE3=' "$SETUP_ENV_FILE" 2>/dev/null; then
    sed -i 's|^VPN_RESULT_MODULE3=.*|VPN_RESULT_MODULE3=‚úÖ|' "$SETUP_ENV_FILE"
  else
    echo "VPN_RESULT_MODULE3=‚úÖ" >> "$SETUP_ENV_FILE"
  fi

  echo "‚úÖ –ú–æ–¥—É–ª 3 –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ."
fi
echo ""
echo ""


exit 0
