#!/bin/bash

# ==========================================================================
#  vps-base-qsetup - –ë–∞–∑–æ–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ VPS —Å—ä—Ä–≤—ä—Ä (–ª–æ–∫–∞–ª–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ)
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-06-19
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∏–∑–≤—ä—Ä—à–≤–∞ –Ω–∞—á–∞–ª–Ω–∞, –±–µ–∑–æ–ø–∞—Å–Ω–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞
#  VPS —Å—ä—Ä–≤—ä—Ä. –ò–∑–ø—ä–ª–Ω—è–≤–∞ —Å–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞, –Ω–µ –∏–∑–∏—Å–∫–≤–∞ SSH –∫—ä–º –¥—Ä—É–≥–∏ –º–∞—à–∏–Ω–∏.
#
#  –ï—Ç–∞–ø–∏:
#    1. –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω—É–∂–Ω–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
#    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç
#    3. –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
#    4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
# ==========================================================================

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-base-qsetup.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –Ω–∞—á–∞–ª–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ –ª–æ–∫–∞–ª–µ–Ω VPS —Å—ä—Ä–≤—ä—Ä."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-base-qsetup –≤–µ—Ä—Å–∏—è 1.0 (19 —é–Ω–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

# === –ü–û–ö–ê–ó–í–ê–ù–ï –ù–ê –ó–ê–ì–õ–ê–í–ò–ï–¢–û ===============================================
echo -e "\e[32m=========================================="
echo -e " –ù–ê–ß–ê–õ–ù–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –û–¢–î–ê–õ–ï–ß–ï–ù –°–™–†–í–™–†"
echo -e "==========================================\e[0m"
echo ""

# === –ì–õ–û–ë–ê–õ–ù–ò –ü–†–û–ú–ï–ù–õ–ò–í–ò ===================================================
SERVER_IP="$(ip route get 1.1.1.1 | grep -oP 'src \K[\d.]+')"
SSH_PORT="22"
FQDN=""
ADMIN_USER=""
CONFIRMATION=""
FIREWALL_SYSTEM="unknown"

# === –°–¢–™–ü–ö–ê 1: –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ó–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø–¢–ê ====================
echo "== –°–¢–™–ü–ö–ê 1: –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ó–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø–¢–ê =="
echo ""

# --- [1] –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –°–™–†–í–™–†–ï–ù –î–û–ú–ï–ô–ù (FQDN) -----------------------------
echo "[1] –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –°–™–†–í–™–†–ï–ù –î–û–ú–ï–ô–ù (FQDN)..."
echo "-------------------------------------------------------------------------"
echo ""

while true; do
  printf "üëâ –í—ä–≤–µ–¥–µ—Ç–µ –¥–æ–º–µ–π–Ω–∞ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ (FQDN) –∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥: "
  read FQDN

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
  if [[ "$FQDN" == "q" || "$FQDN" == "Q" ]]; then
    echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
    exit 0
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –≤—Ö–æ–¥—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω
  if [[ -z "$FQDN" ]]; then
    echo "‚ùå –î–æ–º–µ–π–Ω—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–∞–∑–µ–Ω. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
    continue
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –¥–æ–º–µ–π–Ω (–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞–Ω–µ)
  if [[ ! "$FQDN" =~ ^([a-zA-Z0-9][-a-zA-Z0-9]*\.)+[a-zA-Z]{2,}$ ]]; then
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –¥–æ–º–µ–π–Ω. –ü—Ä–∏–º–µ—Ä –∑–∞ –≤–∞–ª–∏–¥–µ–Ω: example.com"
    continue
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –¥–æ–º–µ–π–Ω—ä—Ç —Ä–µ–∑–æ–ª–≤–∏—Ä–∞ (–ø–æ –∏–∑–±–æ—Ä)
  if ! getent hosts "$FQDN" >/dev/null; then
    echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –î–æ–º–µ–π–Ω—ä—Ç '$FQDN' –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ä–∞ –≤ –º–æ–º–µ–Ω—Ç–∞."
    printf "–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ —Å —Ç–æ–∑–∏ –¥–æ–º–µ–π–Ω? [y/N]: "
    read confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
      continue
    fi
  fi

  break
done
echo ""
echo ""


# --- [2] –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê SSH –ü–û–†–¢ -----------------------------------------------
echo "[2] –û–ü–†–ï–î–ï–õ–Ø–ù–ï –ù–ê SSH –ü–û–†–¢..."
echo "-------------------------------------------------------------------------"
echo ""

# –û—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è SSH –ø–æ—Ä—Ç –æ—Ç sshd –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ (–∞–∫–æ –µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
CURRENT_SSH_PORT=$(ss -tlpn | grep sshd | awk -F: '/LISTEN/ {print $2}' | head -n 1)
CURRENT_SSH_PORT="${CURRENT_SSH_PORT:-22}"

while true; do
  printf "üëâ –í –º–æ–º–µ–Ω—Ç–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ SSH –ø–æ—Ä—Ç $CURRENT_SSH_PORT. –ñ–µ–ª–∞–µ—Ç–µ –ª–∏ –¥–∞ –≥–æ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ? (y –∑–∞ –ø—Ä–æ–º—è–Ω–∞, Enter –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ, q –∑–∞ –∏–∑—Ö–æ–¥): "
  read change_port

  if [[ "$change_port" == "q" || "$change_port" == "Q" ]]; then
    echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
    exit 0
  elif [[ "$change_port" == "y" || "$change_port" == "Y" ]]; then
    while true; do
      printf "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ –Ω–æ–≤ SSH –ø–æ—Ä—Ç (–º–µ–∂–¥—É 1024 –∏ 65535) –∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥: "
      read SSH_PORT

      if [[ "$SSH_PORT" == "q" || "$SSH_PORT" == "Q" ]]; then
        echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
        exit 0
      elif [[ "$SSH_PORT" =~ ^[0-9]+$ ]] && (( SSH_PORT >= 1024 && SSH_PORT <= 65535 )); then
        echo "‚úÖ –ù–æ–≤ SSH –ø–æ—Ä—Ç —â–µ –±—ä–¥–µ: $SSH_PORT"
        break
      else
        echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –ø–æ—Ä—Ç. –î–æ–ø—É—Å—Ç–∏–º–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏: 1024‚Äì65535. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
      fi
    done
    break
  else
    SSH_PORT="$CURRENT_SSH_PORT"
    echo "‚úÖ SSH –ø–æ—Ä—Ç—ä—Ç —â–µ –æ—Å—Ç–∞–Ω–µ: $SSH_PORT"
    break
  fi
done
echo ""
echo ""


# --- [3] –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–°–ö–ò –ü–†–û–§–ò–õ -----------------------------------------------
echo "[3] –°–™–ó–î–ê–í–ê–ù–ï –ù–ê –ù–û–í –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–°–ö–ò –ü–†–û–§–ò–õ"
echo "-------------------------------------------------------------------------"
echo "üîê –ü–æ —Å—ä–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç, root –¥–æ—Å—Ç—ä–ø—ä—Ç —á—Ä–µ–∑ SSH —â–µ –±—ä–¥–µ –∑–∞–±—Ä–∞–Ω–µ–Ω."
echo "‚úÖ –©–µ —Å—ä–∑–¥–∞–¥–µ–º –Ω–æ–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª —Å root –ø—Ä–∞–≤–∞ –∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ —Ä–∞–±–æ—Ç–∞."
echo ""

while true; do
  printf "üëâ –í—ä–≤–µ–¥–µ—Ç–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ –∑–∞ –Ω–æ–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (q –∑–∞ –∏–∑—Ö–æ–¥): "
  read ADMIN_USER

  if [[ "$ADMIN_USER" == "q" || "$ADMIN_USER" == "Q" ]]; then
    echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
    exit 0
  fi

  if [[ -z "$ADMIN_USER" ]]; then
    echo "‚ùå –ü–æ–ª–µ—Ç–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ –∏–º–µ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–∞–∑–Ω–æ."
    continue
  fi

  if [[ ! "$ADMIN_USER" =~ ^[a-z_][a-z0-9_-]*$ ]]; then
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ. –†–∞–∑—Ä–µ—à–µ–Ω–∏ —Å–∞ —Å–∞–º–æ –º–∞–ª–∫–∏ –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏, '-', '_' –∏ –¥–∞ –Ω–µ –∑–∞–ø–æ—á–≤–∞ —Å —Ü–∏—Ñ—Ä–∞."
    continue
  fi

  if id "$ADMIN_USER" &>/dev/null; then
    echo "‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç '$ADMIN_USER' –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞. –ò–∑–±–µ—Ä–µ—Ç–µ –¥—Ä—É–≥–æ –∏–º–µ."
    continue
  fi

  break
done

while true; do
  printf "üîë –í—ä–≤–µ–¥–µ—Ç–µ –ø–∞—Ä–æ–ª–∞ –∑–∞ $ADMIN_USER: "
  read -s PASSWORD_1
  echo
  printf "üîë –ü–æ–≤—Ç–æ—Ä–µ—Ç–µ –ø–∞—Ä–æ–ª–∞—Ç–∞: "
  read -s PASSWORD_2
  echo

  if [[ "$PASSWORD_1" != "$PASSWORD_2" ]]; then
    echo "‚ùå –ü–∞—Ä–æ–ª–∏—Ç–µ –Ω–µ —Å—ä–≤–ø–∞–¥–∞—Ç. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  elif [[ -z "$PASSWORD_1" ]]; then
    echo "‚ùå –ü–∞—Ä–æ–ª–∞—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø—Ä–∞–∑–Ω–∞."
  else
    break
  fi
done
echo ""
echo ""


# --- [4] –ü–†–û–í–ï–†–ö–ê –ù–ê FIREWALL –°–ò–°–¢–ï–ú–ê --------------------------------------------
echo "[4] –ü–†–û–í–ï–†–ö–ê –ù–ê FIREWALL –°–ò–°–¢–ï–ú–ê..."
echo "-------------------------------------------------------------------------"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ ufw –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω
if command -v ufw >/dev/null 2>&1; then
  FIREWALL_SYSTEM="ufw"
  echo "üõ°Ô∏è  –ó–∞—Å–µ—á–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞: UFW"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ UFW
  UFW_STATUS=$(ufw status | head -n 1)
  echo "‚ÑπÔ∏è  –°—Ç–∞—Ç—É—Å –Ω–∞ UFW: $UFW_STATUS"

  echo "üìñ –°–ø–∏—Å—ä–∫ –Ω–∞ –æ—Ç–≤–æ—Ä–µ–Ω–∏—Ç–µ/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—Ç–µ –ø–æ—Ä—Ç–æ–≤–µ –≤ UFW:"
  ufw status numbered | sed 's/^/    /'
else
  echo "‚ö†Ô∏è  –ù–µ –µ –æ—Ç–∫—Ä–∏—Ç–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞ UFW."
  FIREWALL_SYSTEM="none"
fi

# --- [4.1] –î–ò–ê–õ–û–ì –ó–ê FIREWALL –°–ò–°–¢–ï–ú–ê–¢–ê -------------------------------------------
if [[ "$FIREWALL_SYSTEM" != "ufw" ]]; then
  echo ""
  if [[ "$FIREWALL_SYSTEM" == "none" ]]; then
    echo "‚ö†Ô∏è  –í–∞—à–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –≤ –º–æ–º–µ–Ω—Ç–∞ –Ω–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞."
  else
    echo "‚ö†Ô∏è  –í –º–æ–º–µ–Ω—Ç–∞ –≤–∞—à–∞—Ç–∞ –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞ –µ: $FIREWALL_SYSTEM"
  fi

  echo "üí° –í –±—ä–¥–µ—â–µ —â–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ UFW –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∑–∞—â–∏—Ç–Ω–∞—Ç–∞ —Å—Ç–µ–Ω–∞."
  while true; do
    printf "–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ Enter –∑–∞ —Å—ä–≥–ª–∞—Å–∏–µ –∏–ª–∏ 'q' –∑–∞ –æ—Ç–∫–∞–∑ –∏ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ: "
    read consent
    if [[ "$consent" == "q" || "$consent" == "Q" ]]; then
      echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    else
      echo "‚úÖ –ò–∑–±—Ä–∞–Ω–æ: —â–µ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ UFW."
      break
    fi
  done
fi
echo ""
echo ""

# --- [4.2] –í–™–í–ï–ñ–î–ê–ù–ï –ù–ê –î–û–ü–™–õ–ù–ò–¢–ï–õ–ù–ò FIREWALL –ü–û–†–¢–û–í–ï ----------------------------
PORT_LIST=()

if [[ "$FIREWALL_SYSTEM" != "none" ]]; then
  echo ""
  echo "üì° –ó–∞—Å–µ—á–µ–Ω–∏ –æ—Ç–≤–æ—Ä–µ–Ω–∏ –ø–æ—Ä—Ç–æ–≤–µ –≤—ä–≤ –≤–∞—à–∞—Ç–∞ –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞:"

  if [[ "$FIREWALL_SYSTEM" == "ufw" ]]; then
    ufw status numbered | awk '/ALLOW/ {print $1, $2, $3, $4}' | sed 's/^/  - /'
  else
    # –ó–∞ –¥—Ä—É–≥–∏ —Å–∏—Å—Ç–µ–º–∏ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ ss –∫–∞—Ç–æ –Ω–∞–π-–æ–±—â –ø–æ–¥—Ö–æ–¥
    ss -tuln | awk 'NR>1 {print $5}' | cut -d: -f2 | sort -nu | sed 's/^/  - /'
  fi

  while true; do
    printf "‚ûï –ñ–µ–ª–∞–µ—Ç–µ –ª–∏ –¥–∞ –æ—Ç–≤–æ—Ä–∏—Ç–µ –Ω–æ–≤–∏ –ø–æ—Ä—Ç–æ–≤–µ? (y –∑–∞ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ, Enter –∑–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–µ, q –∑–∞ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ): "
    read open_more
    if [[ "$open_more" == "q" || "$open_more" == "Q" ]]; then
      echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    elif [[ "$open_more" == "y" || "$open_more" == "Y" ]]; then
      break
    else
      echo "üîí –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–∏ –ø–æ—Ä—Ç–æ–≤–µ."
      open_more=""
      break
    fi
  done
fi

if [[ "$FIREWALL_SYSTEM" == "none" || "$open_more" == "y" || "$open_more" == "Y" ]]; then
  echo ""
  echo "üß© –í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –ø–æ—Ä—Ç–æ–≤–µ –∑–∞ –æ—Ç–≤–∞—Ä—è–Ω–µ –≤—ä–≤ –≤–∞—à–∞—Ç–∞ –±—ä–¥–µ—â–∞ –∑–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞ (UFW):"
  while true; do
    printf "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ –ø–æ—Ä—Ç –∑–∞ –æ—Ç–≤–∞—Ä—è–Ω–µ (Enter –∑–∞ –∫—Ä–∞–π, q –∑–∞ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ): "
    read port
    if [[ "$port" == "q" || "$port" == "Q" ]]; then
      echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
      exit 0
    elif [[ -z "$port" ]]; then
      break
    elif [[ "$port" =~ ^[0-9]+$ ]] && (( port >= 1 && port <= 65535 )); then
      PORT_LIST+=("$port")
      echo "‚úÖ –î–æ–±–∞–≤–µ–Ω –ø–æ—Ä—Ç: $port"
    else
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ –ø–æ—Ä—Ç. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ —á–∏—Å–ª–æ –º–µ–∂–¥—É 1 –∏ 65535."
    fi
  done
fi
echo ""
echo ""


# === –û–ë–û–ë–©–ï–ù–ò–ï =============================================================
echo "[5] –ü–†–ï–ì–õ–ï–î –ù–ê –í–™–í–ï–î–ï–ù–ê–¢–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø..."
echo "-------------------------------------------------------------------------"
echo ""
echo ""

echo "‚úÖ –í—ä–≤–µ–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo " - –î–æ–º–µ–π–Ω (FQDN): $FQDN"
echo " - SSH –ø–æ—Ä—Ç: $SSH_PORT"
echo " - –ê–¥–º–∏–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª: $ADMIN_USER"
echo " - Root –¥–æ—Å—Ç—ä–ø –ø–æ SSH: —â–µ –±—ä–¥–µ –∑–∞–±—Ä–∞–Ω–µ–Ω"

echo " - IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: $SERVER_IP"
echo " - –ó–∞—â–∏—Ç–Ω–∞ —Å—Ç–µ–Ω–∞: $FIREWALL_SYSTEM"
if [[ ${#PORT_LIST[@]} -gt 0 ]]; then
  echo " - –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –ø–æ—Ä—Ç–æ–≤–µ –∑–∞ –æ—Ç–≤–∞—Ä—è–Ω–µ: ${PORT_LIST[*]}"
fi

echo ""
echo "üßê –ú–æ–ª—è, –ø—Ä–µ–≥–ª–µ–¥–∞–π—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª–Ω–æ –≤—ä–≤–µ–¥–µ–Ω–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ-–≥–æ—Ä–µ."
echo "–ê–∫–æ –≤—Å–∏—á–∫–æ –µ –≤—è—Ä–Ω–æ, –º–æ–∂–µ—Ç–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è."
echo "–ê–∫–æ –∏–º–∞ –≥—Ä–µ—à–∫–∞, –ø—Ä–µ–∫—Ä–∞—Ç–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç–∞, –∫–æ—Ä–∏–≥–∏—Ä–∞–π—Ç–µ –∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
echo ""

while true; do
  printf "‚úîÔ∏è –ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞–º–µ –ª–∏ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞? (y –∑–∞ –ø—Ä–æ–¥—ä–ª–∂–µ–Ω–∏–µ, q –∑–∞ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ): "
  read CONFIRMATION
  if [[ "$CONFIRMATION" == "q" || "$CONFIRMATION" == "Q" ]]; then
    echo "‚ùé –°–∫—Ä–∏–ø—Ç—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è."
    exit 0
  elif [[ "$CONFIRMATION" == "y" || "$CONFIRMATION" == "Y" ]]; then
    echo "üöÄ –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è..."
    sleep 1
    clear
    break
  else
    echo "‚ùå –ú–æ–ª—è, –æ—Ç–≥–æ–≤–æ—Ä–µ—Ç–µ —Å 'y' –∑–∞ –ø—Ä–æ–¥—ä–ª–∂–µ–Ω–∏–µ –∏–ª–∏ 'q' –∑–∞ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ."
  fi
done
echo ""
echo ""

# === –°–¢–™–ü–ö–ê 2: –ö–û–ù–§–ò–ì–£–†–ò–†–ê–ù–ï –ù–ê –°–ò–°–¢–ï–ú–ê–¢–ê =======================================
echo "== –°–¢–™–ü–ö–ê 2: –ö–û–ù–§–ò–ì–£–†–ò–†–ê–ù–ï –ù–ê –°–ò–°–¢–ï–ú–ê–¢–ê =="

echo ""
echo ""
echo "[6] –û–ë–ù–û–í–Ø–í–ê–ù–ï –ù–ê –°–ò–°–¢–ï–ú–ê–¢–ê..."
echo "-------------------------------------------------------------------------"

if sudo apt-get update && sudo apt-get upgrade -y && sudo apt-get autoremove -y; then
  echo "‚úÖ –°–∏—Å—Ç–µ–º–∞—Ç–∞ –µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–µ–Ω–∞."
  RESULT_UPDATE_SYSTEM="‚úÖ"
else
  echo "‚ùå –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –≥–æ—Ä–Ω–∏—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏—è."
  RESULT_UPDATE_SYSTEM="‚ùå"
  exit 1
fi
echo ""
echo ""

echo "[7] –ò–ù–°–¢–ê–õ–ò–†–ê–ù–ï –ù–ê –û–°–ù–û–í–ù–ò–¢–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–ò..."
echo "-------------------------------------------------------------------------"

if sudo apt-get install -y \
    nano unzip git curl wget net-tools htop \
    python3 python3-pip python3-venv build-essential; then
  echo "‚úÖ –í—Å–∏—á–∫–∏ –æ—Å–Ω–æ–≤–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏."
  RESULT_INSTALL_TOOLS="‚úÖ"
else
  echo "‚ùå –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è—Ç–∞. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ:"
  echo "1. –î–∞–ª–∏ apt-get cache –µ –æ–±–Ω–æ–≤–µ–Ω (–≤ –ø—Ä–µ–¥—Ö–æ–¥–Ω–∞—Ç–∞ —Å—Ç—ä–ø–∫–∞)"
  echo "2. –î–∞–ª–∏ –∏–º–∞ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –¥–∏—Å–∫–æ–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ"
  RESULT_INSTALL_TOOLS="‚ùå"
  exit 1
fi
echo ""
echo ""

echo "[8] –°–™–ó–î–ê–í–ê–ù–ï –ù–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–°–ö–ò –ü–û–¢–†–ï–ë–ò–¢–ï–õ..."
echo "-------------------------------------------------------------------------"
RESULT_CREATE_ADMIN_USER="‚ùî"

# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
if id "$ADMIN_USER" &>/dev/null; then
  echo "‚ÑπÔ∏è –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç '$ADMIN_USER' –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ ‚Äì –ø—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ—Ç–æ."
  RESULT_CREATE_ADMIN_USER="‚ö†Ô∏è"
else
  if sudo adduser --disabled-password --gecos "" "$ADMIN_USER" && \
     echo "$ADMIN_USER:$PASSWORD_1" | sudo chpasswd && \
     sudo usermod -aG sudo "$ADMIN_USER"; then
    echo "‚úÖ –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç '$ADMIN_USER' –µ —Å—ä–∑–¥–∞–¥–µ–Ω –∏ –¥–æ–±–∞–≤–µ–Ω –∫—ä–º sudo –≥—Ä—É–ø–∞—Ç–∞."
    RESULT_CREATE_ADMIN_USER="‚úÖ"
  else
    echo "‚ùå –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è '$ADMIN_USER'."
    RESULT_CREATE_ADMIN_USER="‚ùå"
    exit 1
  fi
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ SSH –¥–æ—Å—Ç—ä–ø (–∫–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–µ—Ç–µ –æ—Ç root)
if [[ -f /root/.ssh/authorized_keys ]]; then
  if sudo mkdir -p /home/"$ADMIN_USER"/.ssh && \
     sudo cp /root/.ssh/authorized_keys /home/"$ADMIN_USER"/.ssh/ && \
     sudo chown -R "$ADMIN_USER":"$ADMIN_USER" /home/"$ADMIN_USER"/.ssh && \
     sudo chmod 700 /home/"$ADMIN_USER"/.ssh && \
     sudo chmod 600 /home/"$ADMIN_USER"/.ssh/authorized_keys; then
    echo "‚úÖ –ö–æ–ø–∏—Ä–∞–Ω–∏ —Å–∞ SSH –∫–ª—é—á–æ–≤–µ—Ç–µ –æ—Ç root."
  else
    echo "‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ SSH –∫–ª—é—á–æ–≤–µ—Ç–µ."
    RESULT_CREATE_ADMIN_USER="‚ö†Ô∏è"
  fi
else
  echo "‚ö†Ô∏è –ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ SSH –∫–ª—é—á–æ–≤–µ –∑–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ –æ—Ç root."
fi
echo ""
echo ""

echo "[9] –ù–ê–°–¢–†–û–ô–ö–ê –ù–ê –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò..."
echo "-------------------------------------------------------------------------"
RESULT_LOCALE_SETUP="‚ùî"

# –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ –µ–∑–∏–∫–æ–≤–∏ –ø–∞–∫–µ—Ç–∏
if ! sudo apt-get install -y language-pack-bg language-pack-ru; then
  echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ù–µ—É—Å–ø–µ—à–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ –µ–∑–∏–∫–æ–≤–∏ –ø–∞–∫–µ—Ç–∏. –ü—Ä–æ–¥—ä–ª–∂–µ–Ω–∏–µ –±–µ–∑ —Ç—è—Ö."
  RESULT_LOCALE_SETUP="‚ö†Ô∏è"
fi

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ /etc/locale.gen
sudo sed -i '/^# *bg_BG.UTF-8 UTF-8/s/^# *//g' /etc/locale.gen
sudo sed -i '/^# *ru_RU.UTF-8 UTF-8/s/^# *//g' /etc/locale.gen
sudo sed -i '/^# *en_US.UTF-8 UTF-8/s/^# *//g' /etc/locale.gen

# –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ª–æ–∫–∞–ª–∏ –∞–∫–æ –ª–∏–ø—Å–≤–∞—Ç
grep -qxF 'bg_BG.UTF-8 UTF-8' /etc/locale.gen || echo 'bg_BG.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null
grep -qxF 'ru_RU.UTF-8 UTF-8' /etc/locale.gen || echo 'ru_RU.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null
grep -qxF 'en_US.UTF-8 UTF-8' /etc/locale.gen || echo 'en_US.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null

# –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ª–æ–∫–∞–ª–∏
if sudo locale-gen && sudo update-locale; then
  echo "‚úÖ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏—Ç–µ —Å–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏."
  [[ "$RESULT_LOCALE_SETUP" == "‚ùî" ]] && RESULT_LOCALE_SETUP="‚úÖ"
else
  echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ª–æ–∫–∞–ª–∏. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ä—ä—á–Ω–æ."
  RESULT_LOCALE_SETUP="‚ùå"
fi
echo ""
echo ""

echo "[10] –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –í–†–ï–ú–ï–í–ê –ó–û–ù–ê UTC..."
echo "-------------------------------------------------------------------------"
RESULT_TIMEZONE_SETUP="‚ùî"

# –ü—Ä–æ–º—è–Ω–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—Ç–∞ —á–∞—Å–æ–≤–∞ –∑–æ–Ω–∞ –Ω–∞ UTC
if sudo timedatectl set-timezone UTC; then
  echo "‚úÖ –í—Ä–µ–º–µ–≤–∞—Ç–∞ –∑–æ–Ω–∞ –µ –∑–∞–¥–∞–¥–µ–Ω–∞ –Ω–∞ UTC."
  RESULT_TIMEZONE_SETUP="‚úÖ"
else
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–∞ —Å–º—è–Ω–∞ –Ω–∞ –≤—Ä–µ–º–µ–≤–∞—Ç–∞ –∑–æ–Ω–∞. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ä—ä—á–Ω–æ."
  RESULT_TIMEZONE_SETUP="‚ùå"
  exit 1
fi
echo ""
echo ""

echo "[11] –ù–ê–°–¢–†–û–ô–ö–ê –ù–ê –í–†–ï–ú–ï–í–ê–¢–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø..."
echo "-------------------------------------------------------------------------"
RESULT_TIME_SYNC="‚ùî"

# –°–ø–∏—Ä–∞–Ω–µ –Ω–∞ –¥—Ä—É–≥–∏ NTP —É—Å–ª—É–≥–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∞–∫—Ç–∏–≤–Ω–∏ NTP —É—Å–ª—É–≥–∏..."
sudo systemctl stop ntpd 2>/dev/null && sudo systemctl disable ntpd 2>/dev/null
sudo systemctl stop systemd-timesyncd 2>/dev/null && sudo systemctl disable systemd-timesyncd 2>/dev/null

# –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ chrony
echo "üì¶ –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ chrony..."
if ! sudo apt-get install -y chrony; then
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ chrony."
  RESULT_TIME_SYNC="‚ùå"
  exit 1
fi

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ chrony —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª–Ω–∏ —Å—ä—Ä–≤—ä—Ä–∏
NTP_SERVERS=(0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org)
echo "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ chrony —Å –ø—É–±–ª–∏—á–Ω–∏ —Å—ä—Ä–≤—ä—Ä–∏: ${NTP_SERVERS[*]}"
echo -e "server ${NTP_SERVERS[0]} iburst
server ${NTP_SERVERS[1]} iburst
server ${NTP_SERVERS[2]} iburst
server ${NTP_SERVERS[3]} iburst

rtcsync
makestep 1.0 3
driftfile /var/lib/chrony/drift
logdir /var/log/chrony" | sudo tee /etc/chrony/chrony.conf > /dev/null

# –†–µ—Å—Ç–∞—Ä—Ç –∏ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ
sudo systemctl restart chrony
sudo systemctl enable chrony

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è—Ç–∞..."
timedatectl | grep 'Time zone'
echo "NTP —Å—Ç–∞—Ç—É—Å:"
chronyc tracking | grep -E 'Stratum|System time'
chronyc sources | grep '^\^\*'

echo "‚úÖ –í—Ä–µ–º–µ–≤–∞—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–∞."
RESULT_TIME_SYNC="‚úÖ"

echo ""
echo ""

echo "[12] –ù–ê–°–¢–†–û–ô–ö–ê –ù–ê HOSTNAME..."
echo "-------------------------------------------------------------------------"
RESULT_HOSTNAME="‚ùî"

# –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫—Ä–∞—Ç–∫–æ—Ç–æ –∏–º–µ –Ω–∞ —Ö–æ—Å—Ç–∞ –æ—Ç FQDN
HOSTNAME_SHORT="${FQDN%%.*}"

# –ó–∞–¥–∞–≤–∞–Ω–µ –Ω–∞ hostname
if sudo hostnamectl set-hostname "$FQDN"; then
  echo "‚úÖ Hostname –∑–∞–¥–∞–¥–µ–Ω –Ω–∞: $FQDN"
  RESULT_HOSTNAME="‚úÖ"
else
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–∞ —Å–º—è–Ω–∞ –Ω–∞ hostname."
  RESULT_HOSTNAME="‚ùå"
  exit 1
fi

# –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ /etc/hosts
sudo tee /etc/hosts > /dev/null <<EOF
127.0.0.1   localhost
127.0.1.1   $FQDN $HOSTNAME_SHORT
::1         localhost ip6-localhost ip6-loopback
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters
EOF

echo "‚úÖ /etc/hosts –µ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω."
echo ""
echo ""

# === –°–¢–™–ü–ö–ê 3: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê UFW –ò –†–ï–°–¢–ê–†–¢ –ù–ê –°–™–†–í–™–†–ê ==========================
echo "=== –°–¢–™–ü–ö–ê 3: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê UFW –ò –†–ï–°–¢–ê–†–¢ –ù–ê –°–™–†–í–™–†–ê"
echo ""

echo "[13] –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê UFW –ò –†–ï–°–¢–ê–†–¢ –ù–ê –°–™–†–í–™–†–ê..."
echo "-------------------------------------------------------------------------"
RESULT_UFW_CONFIG="‚ùî"

# --- –î–û–ë–ê–í–Ø–ù–ï –ù–ê –î–û–ü–™–õ–ù–ò–¢–ï–õ–ù–ò –î–û–í–ï–†–ï–ù–ò –ú–†–ï–ñ–ò (–ø–æ –∏–∑–±–æ—Ä) ----------------------
echo ""
echo "üåê –ê–∫–æ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ —á–∞—Å—Ç–Ω–∞ –º—Ä–µ–∂–∞ (VPN, –ª–æ–∫–∞–ª–Ω–∞ LAN –∏ —Ç.–Ω.), –º–æ–∂–µ—Ç–µ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞ –Ω–µ—è –≤ UFW."
TRUSTED_NETS=()
while true; do
  read -rp "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ CIDR –Ω–∞ –¥–æ–≤–µ—Ä–µ–Ω–∞ –º—Ä–µ–∂–∞ (–Ω–∞–ø—Ä. 192.168.1.0/24), Enter –∑–∞ –∫—Ä–∞–π: " net
  if [[ -z "$net" ]]; then
    break
  elif [[ "$net" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$ ]]; then
    TRUSTED_NETS+=("$net")
    echo "‚úÖ –î–æ–±–∞–≤–µ–Ω–∞ –º—Ä–µ–∂–∞: $net"
  else
    echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ CIDR, –Ω–∞–ø—Ä. 10.8.0.0/24"
  fi
done

for net in "${TRUSTED_NETS[@]}"; do
  echo "üîê –†–∞–∑—Ä–µ—à–∞–≤–∞–Ω–µ –Ω–∞ –¥–æ—Å—Ç—ä–ø –æ—Ç $net –∫—ä–º –≤—Å–∏—á–∫–∏ –ø–æ—Ä—Ç–æ–≤–µ..."
  sudo ufw allow from "$net"
done

# –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ UFW, –∞–∫–æ –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω
if ! command -v ufw >/dev/null 2>&1; then
  echo "üì¶ –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ UFW..."
  if ! sudo apt-get install -y ufw; then
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ UFW."
    RESULT_UFW_CONFIG="‚ùå"
    exit 1
  fi
fi

# –†–∞–∑—Ä–µ—à–∞–≤–∞–Ω–µ –Ω–∞ –∑–∞–ø–∏—Å–∞–Ω–∏—Ç–µ –ø–æ—Ä—Ç–æ–≤–µ
for port in "${PORT_LIST[@]}"; do
  echo "üîì –û—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –ø–æ—Ä—Ç $port..."
  sudo ufw allow "$port"
done

# –†–∞–∑—Ä–µ—à–∞–≤–∞–Ω–µ –Ω–∞ SSH –ø–æ—Ä—Ç–∞, –∞–∫–æ –Ω–µ –µ –≤–µ—á–µ –¥–æ–±–∞–≤–µ–Ω
sudo ufw allow "$SSH_PORT"

# –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ UFW
if sudo ufw --force enable; then
  echo "‚úÖ UFW –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω."
  RESULT_UFW_CONFIG="‚úÖ"
else
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ UFW."
  RESULT_UFW_CONFIG="‚ùå"
  exit 1
fi
echo ""
echo ""

echo "[14] –û–ë–û–ë–©–ï–ù–ò–ï –ù–ê –†–ï–ó–£–õ–¢–ê–¢–ò–¢–ï –û–¢ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø–¢–ê"
echo "-------------------------------------------------------------------------"

printf "üìå –°–∏—Å—Ç–µ–º–Ω–æ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ:             %s\n" "${RESULT_SYSTEM_UPDATE:-‚ùî}"
printf "üìå –û—Å–Ω–æ–≤–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏:             %s\n" "${RESULT_BASE_TOOLS:-‚ùî}"
printf "üìå –ê–¥–º–∏–Ω. –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:               %s\n" "${RESULT_ADMIN_USER:-‚ùî}"
printf "üìå –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏:                     %s\n" "${RESULT_LOCALES:-‚ùî}"
printf "üìå –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞:                     %s\n" "${RESULT_TIMEZONE:-‚ùî}"
printf "üìå –í—Ä–µ–º–µ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:          %s\n" "${RESULT_NTP_SYNC:-‚ùî}"
printf "üìå Hostname:                        %s\n" "${RESULT_HOSTNAME:-‚ùî}"
printf "üìå UFW –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:                %s\n" "${RESULT_UFW_CONFIG:-‚ùî}"

echo ""
echo "‚ÑπÔ∏è  –õ–µ–≥–µ–Ω–¥–∞: ‚úÖ —É—Å–ø–µ—à–Ω–æ | ‚ùå –Ω–µ—É—Å–ø–µ—à–Ω–æ | ‚ö†Ô∏è —á–∞—Å—Ç–∏—á–Ω–æ | ‚ùî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
echo ""

# –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ —Ä–µ—Å—Ç–∞—Ä—Ç
echo ""
echo -e "\e[33m–í–ù–ò–ú–ê–ù–ò–ï: –°–ª–µ–¥–≤–∞—â–æ—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —â–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å—ä—Ä–≤—ä—Ä–∞!"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo -e "\e[0m"

while true; do
  printf "üëâ –í—ä–≤–µ–¥–µ—Ç–µ (R) –∑–∞ –†–ï–°–¢–ê–†–¢ –∏–ª–∏ (Q) –∑–∞ –∏–∑—Ö–æ–¥ –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç: " choice
  case "$choice" in
    [Rr]*)
      # –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Å–∞–º–∏—è —Å–∫—Ä–∏–ø—Ç, –∞–∫–æ –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –æ—Ç —Ñ–∞–π–ª
      SCRIPT_PATH="$(realpath "$0")"
      if [[ -f "$SCRIPT_PATH" && "$SCRIPT_PATH" != "/usr/bin/bash" ]]; then
        echo "üßπ –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏–æ–Ω–Ω–∏—è —Å–∫—Ä–∏–ø—Ç: $SCRIPT_PATH"
        rm -f "$SCRIPT_PATH"
      else
        echo "‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç—ä—Ç –Ω–µ –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –æ—Ç —Ñ–∞–π–ª –∏–ª–∏ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ."
      fi
      
      echo -e "\e[32m[‚úì] –ò–Ω–∏—Ü–∏–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ—Å—Ç–∞—Ä—Ç...\e[0m"
      sudo reboot
      exit 0
      ;;
    [Qq]*)
      echo -e "\e[31m[X] –°–∫—Ä–∏–ø—Ç—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏ –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç. –ú–æ–∂–µ—Ç–µ –¥–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞—Ç–µ —Ä—ä—á–Ω–æ –ø–æ-–∫—ä—Å–Ω–æ.\e[0m"
      break
      ;;
    *)
      echo -e "\e[31m[!] –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ R –∏–ª–∏ Q.\e[0m"
      ;;
  esac
done
echo -e "\n‚úÖ –°–∫—Ä–∏–ø—Ç—ä—Ç –¥–æ—Å—Ç–∏–≥–Ω–∞ –∫—Ä–∞—è –Ω–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ—Ç–æ.\n"

# --------- –ö—Ä–∞–π –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞ ---------
