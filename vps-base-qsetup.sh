#!/bin/bash

# ==========================================================================
#  vps-base-qsetup - ะะฐะทะพะฒะฐ ะบะพะฝัะธะณััะฐัะธั ะฝะฐ VPS ัััะฒัั (ะปะพะบะฐะปะฝะพ ะธะทะฟัะปะฝะตะฝะธะต)
# --------------------------------------------------------------------------
#  ะะตััะธั: 1.0
#  ะะฐัะฐ: 2025-06-19
#  ะะฒัะพั: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  ะขะพะทะธ ัะบัะธะฟั ะธะทะฒัััะฒะฐ ะฝะฐัะฐะปะฝะฐ, ะฑะตะทะพะฟะฐัะฝะฐ ะธ ะฐะฒัะพะผะฐัะธะทะธัะฐะฝะฐ ะบะพะฝัะธะณััะฐัะธั ะฝะฐ
#  VPS ัััะฒัั. ะะทะฟัะปะฝัะฒะฐ ัะต ะดะธัะตะบัะฝะพ ะฝะฐ ัััะฒััะฐ, ะฝะต ะธะทะธัะบะฒะฐ SSH ะบัะผ ะดััะณะธ ะผะฐัะธะฝะธ.
#
#  ะัะฐะฟะธ:
#    1. ะัะฒะตะถะดะฐะฝะต ะฝะฐ ะฝัะถะฝะฐัะฐ ะธะฝัะพัะผะฐัะธั
#    2. ะัะพะฒะตัะบะฐ ะทะฐ ะฒะฐะปะธะดะฝะพัั
#    3. ะะพัะฒััะถะดะตะฝะธะต ะพั ะพะฟะตัะฐัะพัะฐ
#    4. ะะพะฝัะธะณััะฐัะธั ะฝะฐ ัััะฒััะฐ
# ==========================================================================

# === ะะะะะฉะะ ะะะคะะะะะฆะะฏ ===================================================
show_help() {
  echo "ะะทะฟะพะปะทะฒะฐะฝะต: vps-base-qsetup.sh [ะพะฟัะธั]"
  echo ""
  echo "ะะฒัะพะผะฐัะธะทะธัะฐะฝะฐ ะธ ะฑะตะทะพะฟะฐัะฝะฐ ะฝะฐัะฐะปะฝะฐ ะบะพะฝัะธะณััะฐัะธั ะฝะฐ ะปะพะบะฐะปะตะฝ VPS ัััะฒัั."
  echo ""
  echo "ะะฟัะธะธ:"
  echo "  --version       ะะพะบะฐะทะฒะฐ ะฒะตััะธััะฐ ะฝะฐ ัะบัะธะฟัะฐ"
  echo "  --help          ะะพะบะฐะทะฒะฐ ัะฐะทะธ ะฟะพะผะพั"
}

# === ะะะะะะะขะะ ะะ ะะะฆะะ ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-base-qsetup ะฒะตััะธั 1.0 (19 ัะฝะธ 2025 ะณ.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "โ ะะตัะฐะทะฟะพะทะฝะฐัะฐ ะพะฟัะธั: $1"
      show_help
      exit 1
      ;;
  esac
fi

# === ะะะะะะะะะ ะะ ะะะะะะะะะขะ ===============================================
echo -e "\e[32m=========================================="
echo -e " ะะะงะะะะ ะะะะคะะะฃะะะฆะะฏ ะะ ะะขะะะะะงะะ ะกะชะะะชะ"
echo -e "==========================================\e[0m"
echo ""

# === ะะะะะะะะ ะะะะะะะะะะ ===================================================
SERVER_IP="$(ip route get 1.1.1.1 | awk '{print $7; exit}')"
SSH_PORT="22"
FQDN=""
ADMIN_USER=""
CONFIRMATION=""
FIREWALL_SYSTEM="unknown"

# === ะกะขะชะะะ 1: ะะชะะะะะะะ ะะ ะะะคะะะะะฆะะฏ =====================================
echo "== ะกะขะชะะะ 1: ะัะฒะตะถะดะฐะฝะต ะฝะฐ ะธะฝัะพัะผะฐัะธั ะทะฐ ะบะพะฝัะธะณััะฐัะธััะฐ =="
echo ""

# --- [1] ะะะะคะะะฃะะะฆะะฏ ะะ ะกะชะะะชะะะ ะะะะะะ (FQDN) -----------------------------
echo "[1] ะะะะคะะะฃะะะฆะะฏ ะะ ะกะชะะะชะะะ ะะะะะะ (FQDN)..."
echo "-------------------------------------------------------------------------"
echo "ะะฐัะธัะฝะตัะต 'q' ะธ Enter, ะทะฐ ะดะฐ ะฟัะตะบัะฐัะธัะต ัะบัะธะฟัะฐ."
echo ""

while true; do
  read -rp "๐ ะัะฒะตะดะตัะต ะดะพะผะตะนะฝะฐ ะฝะฐ ัััะฒััะฐ (FQDN) ะธะปะธ 'q' ะทะฐ ะธะทัะพะด: " FQDN

  # ะัะพะฒะตัะบะฐ ะทะฐ ะฟัะตะบัะฐััะฒะฐะฝะต ะพั ะฟะพััะตะฑะธัะตะปั
  if [[ "$FQDN" == "q" || "$FQDN" == "Q" ]]; then
    echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
    exit 0
  fi

  # ะัะพะฒะตัะบะฐ ะดะฐะปะธ ะฒัะพะดัั ะต ะฟัะฐะทะตะฝ
  if [[ -z "$FQDN" ]]; then
    echo "โ ะะพะผะตะนะฝัั ะฝะต ะผะพะถะต ะดะฐ ะฑัะดะต ะฟัะฐะทะตะฝ. ะะฟะธัะฐะนัะต ะพัะฝะพะฒะพ."
    continue
  fi

  # ะัะพะฒะตัะบะฐ ะทะฐ ะฒะฐะปะธะดะตะฝ ัะพัะผะฐั ะฝะฐ ะดะพะผะตะนะฝ (ะฝะต ะณะฐัะฐะฝัะธัะฐ ัััะตััะฒัะฒะฐะฝะต)
  if [[ ! "$FQDN" =~ ^([a-zA-Z0-9][-a-zA-Z0-9]*\.)+[a-zA-Z]{2,}$ ]]; then
    echo "โ ะะตะฒะฐะปะธะดะตะฝ ัะพัะผะฐั ะฝะฐ ะดะพะผะตะนะฝ. ะัะธะผะตั ะทะฐ ะฒะฐะปะธะดะตะฝ: example.com"
    continue
  fi

  # ะัะพะฒะตัะบะฐ ะดะฐะปะธ ะดะพะผะตะนะฝัั ัะตะทะพะปะฒะธัะฐ (ะฟะพ ะธะทะฑะพั)
  if ! getent hosts "$FQDN" >/dev/null; then
    echo "โ๏ธ ะะฝะธะผะฐะฝะธะต: ะะพะผะตะนะฝัั '$FQDN' ะฝะต ัะตะทะพะปะฒะธัะฐ ะฒ ะผะพะผะตะฝัะฐ."
    read -rp "ะัะบะฐัะต ะปะธ ะดะฐ ะฟัะพะดัะปะถะธัะต ั ัะพะทะธ ะดะพะผะตะนะฝ? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
      continue
    fi
  fi

  break
done

# --- [2] ะะะะะะะะฏะะ ะะ SSH ะะะะขะ -----------------------------------------------
echo "[2] ะะะะะะะะฏะะ ะะ SSH ะะะะขะ..."
echo "-------------------------------------------------------------------------"
echo "ะะฐัะธัะฝะตัะต 'q' ะธ Enter, ะทะฐ ะดะฐ ะฟัะตะบัะฐัะธัะต ัะบัะธะฟัะฐ."
echo ""

# ะัะบัะธะฒะฐะฝะต ะฝะฐ ัะตะบััะธั SSH ะฟะพัั ะพั sshd ะบะพะฝัะธะณััะฐัะธััะฐ (ะฐะบะพ ะต ะฝะฐัััะพะตะฝ)
CURRENT_SSH_PORT=$(ss -tlpn | grep sshd | awk -F: '/LISTEN/ {print $2}' | head -n 1)
CURRENT_SSH_PORT="${CURRENT_SSH_PORT:-22}"

while true; do
  read -rp "๐ ะ ะผะพะผะตะฝัะฐ ะธะทะฟะพะปะทะฒะฐัะต SSH ะฟะพัั $CURRENT_SSH_PORT. ะะตะปะฐะตัะต ะปะธ ะดะฐ ะณะพ ะฟัะพะผะตะฝะธัะต? (y ะทะฐ ะฟัะพะผัะฝะฐ, Enter ะทะฐ ะทะฐะฟะฐะทะฒะฐะฝะต, q ะทะฐ ะธะทัะพะด): " change_port

  if [[ "$change_port" == "q" || "$change_port" == "Q" ]]; then
    echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
    exit 0
  elif [[ "$change_port" == "y" || "$change_port" == "Y" ]]; then
    while true; do
      read -rp "โค ะัะฒะตะดะตัะต ะฝะพะฒ SSH ะฟะพัั (ะผะตะถะดั 1024 ะธ 65535) ะธะปะธ 'q' ะทะฐ ะธะทัะพะด: " SSH_PORT

      if [[ "$SSH_PORT" == "q" || "$SSH_PORT" == "Q" ]]; then
        echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
        exit 0
      elif [[ "$SSH_PORT" =~ ^[0-9]+$ ]] && (( SSH_PORT >= 1024 && SSH_PORT <= 65535 )); then
        echo "โ ะะพะฒ SSH ะฟะพัั ัะต ะฑัะดะต: $SSH_PORT"
        break
      else
        echo "โ ะะตะฒะฐะปะธะดะตะฝ ะฟะพัั. ะะพะฟัััะธะผะธ ััะพะนะฝะพััะธ: 1024โ65535. ะะฟะธัะฐะนัะต ะพัะฝะพะฒะพ."
      fi
    done
    break
  else
    SSH_PORT="$CURRENT_SSH_PORT"
    echo "โ SSH ะฟะพัััั ัะต ะพััะฐะฝะต: $SSH_PORT"
    break
  fi
done

# --- [3] ะะะะะะะกะขะะะขะะะกะะ ะะะขะะะะะขะะ -----------------------------------------------
echo "[3] ะกะชะะะะะะะ ะะ ะะะ ะะะะะะะกะขะะะขะะะกะะ ะะะขะะะะะขะะ"
echo "-------------------------------------------------------------------------"
echo "๐ ะะพ ััะพะฑัะฐะถะตะฝะธั ะทะฐ ัะธะณััะฝะพัั, root ะดะพัััะฟัั ััะตะท SSH ัะต ะฑัะดะต ะทะฐะฑัะฐะฝะตะฝ."
echo "โ ะฉะต ััะทะดะฐะดะตะผ ะฝะพะฒ ะฟะพััะตะฑะธัะตะป ั root ะฟัะฐะฒะฐ ะทะฐ ะฐะดะผะธะฝะธัััะฐัะธะฒะฝะฐ ัะฐะฑะพัะฐ."
echo "ะะฐัะธัะฝะตัะต 'q' ะธ Enter ะทะฐ ะฟัะตะบัะฐััะฒะฐะฝะต ะธะปะธ ะฟัะพะดัะปะถะตัะต ั ะฒัะฒะตะถะดะฐะฝะต."
echo ""

while true; do
  read -rp "๐ ะัะฒะตะดะตัะต ะฟะพััะตะฑะธัะตะปัะบะพ ะธะผะต ะทะฐ ะฐะดะผะธะฝะธัััะฐัะธั: " ADMIN_USER

  if [[ "$ADMIN_USER" == "q" || "$ADMIN_USER" == "Q" ]]; then
    echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
    exit 0
  fi

  if [[ -z "$ADMIN_USER" ]]; then
    echo "โ ะะพััะตะฑะธัะตะปัะบะพัะพ ะธะผะต ะฝะต ะผะพะถะต ะดะฐ ะต ะฟัะฐะทะฝะพ."
    continue
  fi

  if id "$ADMIN_USER" &>/dev/null; then
    echo "โ๏ธ ะะพััะตะฑะธัะตะปัั '$ADMIN_USER' ะฒะตัะต ัััะตััะฒัะฒะฐ. ะะทะฑะตัะตัะต ะดััะณะพ ะธะผะต."
    continue
  fi

  break
done

while true; do
  read -s -rp "๐ ะัะฒะตะดะตัะต ะฟะฐัะพะปะฐ ะทะฐ $ADMIN_USER: " PASSWORD_1
  echo
  read -s -rp "๐ ะะพะฒัะพัะตัะต ะฟะฐัะพะปะฐัะฐ: " PASSWORD_2
  echo

  if [[ "$PASSWORD_1" != "$PASSWORD_2" ]]; then
    echo "โ ะะฐัะพะปะธัะต ะฝะต ััะฒะฟะฐะดะฐั. ะะฟะธัะฐะนัะต ะพัะฝะพะฒะพ."
  elif [[ -z "$PASSWORD_1" ]]; then
    echo "โ ะะฐัะพะปะฐัะฐ ะฝะต ะผะพะถะต ะดะฐ ะต ะฟัะฐะทะฝะฐ."
  else
    break
  fi

done

# --- [4] ะะะะะะะะ ะะ FIREWALL ะกะะกะขะะะ --------------------------------------------
echo "[3] ะะะะะะะะ ะะ FIREWALL ะกะะกะขะะะ..."
echo "-------------------------------------------------------------------------"

# ะัะพะฒะตัะบะฐ ะดะฐะปะธ ufw ะต ะธะฝััะฐะปะธัะฐะฝ
if command -v ufw >/dev/null 2>&1; then
  FIREWALL_SYSTEM="ufw"
  echo "๐ก๏ธ  ะะฐัะตัะตะฝะฐ ะฐะบัะธะฒะฝะฐ ะทะฐัะธัะฝะฐ ััะตะฝะฐ: UFW"

  # ะัะพะฒะตัะบะฐ ะทะฐ ััะฐััั ะฝะฐ UFW
  UFW_STATUS=$(ufw status | head -n 1)
  echo "โน๏ธ  ะกัะฐััั ะฝะฐ UFW: $UFW_STATUS"

  echo "๐ ะกะฟะธััะบ ั ะพัะฒะพัะตะฝะธ/ัะฐะทัะตัะตะฝะธ ะฟะพััะพะฒะต ะฒ UFW:"
  ufw status numbered | sed 's/^/    /'
else
  echo "โ๏ธ  ะะต ะต ะพัะบัะธัะฐ ะธะฝััะฐะปะธัะฐะฝะฐ ะทะฐัะธัะฝะฐ ััะตะฝะฐ UFW."
  FIREWALL_SYSTEM="none"
fi

# --- [5] ะะะะะะ ะะ FIREWALL ะกะะกะขะะะ ---------------------------------------------
if [[ "$FIREWALL_SYSTEM" != "ufw" ]]; then
  echo ""
  if [[ "$FIREWALL_SYSTEM" == "none" ]]; then
    echo "โ๏ธ  ะะฐัะฐัะฐ ัะธััะตะผะฐ ะฒ ะผะพะผะตะฝัะฐ ะฝะต ะธะทะฟะพะปะทะฒะฐ ะทะฐัะธัะฝะฐ ััะตะฝะฐ."
  else
    echo "โ๏ธ  ะ ะผะพะผะตะฝัะฐ ะฒะฐัะฐัะฐ ะทะฐัะธัะฝะฐ ััะตะฝะฐ ะต: $FIREWALL_SYSTEM"
  fi

  echo "๐ก ะ ะฑัะดะตัะต ัะต ะธะทะฟะพะปะทะฒะฐัะต UFW ะทะฐ ัะฟัะฐะฒะปะตะฝะธะต ะฝะฐ ะทะฐัะธัะฝะฐัะฐ ััะตะฝะฐ."
  while true; do
    read -rp "ะะฐัะธัะฝะตัะต Enter ะทะฐ ััะณะปะฐัะธะต ะธะปะธ 'q' ะทะฐ ะพัะบะฐะท ะธ ะฟัะตะบัะฐััะฒะฐะฝะต: " consent
    if [[ "$consent" == "q" || "$consent" == "Q" ]]; then
      echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
      exit 0
    else
      echo "โ ะะทะฑัะฐะฝะพ: ัะต ะธะทะฟะพะปะทะฒะฐะผะต UFW."
      break
    fi
  done
fi

# --- [6] ะะชะะะะะะะ ะะ ะะะะชะะะะขะะะะ FIREWALL ะะะะขะะะ ----------------------------
PORT_LIST=()

if [[ "$FIREWALL_SYSTEM" != "none" ]]; then
  echo ""
  echo "๐ก ะะฐัะตัะตะฝะธ ะพัะฒะพัะตะฝะธ ะฟะพััะพะฒะต ะฒัะฒ ะฒะฐัะฐัะฐ ะทะฐัะธัะฝะฐ ััะตะฝะฐ:"

  if [[ "$FIREWALL_SYSTEM" == "ufw" ]]; then
    ufw status numbered | awk '/ALLOW/ {print $1, $2, $3, $4}' | sed 's/^/  - /'
  else
    # ะะฐ ะดััะณะธ ัะธััะตะผะธ ะธะทะฟะพะปะทะฒะฐะผะต ss ะบะฐัะพ ะฝะฐะน-ะพะฑั ะฟะพะดัะพะด
    ss -tuln | awk 'NR>1 {print $5}' | cut -d: -f2 | sort -nu | sed 's/^/  - /'
  fi

  while true; do
    read -rp "โ ะะตะปะฐะตัะต ะปะธ ะดะฐ ะพัะฒะพัะธัะต ะฝะพะฒะธ ะฟะพััะพะฒะต? (y ะทะฐ ะดะฐ ะดะพะฑะฐะฒะธัะต, Enter ะทะฐ ะฟัะพะฟััะบะฐะฝะต, q ะทะฐ ะฟัะตะบัะฐััะฒะฐะฝะต): " open_more
    if [[ "$open_more" == "q" || "$open_more" == "Q" ]]; then
      echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
      exit 0
    elif [[ "$open_more" == "y" || "$open_more" == "Y" ]]; then
      break
    else
      echo "๐ ะัะพะฟััะบะฐะฝะต ะฝะฐ ะดะพะฑะฐะฒัะฝะต ะฝะฐ ะฝะพะฒะธ ะฟะพััะพะฒะต."
      open_more=""
      break
    fi
  done
fi

if [[ "$FIREWALL_SYSTEM" == "none" || "$open_more" == "y" || "$open_more" == "Y" ]]; then
  echo ""
  echo "๐งฉ ะัะฒะตะถะดะฐะฝะต ะฝะฐ ะดะพะฟัะปะฝะธัะตะปะฝะธ ะฟะพััะพะฒะต ะทะฐ ะพัะฒะฐััะฝะต ะฒัะฒ ะฒะฐัะฐัะฐ ะฑัะดะตัะฐ ะทะฐัะธัะฝะฐ ััะตะฝะฐ (UFW):"
  while true; do
    read -rp "โค ะัะฒะตะดะตัะต ะฟะพัั ะทะฐ ะพัะฒะฐััะฝะต (Enter ะทะฐ ะบัะฐะน, q ะทะฐ ะฟัะตะบัะฐััะฒะฐะฝะต): " port
    if [[ "$port" == "q" || "$port" == "Q" ]]; then
      echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
      exit 0
    elif [[ -z "$port" ]]; then
      break
    elif [[ "$port" =~ ^[0-9]+$ ]] && (( port >= 1 && port <= 65535 )); then
      PORT_LIST+=("$port")
      echo "โ ะะพะฑะฐะฒะตะฝ ะฟะพัั: $port"
    else
      echo "โ ะะตะฒะฐะปะธะดะตะฝ ะฝะพะผะตั ะฝะฐ ะฟะพัั. ะะพะปั, ะฒัะฒะตะดะตัะต ัะธัะปะพ ะผะตะถะดั 1 ะธ 65535."
    fi
  done
fi

# === ะะะะะฉะะะะ =============================================================
echo ""
echo "โ ะัะฒะตะดะตะฝะฐ ะธะฝัะพัะผะฐัะธั:"
echo " - ะะพะผะตะนะฝ (FQDN): $FQDN"
echo " - SSH ะฟะพัั: $SSH_PORT"
echo " - ะะดะผะธะฝ ะฟะพััะตะฑะธัะตะป: $ADMIN_USER"
echo " - Root ะดะพัััะฟ ะฟะพ SSH: ัะต ะฑัะดะต ะทะฐะฑัะฐะฝะตะฝ"

echo " - IP ะฐะดัะตั ะฝะฐ ัััะฒััะฐ: $SERVER_IP"
echo " - ะะฐัะธัะฝะฐ ััะตะฝะฐ: $FIREWALL_SYSTEM"
if [[ ${#PORT_LIST[@]} -gt 0 ]]; then
  echo " - ะะพะฟัะปะฝะธัะตะปะฝะธ ะฟะพััะพะฒะต ะทะฐ ะพัะฒะฐััะฝะต: ${PORT_LIST[*]}"
fi

# === ะกะขะชะะะ 2: ะะะะะะะ ะ ะะะะขะะชะะะะะะะ ะะข ะะะะะะขะะะ =============================
echo ""
echo "๐ง ะะพะปั, ะฟัะตะณะปะตะดะฐะนัะต ะฒะฝะธะผะฐัะตะปะฝะพ ะฒัะฒะตะดะตะฝะฐัะฐ ะธะฝัะพัะผะฐัะธั ะฟะพ-ะณะพัะต."
echo "ะะบะพ ะฒัะธัะบะพ ะต ะฒััะฝะพ, ะผะพะถะตัะต ะดะฐ ะฟัะพะดัะปะถะธัะต ั ะฐะฒัะพะผะฐัะธัะฝะฐัะฐ ะบะพะฝัะธะณััะฐัะธั."
echo "ะะบะพ ะธะผะฐ ะณัะตัะบะฐ, ะฟัะตะบัะฐัะตัะต ัะบัะธะฟัะฐ, ะบะพัะธะณะธัะฐะนัะต ะธ ััะฐััะธัะฐะนัะต ะพัะฝะพะฒะพ."
echo ""

while true; do
  read -rp "โ๏ธ ะัะพะดัะปะถะฐะฒะฐะผะต ะปะธ ั ะบะพะฝัะธะณััะฐัะธััะฐ? (y ะทะฐ ะฟัะพะดัะปะถะตะฝะธะต, q ะทะฐ ะฟัะตะบัะฐััะฒะฐะฝะต): " CONFIRMATION
  if [[ "$CONFIRMATION" == "q" || "$CONFIRMATION" == "Q" ]]; then
    echo "โ ะกะบัะธะฟััั ะฑะตัะต ะฟัะตะบัะฐัะตะฝ ะพั ะฟะพััะตะฑะธัะตะปั."
    exit 0
  elif [[ "$CONFIRMATION" == "y" || "$CONFIRMATION" == "Y" ]]; then
    echo "๐ ะกัะฐััะธัะฐะฝะต ะฝะฐ ะฐะฒัะพะผะฐัะธัะฝะฐัะฐ ะบะพะฝัะธะณััะฐัะธั..."
    break
  else
    echo "โ ะะพะปั, ะพัะณะพะฒะพัะตัะต ั 'y' ะทะฐ ะฟัะพะดัะปะถะตะฝะธะต ะธะปะธ 'q' ะทะฐ ะฟัะตะบัะฐััะฒะฐะฝะต."
  fi
done

# === ะกะขะชะะะ 3: ะะะะะะฏะะะะ ะะ ะกะะกะขะะะะขะ ==========================================
echo ""
echo "[7] ะะะะะะฏะะะะ ะะ ะกะะกะขะะะะขะ..."
echo "-------------------------------------------------------------------------"

if sudo apt-get update && sudo apt-get upgrade -y && sudo apt-get autoremove -y; then
  echo "โ ะกะธััะตะผะฐัะฐ ะต ััะฟะตัะฝะพ ะพะฑะฝะพะฒะตะฝะฐ."
else
  echo "โ ะัะทะฝะธะบะฝะฐ ะณัะตัะบะฐ ะฟัะธ ะพะฑะฝะพะฒัะฒะฐะฝะต ะฝะฐ ัะธััะตะผะฐัะฐ. ะัะพะฒะตัะตัะต ะณะพัะฝะธัะต ััะพะฑัะตะฝะธั."
  exit 1
fi

# === ะกะขะชะะะ 4: ะะะกะขะะะะะะะ ะะ ะะกะะะะะ ะะะกะขะะฃะะะะขะ ================================
echo ""
echo "[8] ะะะกะขะะะะะะะ ะะ ะะกะะะะะะขะ ะะะกะขะะฃะะะะขะ..."
echo "-------------------------------------------------------------------------"

if sudo apt-get install -y \
    nano unzip git curl wget net-tools htop \
    python3 python3-pip python3-venv build-essential; then
  echo "โ ะัะธัะบะธ ะพัะฝะพะฒะฝะธ ะธะฝััััะผะตะฝัะธ ะธ ะทะฐะฒะธัะธะผะพััะธ ัะฐ ะธะฝััะฐะปะธัะฐะฝะธ."
else
  echo "โ ะัะทะฝะธะบะฝะฐ ะณัะตัะบะฐ ะฟัะธ ะธะฝััะฐะปะฐัะธััะฐ. ะัะพะฒะตัะตัะต:"
  echo "1. ะะฐะปะธ apt-get cache ะต ะพะฑะฝะพะฒะตะฝ (ะฒ ะฟัะตะดัะพะดะฝะฐัะฐ ัััะฟะบะฐ)"
  echo "2. ะะฐะปะธ ะธะผะฐ ะดะพััะฐัััะฝะพ ะดะธัะบะพะฒะพ ะฟัะพัััะฐะฝััะฒะพ"
  exit 1
fi

# === ะกะขะชะะะ 5: ะะะกะขะะะะะ ะะ ะะะะะะะะะฆะะ ===========================================
echo ""
echo "[9] ะะะกะขะะะะะ ะะ ะะะะะะะะะฆะะ..."
echo "-------------------------------------------------------------------------"

# ะะฝััะฐะปะฐัะธั ะฝะฐ ะตะทะธะบะพะฒะธ ะฟะฐะบะตัะธ
if ! sudo apt-get install -y language-pack-bg language-pack-ru; then
  echo "โ๏ธ ะะฝะธะผะฐะฝะธะต: ะะตััะฟะตัะฝะฐ ะธะฝััะฐะปะฐัะธั ะฝะฐ ะตะทะธะบะพะฒะธ ะฟะฐะบะตัะธ. ะัะพะดัะปะถะฐะฒะฐะผ ะฑะตะท ััั."
fi

# ะะพะฝัะธะณััะธัะฐะฝะต ะฝะฐ /etc/locale.gen
sudo sed -i '/^# *bg_BG.UTF-8 UTF-8/s/^# *//g' /etc/locale.gen
sudo sed -i '/^# *ru_RU.UTF-8 UTF-8/s/^# *//g' /etc/locale.gen
sudo sed -i '/^# *en_US.UTF-8 UTF-8/s/^# *//g' /etc/locale.gen

# ะะพะฑะฐะฒัะฝะต ะฝะฐ ะปะพะบะฐะปะธ ะฐะบะพ ะปะธะฟัะฒะฐั
grep -qxF 'bg_BG.UTF-8 UTF-8' /etc/locale.gen || echo 'bg_BG.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null
grep -qxF 'ru_RU.UTF-8 UTF-8' /etc/locale.gen || echo 'ru_RU.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null
grep -qxF 'en_US.UTF-8 UTF-8' /etc/locale.gen || echo 'en_US.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null

# ะะตะฝะตัะธัะฐะฝะต ะฝะฐ ะปะพะบะฐะปะธ
if sudo locale-gen && sudo update-locale; then
  echo "โ ะะพะบะฐะปะธะทะฐัะธะธัะต ัะฐ ะฝะฐัััะพะตะฝะธ."
else
  echo "โ๏ธ ะะฝะธะผะฐะฝะธะต: ะัะทะฝะธะบะฝะฐ ะณัะตัะบะฐ ะฟัะธ ะณะตะฝะตัะธัะฐะฝะต ะฝะฐ ะปะพะบะฐะปะธ. ะัะพะฒะตัะตัะต ัััะฝะพ."
fi

# === ะกะขะชะะะ 6: ะะะะะะะะ ะะ ะะะะะะะ ะะะะ UTC ======================================
echo ""
echo "[10] ะะะะคะะะฃะะะฆะะฏ ะะ ะะะะะะะ ะะะะ..."
echo "-------------------------------------------------------------------------"

# ะัะพะผัะฝะฐ ะฝะฐ ัะธััะตะผะฝะฐัะฐ ัะฐัะพะฒะฐ ะทะพะฝะฐ ะฝะฐ UTC
if sudo timedatectl set-timezone UTC; then
  echo "โ ะัะตะผะตะฒะฐัะฐ ะทะพะฝะฐ ะต ะทะฐะดะฐะดะตะฝะฐ ะฝะฐ UTC."
else
  echo "โ ะะตััะฟะตัะฝะฐ ัะผัะฝะฐ ะฝะฐ ะฒัะตะผะตะฒะฐัะฐ ะทะพะฝะฐ. ะะพะปั, ะฟัะพะฒะตัะตัะต ัััะฝะพ."
  exit 1
fi

# === ะกะขะชะะะ 7: ะะะกะขะะะะะ ะะ ะะะะะะะ ะกะะะฅะะะะะะะฆะะฏ ================================
echo ""
echo "[11] ะะะกะขะะะะะ ะะ ะะะะะะะะขะ ะกะะะฅะะะะะะะฆะะฏ..."
echo "-------------------------------------------------------------------------"

# ะกะฟะธัะฐะฝะต ะฝะฐ ะดััะณะธ NTP ััะปัะณะธ
echo "๐ ะัะพะฒะตัะบะฐ ะทะฐ ะฐะบัะธะฒะฝะธ NTP ััะปัะณะธ..."
sudo systemctl stop ntpd 2>/dev/null && sudo systemctl disable ntpd 2>/dev/null
sudo systemctl stop systemd-timesyncd 2>/dev/null && sudo systemctl disable systemd-timesyncd 2>/dev/null

# ะะฝััะฐะปะธัะฐะฝะต ะฝะฐ chrony
echo "๐ฆ ะะฝััะฐะปะธัะฐะฝะต ะฝะฐ chrony..."
if ! sudo apt-get install -y chrony; then
  echo "โ ะะตััะฟะตัะฝะฐ ะธะฝััะฐะปะฐัะธั ะฝะฐ chrony."
  exit 1
fi

# ะะพะฝัะธะณััะฐัะธั ะฝะฐ chrony ั ัะฝะธะฒะตััะฐะปะฝะธ ัััะฒััะธ
NTP_SERVERS=(0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org)
echo "โ๏ธ ะะพะฝัะธะณััะธัะฐะฝะต ะฝะฐ chrony ั ะฟัะฑะปะธัะฝะธ ัััะฒััะธ: ${NTP_SERVERS[*]}"
echo -e "server ${NTP_SERVERS[0]} iburst
server ${NTP_SERVERS[1]} iburst
server ${NTP_SERVERS[2]} iburst
server ${NTP_SERVERS[3]} iburst

rtcsync
makestep 1.0 3
driftfile /var/lib/chrony/drift
logdir /var/log/chrony" | sudo tee /etc/chrony/chrony.conf > /dev/null

# ะะตััะฐัั ะธ ะฐะบัะธะฒะธัะฐะฝะต
sudo systemctl restart chrony
sudo systemctl enable chrony

# ะัะพะฒะตัะบะฐ ะฝะฐ ััะฐัััะฐ
echo "๐ ะัะพะฒะตัะบะฐ ะฝะฐ ัะธะฝััะพะฝะธะทะฐัะธััะฐ..."
timedatectl | grep 'Time zone'
echo "NTP ััะฐััั:"
chronyc tracking | grep -E 'Stratum|System time'
chronyc sources | grep '^\^\*'

echo "โ ะัะตะผะตะฒะฐัะฐ ัะธะฝััะพะฝะธะทะฐัะธั ะต ะบะพะฝัะธะณััะธัะฐะฝะฐ."

# === ะกะขะชะะะ 8: ะะะกะขะะะะะ ะะ HOSTNAME ============================================
echo ""
echo "[12] ะะะกะขะะะะะ ะะ HOSTNAME..."
echo "-------------------------------------------------------------------------"

# ะะทะฒะปะธัะฐะฝะต ะฝะฐ ะบัะฐัะบะพัะพ ะธะผะต ะฝะฐ ัะพััะฐ ะพั FQDN
HOSTNAME_SHORT="${FQDN%%.*}"

# ะะฐะดะฐะฒะฐะฝะต ะฝะฐ hostname
if sudo hostnamectl set-hostname "$FQDN"; then
  echo "โ Hostname ะทะฐะดะฐะดะตะฝ ะฝะฐ: $FQDN"
else
  echo "โ ะะตััะฟะตัะฝะฐ ัะผัะฝะฐ ะฝะฐ hostname."
  exit 1
fi

# ะะบััะฐะปะธะทะธัะฐะฝะต ะฝะฐ /etc/hosts
sudo tee /etc/hosts > /dev/null <<EOF
127.0.0.1   localhost
127.0.1.1   $FQDN $HOSTNAME_SHORT
::1         localhost ip6-localhost ip6-loopback
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters
EOF

echo "โ /etc/hosts ะต ะฐะบััะฐะปะธะทะธัะฐะฝ."

# === ะกะขะชะะะ 9: ะะะะคะะะฃะะะฆะะฏ ะะ UFW ะ ะะะกะขะะะข ะะ ะกะชะะะชะะ ==========================
echo ""
echo "[13] ะะะะคะะะฃะะะฆะะฏ ะะ UFW ะ ะะะกะขะะะข ะะ ะกะชะะะชะะ..."
echo "-------------------------------------------------------------------------"

# --- ะะะะะะฏะะ ะะ ะะะะชะะะะขะะะะ ะะะะะะะะ ะะะะะ (ะฟะพ ะธะทะฑะพั) ----------------------
echo ""
echo "๐ ะะบะพ ะธะทะฟะพะปะทะฒะฐัะต ัะฐััะฝะฐ ะผัะตะถะฐ (VPN, ะปะพะบะฐะปะฝะฐ LAN ะธ ั.ะฝ.), ะผะพะถะตัะต ะดะฐ ะดะพะฑะฐะฒะธัะต ัะฐะทัะตัะตะฝะธะต ะทะฐ ะฝะตั ะฒ UFW."
TRUSTED_NETS=()
while true; do
  read -rp "โค ะัะฒะตะดะตัะต CIDR ะฝะฐ ะดะพะฒะตัะตะฝะฐ ะผัะตะถะฐ (ะฝะฐะฟั. 192.168.1.0/24), Enter ะทะฐ ะบัะฐะน: " net
  if [[ -z "$net" ]]; then
    break
  elif [[ "$net" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$ ]]; then
    TRUSTED_NETS+=("$net")
    echo "โ ะะพะฑะฐะฒะตะฝะฐ ะผัะตะถะฐ: $net"
  else
    echo "โ ะะตะฒะฐะปะธะดะตะฝ ัะพัะผะฐั. ะะทะฟะพะปะทะฒะฐะนัะต CIDR, ะฝะฐะฟั. 10.8.0.0/24"
  fi
done

for net in "${TRUSTED_NETS[@]}"; do
  echo "๐ ะะฐะทัะตัะฐะฒะฐะฝะต ะฝะฐ ะดะพัััะฟ ะพั $net ะบัะผ ะฒัะธัะบะธ ะฟะพััะพะฒะต..."
  sudo ufw allow from "$net"
done

# ะะฝััะฐะปะธัะฐะฝะต ะฝะฐ UFW, ะฐะบะพ ะฝะต ะต ะฝะฐะปะธัะตะฝ
if ! command -v ufw >/dev/null 2>&1; then
  echo "๐ฆ ะะฝััะฐะปะธัะฐะฝะต ะฝะฐ UFW..."
  if ! sudo apt-get install -y ufw; then
    echo "โ ะะตััะฟะตัะฝะฐ ะธะฝััะฐะปะฐัะธั ะฝะฐ UFW."
    exit 1
  fi
fi

# ะะฐะทัะตัะฐะฒะฐะฝะต ะฝะฐ ะทะฐะฟะธัะฐะฝะธัะต ะฟะพััะพะฒะต
for port in "${PORT_LIST[@]}"; do
  echo "๐ ะัะฒะฐััะฝะต ะฝะฐ ะฟะพัั $port..."
  sudo ufw allow "$port"
done

# ะะฐะทัะตัะฐะฒะฐะฝะต ะฝะฐ SSH ะฟะพััะฐ, ะฐะบะพ ะฝะต ะต ะฒะตัะต ะดะพะฑะฐะฒะตะฝ
sudo ufw allow "$SSH_PORT"

# ะะบัะธะฒะธัะฐะฝะต ะฝะฐ UFW
sudo ufw --force enable

# ะะพัะฒััะถะดะตะฝะธะต ะทะฐ ัะตััะฐัั

echo ""
echo " 33[33mะะะะะะะะ: ะกะปะตะดะฒะฐัะพัะพ ะดะตะนััะฒะธะต ัะต ัะตััะฐััะธัะฐ ัััะฒััะฐ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e " 33[0m"

while true; do
  read -rp "๐ ะัะฒะตะดะตัะต (R) ะทะฐ ะะะกะขะะะข ะธะปะธ (Q) ะทะฐ ะธะทัะพะด ะฑะตะท ัะตััะฐัั: " choice
  case "$choice" in
    [Rr]*)
      echo -e " 33[32m[โ] ะะฝะธัะธะธัะฐะฝะต ะฝะฐ ัะตััะฐัั... 33[0m"
      sudo reboot
      exit 0
      ;;
    [Qq]*)
      echo -e " 33[31m[X] ะกะบัะธะฟััั ะฟัะธะบะปััะธ ะฑะตะท ัะตััะฐัั. ะะพะถะตัะต ะดะฐ ัะตััะฐััะธัะฐัะต ัััะฝะพ ะฟะพ-ะบััะฝะพ. 33[0m"
      break
      ;;
    *)
      echo -e " 33[31m[!] ะะตะฒะฐะปะธะดะตะฝ ะธะทะฑะพั. ะะพะปั, ะฒัะฒะตะดะตัะต R ะธะปะธ Q. 33[0m"
      ;;
  esac
done

# --------- ะัะฐะน ะฝะฐ ัะบัะธะฟัะฐ ---------
