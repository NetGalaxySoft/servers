#!/bin/bash

# ==========================================================================
#  vps-virhost-create.sh ‚Äì –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª–µ–Ω —Ö–æ—Å—Ç (Apache)
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞:   2025-07-07
#  –ê–≤—Ç–æ—Ä:  Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–≥–æ—Ç–≤—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞ –≤–∏—Ä—Ç—É–∞–ª–µ–Ω —Ö–æ—Å—Ç –≤—ä—Ä—Ö—É —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â VPS.
#  –ü–æ–¥–¥—ä—Ä–∂–∞ –æ—Å–Ω–æ–≤–Ω–∏ –∏ —Å—É–±–¥–æ–º–µ–π–Ω–∏, —Å –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω –∏–ª–∏ Let's Encrypt
#  —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –∏–∑–±–æ—Ä –Ω–∞ PHP –≤–µ—Ä—Å–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —É–µ–± –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
#
#  üîí –°–∫—Ä–∏–ø—Ç—ä—Ç –ù–ï –∏–∑–≤—ä—Ä—à–≤–∞ –Ω–∏–∫–∞–∫–≤–∏ –ø—Ä–æ–º–µ–Ω–∏, –¥–æ–∫–∞—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ä—Ç –Ω–µ –ø—Ä–µ–≥–ª–µ–¥–∞
#     –∏ –ø–æ—Ç–≤—ä—Ä–¥–∏ –≤—Å–∏—á–∫–∏ –∏–∑–±—Ä–∞–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.
# ==========================================================================

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-virhost-create.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–°—ä–∑–¥–∞–≤–∞ –≤–∏—Ä—Ç—É–∞–ª–µ–Ω —Ö–æ—Å—Ç –∑–∞ Apache —Å—ä—Ä–≤—ä—Ä —Å –ø—ä–ª–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ SSL."
  echo "–ü–æ–∑–≤–æ–ª—è–≤–∞ –∏–∑–±–æ—Ä –Ω–∞ PHP –≤–µ—Ä—Å–∏—è –∏ —Ç–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (Let's Encrypt –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω)."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ===================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-virhost-create.sh –≤–µ—Ä—Å–∏—è 1.0 (7 —é–ª–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∑–∞ —Å—ä–±–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏
SUMMARY_DOMAIN=""
SUMMARY_ROOT_DOMAIN=""
SUMMARY_IS_SUBDOMAIN=""
SUMMARY_WEBROOT=""
SUMMARY_PHP_VERSION=""
SUMMARY_SSL_TYPE=""
SUMMARY_CUSTOM_MESSAGE=""

echo "=================================================================="
echo " üåê NetGalaxy - –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª–µ–Ω —Ö–æ—Å—Ç –∑–∞ Apache —Å—ä—Ä–≤—ä—Ä"
echo "=================================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ root –ø—Ä–∞–≤–∞
if [[ "$EUID" -ne 0 ]]; then
  echo "‚ùå –°–∫—Ä–∏–ø—Ç—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–µ –∏–∑–ø—ä–ª–Ω–µ–Ω —Å root –ø—Ä–∞–≤–∞ (sudo)."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–µ–Ω Apache
if ! command -v apache2 >/dev/null 2>&1; then
  echo "‚ùå Apache —É–µ–± —Å—ä—Ä–≤—ä—Ä—ä—Ç –Ω–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω. –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –≥–æ –ø—Ä–µ–¥–∏ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ."
  exit 1
fi

# === [1] –°–™–ë–ò–†–ê–ù–ï –ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò –ü–†–û–í–ï–†–ö–ê –ù–ê –°–™–†–í–™–†–ê ======================

# –û—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∞–ª–Ω–∏—è –ø—É–±–ª–∏—á–µ–Ω IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
ACTUAL_IP=$(curl -s https://api.ipify.org)

if [[ -z "$ACTUAL_IP" ]]; then
  echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞—Ç–∞."
  exit 1
fi

while true; do
  read -rp "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å, –Ω–∞ –∫–æ–π—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ —Ç–æ–∑–∏ –≤–∏—Ä—Ç—É–∞–ª–µ–Ω —Ö–æ—Å—Ç (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): " SERVER_IP

  [[ "$SERVER_IP" == "q" ]] && {
    echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –ø–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    exit 0
  }

  if [[ "$SERVER_IP" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    if [[ "$SERVER_IP" != "$ACTUAL_IP" ]]; then
      echo "‚ùå –í—ä–≤–µ–¥–µ–Ω–∏—è—Ç IP –∞–¥—Ä–µ—Å ($SERVER_IP) –Ω–µ —Å—ä–≤–ø–∞–¥–∞ —Å —Ä–µ–∞–ª–Ω–∏—è IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞."
      echo "üõë –°–∫—Ä–∏–ø—Ç—ä—Ç —â–µ –±—ä–¥–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω, –∑–∞ –¥–∞ —Å–µ –∏–∑–±–µ–≥–Ω–µ –≥—Ä–µ—à–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è."
      exit 1
    fi
    break
  else
    echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
  fi
done

SUMMARY_SERVER_IP="$SERVER_IP"

# === [2] –í–™–í–ï–ñ–î–ê–ù–ï –ò –ü–†–û–í–ï–†–ö–ê –ù–ê –î–û–ú–ï–ô–ù ======================================

while true; do
  read -rp "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ –æ—Å–Ω–æ–≤–µ–Ω –∏–ª–∏ —Å—É–±–¥–æ–º–µ–π–Ω (–Ω–∞–ø—Ä. example.com –∏–ª–∏ blog.example.com), –∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥: " input_domain

  [[ "$input_domain" == "q" ]] && {
    echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –ø–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    exit 0
  }

  # –ü—Ä–∞–∑–Ω–æ –ø–æ–ª–µ
  if [[ -z "$input_domain" ]]; then
    echo "‚ö†Ô∏è –î–æ–º–µ–π–Ω—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–∞–∑–µ–Ω. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
    continue
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç
  if ! [[ "$input_domain" =~ ^[a-z0-9.-]+\.[a-z]{2,}$ ]]; then
    echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω –¥–æ–º–µ–π–Ω. –£–≤–µ—Ä–µ—Ç–µ —Å–µ, —á–µ –µ –≤ –ø—Ä–∞–≤–∏–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç."
    continue
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ä–µ–∑ –ø—É–±–ª–∏—á–µ–Ω DNS —Å—ä—Ä–≤—ä—Ä (Google DNS)
  resolved_ip=$(dig +short "$input_domain" @8.8.8.8 | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1)

  if [[ -z "$resolved_ip" ]]; then
    echo "‚ùå –î–æ–º–µ–π–Ω—ä—Ç \"$input_domain\" –Ω–µ —Å–µ —Ä–µ–∑–æ–ª–≤–∏—Ä–∞ –∫—ä–º IP –∞–¥—Ä–µ—Å (—Å–ø–æ—Ä–µ–¥ –ø—É–±–ª–∏—á–Ω–∏—è DNS)."
    echo "üîß –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ DNS –∑–∞–ø–∏—Å–∏—Ç–µ –∏ —Å–µ —É–≤–µ—Ä–µ—Ç–µ, —á–µ —Å–æ—á–∞—Ç –∫—ä–º —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä."
    continue
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å—ä–≤–ø–∞–¥–∞ —Å –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞
  if [[ "$resolved_ip" != "$SUMMARY_SERVER_IP" ]]; then
    echo "‚ùå –î–æ–º–µ–π–Ω—ä—Ç —Å–µ —Ä–µ–∑–æ–ª–≤–∏—Ä–∞ –∫—ä–º $resolved_ip, –Ω–æ –ø—É–±–ª–∏—á–Ω–∏—è—Ç IP –∞–¥—Ä–µ—Å –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ –µ $SUMMARY_SERVER_IP."
    echo "üõë –£–≤–µ—Ä–µ—Ç–µ —Å–µ, —á–µ DNS –∑–∞–ø–∏—Å–∏—Ç–µ —Å–æ—á–∞—Ç –∫—ä–º —Ç–æ–∑–∏ —Å—ä—Ä–≤—ä—Ä."
    continue
  fi

  echo "‚úÖ –î–æ–º–µ–π–Ω—ä—Ç —Å–µ —Ä–µ–∑–æ–ª–≤–∏—Ä–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ –∫—ä–º IP: $resolved_ip"
  break
done

# –ó–∞–ø–∏—Å–≤–∞–Ω–µ –≤ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞
SUMMARY_DOMAIN="$input_domain"

# –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ root –¥–æ–º–µ–π–Ω
IFS='.' read -ra domain_parts <<< "$SUMMARY_DOMAIN"
domain_parts_count=${#domain_parts[@]}
SUMMARY_ROOT_DOMAIN="${domain_parts[-2]}.${domain_parts[-1]}"

# –û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –¥–∞–ª–∏ –µ —Å—É–±–¥–æ–º–µ–π–Ω
if [[ "$SUMMARY_DOMAIN" != "$SUMMARY_ROOT_DOMAIN" ]]; then
  SUMMARY_IS_SUBDOMAIN="yes"
  sub_name="${SUMMARY_DOMAIN%%.$SUMMARY_ROOT_DOMAIN}"
  SUMMARY_WEBROOT="/var/www/$SUMMARY_ROOT_DOMAIN/$sub_name/public_html"
else
  SUMMARY_IS_SUBDOMAIN="no"
  SUMMARY_WEBROOT="/var/www/$SUMMARY_ROOT_DOMAIN/public_html"
fi

# –ò–∑–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞
echo "üìå –†–∞–∑–ø–æ–∑–Ω–∞—Ç –¥–æ–º–µ–π–Ω:          $SUMMARY_DOMAIN"
echo "üìå Root –¥–æ–º–µ–π–Ω:               $SUMMARY_ROOT_DOMAIN"
echo "üìå –¢–∏–ø:                       $( [[ "$SUMMARY_IS_SUBDOMAIN" == "yes" ]] && echo '—Å—É–±–¥–æ–º–µ–π–Ω' || echo '–æ—Å–Ω–æ–≤–µ–Ω –¥–æ–º–µ–π–Ω' )"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:                $SUMMARY_WEBROOT"

# === [3] –ù–ê–ß–ê–õ–ù–ê –°–¢–†–ê–ù–ò–¶–ê ==========================================

echo ""
echo "–ù–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ –≤–∞—à–∏—è —Ö–æ—Å—Ç —â–µ –ø–æ–∫–∞–∑–≤–∞ —Å–ª–µ–¥–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ:"
echo ""
echo "www.${SUMMARY_DOMAIN}"
echo "This site is under construction."
echo "–í–∏–µ –º–æ–∂–µ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω —Ç–µ–∫—Å—Ç –∫—ä–º —Ç–æ–∑–∏."
echo ""

read -rp "üí¨ –í—ä–≤–µ–¥–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ (–¥–æ 160 —Å–∏–º–≤–æ–ª–∞). –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ Enter –∑–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–µ –∏–ª–∏ 'q' –∑–∞ –ø—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ: " custom_msg

if [[ "$custom_msg" == "q" ]]; then
  echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –ø–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
  exit 0
fi

# –û–±—Ä—è–∑–≤–∞–Ω–µ –¥–æ 160 —Å–∏–º–≤–æ–ª–∞
custom_msg="${custom_msg:0:160}"

SUMMARY_CUSTOM_MESSAGE="$custom_msg"

if [[ -n "$custom_msg" ]]; then
  echo "‚úÖ –°—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ —â–µ –±—ä–¥–µ –¥–æ–±–∞–≤–µ–Ω–æ –∫—ä–º –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞."
else
  echo "‚ÑπÔ∏è –ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ ‚Äì index.html —â–µ —Å—ä–¥—ä—Ä–∂–∞ —Å–∞–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω —Ç–µ–∫—Å—Ç."
fi

# === [4] –ò–ó–ë–û–† –ù–ê PHP –í–ï–†–°–ò–Ø ===============================================

echo ""
echo "üßÆ –û—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –Ω–∞–ª–∏—á–Ω–∏—Ç–µ PHP –≤–µ—Ä—Å–∏–∏..."

# –°–ø–∏—Å—ä–∫ —Å –≤—Å–∏—á–∫–∏ –ø–æ–¥–¥—ä—Ä–∂–∞–Ω–∏ –≤–µ—Ä—Å–∏–∏ –æ—Ç ondrej/php
ALL_PHP_VERSIONS=(8.3 8.2 8.1 8.0 7.4 7.3 7.2 7.1 7.0 5.6)
php_versions_array=()
menu_index=1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—è –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –∏ –∫–æ—è –Ω–µ
for ver in "${ALL_PHP_VERSIONS[@]}"; do
  if [[ -d "/etc/php/$ver" ]]; then
    php_versions_array+=("$ver|installed")
  else
    php_versions_array+=("$ver|missing")
  fi
done

# –ú–µ–Ω—é
echo ""
echo "‚û§ –ò–∑–±–µ—Ä–µ—Ç–µ PHP –≤–µ—Ä—Å–∏—è –∑–∞ —Ç–æ–∑–∏ –≤–∏—Ä—Ç—É–∞–ª–µ–Ω —Ö–æ—Å—Ç:"
for entry in "${php_versions_array[@]}"; do
  version="${entry%%|*}"
  status="${entry##*|}"

  if [[ $menu_index -eq 1 ]]; then
    label="(–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ ‚Äì –ø–æ—Å–ª–µ–¥–Ω–∞ —Å—Ç–∞–±–∏–ª–Ω–∞)"
  else
    label=""
  fi

  if [[ "$status" == "installed" ]]; then
    echo "[$menu_index] PHP $version $label"
  else
    echo "[$menu_index] PHP $version ‚ö†Ô∏è (—â–µ –±—ä–¥–µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞) $label"
  fi
  ((menu_index++))
done
echo "[q] –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ"

# –ò–∑–±–æ—Ä
while true; do
  read -rp "–í–∞—à–∏—è—Ç –∏–∑–±–æ—Ä [1]: " php_choice

  if [[ "$php_choice" == "q" ]]; then
    echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –ø–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    exit 0
  fi

  if [[ -z "$php_choice" ]]; then
    php_choice=1
  fi

  if ! [[ "$php_choice" =~ ^[0-9]+$ ]] || (( php_choice < 1 || php_choice > ${#php_versions_array[@]} )); then
    echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
    continue
  fi

  selected_entry="${php_versions_array[$((php_choice - 1))]}"
  selected_version="${selected_entry%%|*}"
  selected_status="${selected_entry##*|}"

  SUMMARY_PHP_VERSION="$selected_version"
  echo "‚úÖ –ò–∑–±—Ä–∞–Ω–∞ PHP –≤–µ—Ä—Å–∏—è: PHP $selected_version"

  if [[ "$selected_status" == "missing" ]]; then
    SUMMARY_PHP_INSTALL_REQUIRED="yes"
  else
    SUMMARY_PHP_INSTALL_REQUIRED="no"
  fi
  break
done

# === [5] –ò–ó–ë–û–† –ù–ê –°–ï–†–¢–ò–§–ò–ö–ê–¢ ==============================================

echo ""
echo "üîê –ò–∑–±–æ—Ä –Ω–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:"
echo "  [1] Let's Encrypt (–ø—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–¥–∞–≤–∞–Ω–µ)"
echo "  [2] –°–æ–±—Å—Ç–≤–µ–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–≤—ä–≤–µ–∂–¥–∞—Ç–µ .crt –∏ .key —Ñ–∞–π–ª–æ–≤–µ)"
echo "  [q] –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ"

while true; do
  read -rp "–í–∞—à–∏—è—Ç –∏–∑–±–æ—Ä [1]: " ssl_choice

  [[ "$ssl_choice" == "q" ]] && { echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –ø–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."; exit 0; }
  [[ -z "$ssl_choice" ]] && ssl_choice=1

  case "$ssl_choice" in
    1)
      SUMMARY_SSL_TYPE="letsencrypt"
      echo "‚úÖ –ò–∑–±—Ä–∞–Ω–æ: Let's Encrypt (—â–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ certbot)"
      break
      ;;
    2)
      while true; do
        read -rp "üìÑ –í—ä–≤–µ–¥–µ—Ç–µ –ø—ä–ª–Ω–∏—è –ø—ä—Ç –¥–æ .crt —Ñ–∞–π–ª–∞: " crt_path
        [[ "$crt_path" == "q" ]] && exit 0
        if [[ ! -f "$crt_path" ]]; then
          echo "‚ùå –§–∞–π–ª—ä—Ç $crt_path –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
          echo "üõ†Ô∏è –ò–∑–±–µ—Ä–µ—Ç–µ:"
          echo "  [1] –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ"
          echo "  [2] –°–º—è–Ω–∞ –∫—ä–º Let's Encrypt"
          echo "  [q] –ò–∑—Ö–æ–¥"
          read -rp "–í–∞—à–∏—è—Ç –∏–∑–±–æ—Ä: " retry_choice
          case "$retry_choice" in
            1) continue ;;
            2)
              SUMMARY_SSL_TYPE="letsencrypt"
              echo "üîÅ –ü—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –∫—ä–º Let's Encrypt."
              break 2
              ;;
            q|Q) echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ."; exit 0 ;;
            *) echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä."; continue ;;
          esac
        else
          break
        fi
      done

      while true; do
        read -rp "üìÑ –í—ä–≤–µ–¥–µ—Ç–µ –ø—ä–ª–Ω–∏—è –ø—ä—Ç –¥–æ .key —Ñ–∞–π–ª–∞: " key_path
        [[ "$key_path" == "q" ]] && exit 0
        if [[ ! -f "$key_path" ]]; then
          echo "‚ùå –§–∞–π–ª—ä—Ç $key_path –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞."
          echo "üõ†Ô∏è –ò–∑–±–µ—Ä–µ—Ç–µ:"
          echo "  [1] –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ"
          echo "  [2] –°–º—è–Ω–∞ –∫—ä–º Let's Encrypt"
          echo "  [q] –ò–∑—Ö–æ–¥"
          read -rp "–í–∞—à–∏—è—Ç –∏–∑–±–æ—Ä: " retry_choice
          case "$retry_choice" in
            1) continue ;;
            2)
              SUMMARY_SSL_TYPE="letsencrypt"
              echo "üîÅ –ü—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –∫—ä–º Let's Encrypt."
              break 2
              ;;
            q|Q) echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ."; exit 0 ;;
            *) echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä."; continue ;;
          esac
        else
          break
        fi
      done

      SUMMARY_SSL_TYPE="custom"
      SUMMARY_SSL_CRT_PATH="$crt_path"
      SUMMARY_SSL_KEY_PATH="$key_path"
      echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ä—Ç —â–µ –±—ä–¥–µ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –æ—Ç –∑–∞–¥–∞–¥–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ."
      break
      ;;
    *)
      echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –ò–∑–±–µ—Ä–µ—Ç–µ 1, 2 –∏–ª–∏ q."
      ;;
  esac
done

# === [6] –õ–ò–ú–ò–¢–ò –ù–ê –•–û–°–¢–ê (–≤–∫–ª. –¥–∏—Å–∫–æ–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ) ======================

domain_clean="${SUMMARY_ROOT_DOMAIN//./_}"
NOMINAL_USER="nom_${domain_clean}"
NOMINAL_GROUP="grp_${domain_clean}"
SUMMARY_NOMINAL_USER="$NOMINAL_USER"
SUMMARY_NOMINAL_GROUP="$NOMINAL_GROUP"

echo ""
echo "üíΩ –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—Ç–µ –Ω–æ–º–∏–Ω–∞–ª–µ–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–∏–∫ –∏ –¥–∞ –Ω–∞–ª–æ–∂–∏—Ç–µ –ª–∏–º–∏—Ç –Ω–∞ –¥–∏—Å–∫–æ–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ?"
echo "–¢–æ–≤–∞ —â–µ —Å—ä–∑–¥–∞–¥–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª $NOMINAL_USER –∏ –≥—Ä—É–ø–∞ $NOMINAL_GROUP"
echo ""
echo "  [1] –î–∞, —Å –ª–∏–º–∏—Ç (–ø—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ)"
echo "  [2] –î–∞, –±–µ–∑ –ª–∏–º–∏—Ç"
echo "  [3] –ù–µ ‚Äì –Ω–µ —Å—ä–∑–¥–∞–≤–∞–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –∏ –≥—Ä—É–ø–∞"
echo "  [q] –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ"

while true; do
  read -rp "–í–∞—à–∏—è—Ç –∏–∑–±–æ—Ä [1]: " limit_choice

  [[ "$limit_choice" == "q" ]] && {
    echo "üö™ –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –ø–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
    exit 0
  }

  [[ -z "$limit_choice" ]] && limit_choice=1

  case "$limit_choice" in
    1)
      SUMMARY_ENABLE_NOMINAL_USER="yes"
      echo ""
      echo "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ –ª–∏–º–∏—Ç –Ω–∞ –¥–∏—Å–∫–æ–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ (–≤ MB, –Ω–∞–ø—Ä. 500): "
      read -rp "MB: " disk_limit_mb
      if ! [[ "$disk_limit_mb" =~ ^[0-9]+$ ]]; then
        echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –ª–∏–º–∏—Ç. –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ."
        exit 1
      fi
      SUMMARY_DISK_LIMIT_MB="$disk_limit_mb"
      break
      ;;
    2)
      SUMMARY_ENABLE_NOMINAL_USER="yes"
      SUMMARY_DISK_LIMIT_MB="unlimited"
      break
      ;;
    3)
      SUMMARY_ENABLE_NOMINAL_USER="no"
      SUMMARY_DISK_LIMIT_MB="n/a"
      break
      ;;
    *)
      echo "‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä. –ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ 1, 2, 3 –∏–ª–∏ q."
      ;;
  esac
done

echo ""
echo "‚úÖ –ù–æ–º–∏–Ω–∞–ª–µ–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–∏–∫:     $SUMMARY_NOMINAL_USER"
echo "‚úÖ –ì—Ä—É–ø–∞ –∑–∞ –¥–æ—Å—Ç—ä–ø:          $SUMMARY_NOMINAL_GROUP"
echo "üì¶ –î–∏—Å–∫–æ–≤ –ª–∏–º–∏—Ç:             $SUMMARY_DISK_LIMIT_MB"
