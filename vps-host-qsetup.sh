#!/bin/bash

# ========================================================================== 
#  vps-host-qsetup - –ù–∞–¥—Å—Ç—Ä–æ–π–∫–∞ –∑–∞ —Ö–æ—Å—Ç–∏–Ω–≥ —Å—ä—Ä–≤—ä—Ä (bind9, apache, mariadb)
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.0
#  –î–∞—Ç–∞: 2025-06-30
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –¢–æ–∑–∏ —Å–∫—Ä–∏–ø—Ç –∏–∑–≤—ä—Ä—à–≤–∞ –Ω–∞–¥–≥—Ä–∞–∂–¥–∞—â–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ –≤–µ—á–µ –ø–æ–¥–≥–æ—Ç–≤–µ–Ω VPS
#  —Å—ä—Ä–≤—ä—Ä. –¢–æ–π –¥–æ–±–∞–≤—è —É—Å–ª—É–≥–∏ –∑–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –¥–æ–º–µ–π–Ω–∏.
#
#  –ï—Ç–∞–ø–∏:
#    1. –°—ä–±–∏—Ä–∞–Ω–µ –Ω–∞ —Ü—è–ª–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
#    2. –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
#    3. –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —É—Å–ª—É–≥–∏—Ç–µ
#    4. –§–∏–Ω–∞–ª–µ–Ω –æ—Ç—á–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
# ==========================================================================

# === –ü–û–ú–û–©–ù–ê –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================================================
show_help() {
  echo "–ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: vps-host-qsetup.sh [–æ–ø—Ü–∏—è]"
  echo ""
  echo "–ù–∞–¥–≥—Ä–∞–∂–¥–∞—â–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞ —Ö–æ—Å—Ç–∏–Ω–≥ —Å—ä—Ä–≤—ä—Ä (Apache, bind9, MariaDB)."
  echo ""
  echo "–û–ø—Ü–∏–∏:"
  echo "  --version       –ü–æ–∫–∞–∑–≤–∞ –≤–µ—Ä—Å–∏—è—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç–∞"
  echo "  --help          –ü–æ–∫–∞–∑–≤–∞ —Ç–∞–∑–∏ –ø–æ–º–æ—â"
}

# === –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê –û–ü–¶–ò–ò ====================================================
if [[ $# -gt 0 ]]; then
  case "$1" in
    --version)
      echo "vps-host-qsetup –≤–µ—Ä—Å–∏—è 1.0 (30 —é–Ω–∏ 2025 –≥.)"
      exit 0
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ—Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–∞ –æ–ø—Ü–∏—è: $1"
      show_help
      exit 1
      ;;
  esac
fi

# === –ü–û–ö–ê–ó–í–ê–ù–ï –ù–ê –ó–ê–ì–õ–ê–í–ò–ï–¢–û ===============================================
echo ""
echo ""
echo -e "\e[32m=========================================="
echo -e "  –ù–ê–î–°–¢–†–û–ô–ö–ê –ó–ê –•–û–°–¢–ò–ù–ì –°–™–†–í–™–† (VPS)"
echo -e "==========================================\e[0m"
echo ""

# === –ì–õ–û–ë–ê–õ–ù–ò –ü–†–û–ú–ï–ù–õ–ò–í–ò ===================================================
SERVER_IP=""
ACTUAL_IP=$(curl -s ifconfig.me)
SERVER_DOMAIN=""
ACTUAL_DOMAIN=$(hostname -f)
DNS_REQUIRED=""
DNS_MODE="master"
DNS_ZONE=""
SLAVE_MASTER_IP=""
CONFIRM=""

# [... –ø—Ä–µ–¥–∏—à–µ–Ω –∫–æ–¥ –±–µ–∑ –ø—Ä–æ–º—è–Ω–∞ ...]

        while true; do
          read -rp "‚û§ –í—ä–≤–µ–¥–µ—Ç–µ IP –∞–¥—Ä–µ—Å–∞ –Ω–∞ master DNS —Å—ä—Ä–≤—ä—Ä–∞ (–∏–ª–∏ 'q' –∑–∞ –∏–∑—Ö–æ–¥): " SLAVE_MASTER_IP
          [[ "$SLAVE_MASTER_IP" == "q" ]] && exit 0
          if [[ $SLAVE_MASTER_IP == "$SERVER_IP" ]]; then
            echo "‚ùå IP –∞–¥—Ä–µ—Å—ä—Ç –Ω–∞ master —Å—ä—Ä–≤—ä—Ä–∞ –Ω–µ –º–æ–∂–µ –¥–∞ —Å—ä–≤–ø–∞–¥–∞ —Å —Ç–µ–∫—É—â–∏—è —Å—ä—Ä–≤—ä—Ä."
            continue
          fi
          if [[ $SLAVE_MASTER_IP =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
            echo "‚ÑπÔ∏è –©–µ —Å–µ –æ–ø–∏—Ç–∞–º–µ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–æ—Å—Ç—ä–ø–∞ –¥–æ master —Å—ä—Ä–≤—ä—Ä–∞..."
            if timeout 3 bash -c "> /dev/tcp/$SLAVE_MASTER_IP/53" 2>/dev/null; then
              echo "‚úÖ –£—Å–ø–µ—à–Ω–∞ –≤—Ä—ä–∑–∫–∞ –∫—ä–º –ø–æ—Ä—Ç 53 –Ω–∞ master DNS —Å—ä—Ä–≤—ä—Ä–∞."
              break
            else
              echo "‚ùå –ù—è–º–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –ø–æ—Ä—Ç 53 –Ω–∞ $SLAVE_MASTER_IP. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ firewall –∏–ª–∏ IP."
            fi
          else
            echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω IP –∞–¥—Ä–µ—Å. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ."
          fi
        done

# –§–∏–Ω–∞–ª–Ω–æ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
INSTALLED_SERVICES="Apache2, MariaDB, PHP, Postfix, Dovecot, Roundcube"
echo ""
echo "üîé –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –≤—ä–≤–µ–¥–µ–Ω–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "   ‚Ä¢ –î–æ–º–µ–π–Ω (FQDN):  $SERVER_DOMAIN"
echo "   ‚Ä¢ IP –∞–¥—Ä–µ—Å:       $SERVER_IP"
if [[ "$DNS_REQUIRED" == "yes" ]]; then
  echo "   ‚Ä¢ DNS —Å—ä—Ä–≤—ä—Ä:     –≤–∫–ª—é—á–µ–Ω ($DNS_MODE)"
  echo "   ‚Ä¢ DNS –∑–æ–Ω–∞:       $DNS_ZONE"
  [[ "$DNS_MODE" == "slave" ]] && echo "   ‚Ä¢ Master IP:       $SLAVE_MASTER_IP"
else
  echo "   ‚Ä¢ DNS —Å—ä—Ä–≤—ä—Ä:     –Ω—è–º–∞ –¥–∞ –±—ä–¥–µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω"
fi
echo "   ‚Ä¢ –£—Å–ª—É–≥–∏ –∑–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ: $INSTALLED_SERVICES"

while true; do
  read -rp "‚ùì –ü–æ—Ç–≤—ä—Ä–∂–¥–∞–≤–∞—Ç–µ –ª–∏ —Ç–∞–∑–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è? (y/N/q): " CONFIRM
  case "$CONFIRM" in
    y|Y)
      break
      ;;
    n|N|"")
      echo "‚ùå –ü—Ä–µ–∫—Ä–∞—Ç–µ–Ω–æ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."
      exit 1
      ;;
    q|Q)
      exit 0
      ;;
    *)
      echo "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä. –ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ y, n –∏–ª–∏ q."
      ;;
  esac
done
